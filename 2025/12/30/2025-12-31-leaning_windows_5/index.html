<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="windows反调试PEB标志位检测123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293kd&amp;">
<meta property="og:type" content="article">
<meta property="og:title" content="windows 学习（五）-- 反调试和反沙箱">
<meta property="og:url" content="https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/index.html">
<meta property="og:site_name" content="wooo~ Exploooosion&#39;s blog">
<meta property="og:description" content="windows反调试PEB标志位检测123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293kd&amp;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://exploo0osion.github.io/image/2025-12-31-leaning_windows_5/1767261238093.png">
<meta property="article:published_time" content="2025-12-29T16:00:00.000Z">
<meta property="article:modified_time" content="2026-01-07T08:05:31.897Z">
<meta property="article:author" content="Exploooosion">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://exploo0osion.github.io/image/2025-12-31-leaning_windows_5/1767261238093.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>windows 学习（五）-- 反调试和反沙箱</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 8.1.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/friends/">friends</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2025/12/30/2025-12-30-learning_windows_4/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2025/12/12/2025-12-12-windows_dll_injection/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/&text=windows 学习（五）-- 反调试和反沙箱"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/&title=windows 学习（五）-- 反调试和反沙箱"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/&is_video=false&description=windows 学习（五）-- 反调试和反沙箱"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=windows 学习（五）-- 反调试和反沙箱&body=Check out this article: https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/&title=windows 学习（五）-- 反调试和反沙箱"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/&title=windows 学习（五）-- 反调试和反沙箱"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/&title=windows 学习（五）-- 反调试和反沙箱"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/&title=windows 学习（五）-- 反调试和反沙箱"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/&name=windows 学习（五）-- 反调试和反沙箱&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/&t=windows 学习（五）-- 反调试和反沙箱"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#windows"><span class="toc-number">1.</span> <span class="toc-text">windows</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E8%B0%83%E8%AF%95"><span class="toc-number">1.1.</span> <span class="toc-text">反调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PEB%E6%A0%87%E5%BF%97%E4%BD%8D%E6%A3%80%E6%B5%8B"><span class="toc-number">1.1.1.</span> <span class="toc-text">PEB标志位检测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BeingDebugged"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">BeingDebugged</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NtGlobalFlag"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">NtGlobalFlag</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Heap-Flags-ForceFlags"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">Heap Flags &amp; ForceFlags</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CrossProcessFlags"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">CrossProcessFlags</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E8%BF%9B%E7%A8%8B%E4%BF%A1%E6%81%AF%E6%A3%80%E6%B5%8B"><span class="toc-number">1.1.2.</span> <span class="toc-text">内核中的进程信息检测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CheckRemoteDebuggerPresent"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">CheckRemoteDebuggerPresent</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NtQueryInformationProcess"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">NtQueryInformationProcess</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ProcessDebugPort-0x07"><span class="toc-number">1.1.2.2.1.</span> <span class="toc-text">ProcessDebugPort (0x07)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ProcessDebugObjectHandle-0x1E"><span class="toc-number">1.1.2.2.2.</span> <span class="toc-text">ProcessDebugObjectHandle (0x1E)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ProcessDebugFlags-0x1F"><span class="toc-number">1.1.2.2.3.</span> <span class="toc-text">ProcessDebugFlags (0x1F)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NtQuerySystemInformation"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">NtQuerySystemInformation</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E6%A0%B8KUSER-SHARED-DATA-%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.1.2.3.1.</span> <span class="toc-text">内核KUSER_SHARED_DATA 结构体</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NtQueryObject"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">NtQueryObject</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ObjectAllTypesInformation"><span class="toc-number">1.1.2.4.1.</span> <span class="toc-text">ObjectAllTypesInformation</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ObjectTypeInformation"><span class="toc-number">1.1.2.4.2.</span> <span class="toc-text">ObjectTypeInformation</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E6%A3%80%E6%B5%8B"><span class="toc-number">1.1.3.</span> <span class="toc-text">线程上下文检测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#NtQueryInformationThread%E6%88%96%E8%80%85GetThreadContext"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">NtQueryInformationThread或者GetThreadContext</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NtSetInformationThread"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">NtSetInformationThread</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7"><span class="toc-number">1.1.4.</span> <span class="toc-text">异常捕获</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CloseHandle%E7%AD%89"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">CloseHandle等</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E5%B7%AE%E6%A3%80%E6%B5%8B"><span class="toc-number">1.1.5.</span> <span class="toc-text">时间差检测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rdtsc"><span class="toc-number">1.1.5.1.</span> <span class="toc-text">rdtsc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NtSetSystemInformation-Time-Slip"><span class="toc-number">1.1.5.2.</span> <span class="toc-text">NtSetSystemInformation (Time Slip)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E4%B8%8E%E5%90%AF%E5%8A%A8%E7%89%B9%E5%BE%81-Environment-Boot"><span class="toc-number">1.1.6.</span> <span class="toc-text">环境与启动特征 (Environment &amp; Boot)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E9%80%89%E9%A1%B9-SystemStartOptions"><span class="toc-number">1.1.6.1.</span> <span class="toc-text">系统启动选项 (SystemStartOptions)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AA%97%E5%8F%A3%E4%B8%8E%E8%BF%9B%E7%A8%8B%E6%89%AB%E6%8F%8F"><span class="toc-number">1.1.6.2.</span> <span class="toc-text">窗口与进程扫描</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8-%E8%AE%BE%E5%A4%87%E5%AF%B9%E8%B1%A1%E6%89%AB%E6%8F%8F"><span class="toc-number">1.1.6.3.</span> <span class="toc-text">驱动&#x2F;设备对象扫描</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E6%B2%99%E7%AE%B1"><span class="toc-number">1.2.</span> <span class="toc-text">反沙箱</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        windows 学习（五）-- 反调试和反沙箱
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Exploooosion</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-12-29T16:00:00.000Z" class="dt-published" itemprop="datePublished">2025-12-30</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/windows/">windows</a>
    </div>


      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <span id="more"></span>

<h1 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h1><h2 id="反调试"><a href="#反调试" class="headerlink" title="反调试"></a>反调试</h2><h3 id="PEB标志位检测"><a href="#PEB标志位检测" class="headerlink" title="PEB标志位检测"></a>PEB标志位检测</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _PEB</span><br><span class="line">ntdll!_PEB</span><br><span class="line">   +0x000 InheritedAddressSpace : UChar</span><br><span class="line">   +0x001 ReadImageFileExecOptions : UChar</span><br><span class="line">   +0x002 BeingDebugged    : UChar</span><br><span class="line">   +0x003 BitField         : UChar</span><br><span class="line">   +0x003 ImageUsesLargePages : Pos 0, 1 Bit</span><br><span class="line">   +0x003 IsProtectedProcess : Pos 1, 1 Bit</span><br><span class="line">   +0x003 IsLegacyProcess  : Pos 2, 1 Bit</span><br><span class="line">   +0x003 IsImageDynamicallyRelocated : Pos 3, 1 Bit</span><br><span class="line">   +0x003 SkipPatchingUser32Forwarders : Pos 4, 1 Bit</span><br><span class="line">   +0x003 SpareBits        : Pos 5, 3 Bits</span><br><span class="line">   +0x004 Mutant           : Ptr32 Void</span><br><span class="line">   +0x008 ImageBaseAddress : Ptr32 Void</span><br><span class="line">   +0x00c Ldr              : Ptr32 _PEB_LDR_DATA</span><br><span class="line">   +0x010 ProcessParameters : Ptr32 _RTL_USER_PROCESS_PARAMETERS</span><br><span class="line">   +0x014 SubSystemData    : Ptr32 Void</span><br><span class="line">   +0x018 ProcessHeap      : Ptr32 Void</span><br><span class="line">   +0x01c FastPebLock      : Ptr32 _RTL_CRITICAL_SECTION</span><br><span class="line">   +0x020 AtlThunkSListPtr : Ptr32 Void</span><br><span class="line">   +0x024 IFEOKey          : Ptr32 Void</span><br><span class="line">   +0x028 CrossProcessFlags : Uint4B</span><br><span class="line">   +0x028 ProcessInJob     : Pos 0, 1 Bit</span><br><span class="line">   +0x028 ProcessInitializing : Pos 1, 1 Bit</span><br><span class="line">   +0x028 ProcessUsingVEH  : Pos 2, 1 Bit</span><br><span class="line">   +0x028 ProcessUsingVCH  : Pos 3, 1 Bit</span><br><span class="line">   +0x028 ProcessUsingFTH  : Pos 4, 1 Bit</span><br><span class="line">   +0x028 ReservedBits0    : Pos 5, 27 Bits</span><br><span class="line">   +0x02c KernelCallbackTable : Ptr32 Void</span><br><span class="line">   +0x02c UserSharedInfoPtr : Ptr32 Void</span><br><span class="line">   +0x030 SystemReserved   : [1] Uint4B</span><br><span class="line">   +0x034 AtlThunkSListPtr32 : Uint4B</span><br><span class="line">   +0x038 ApiSetMap        : Ptr32 Void</span><br><span class="line">   +0x03c TlsExpansionCounter : Uint4B</span><br><span class="line">   +0x040 TlsBitmap        : Ptr32 Void</span><br><span class="line">   +0x044 TlsBitmapBits    : [2] Uint4B</span><br><span class="line">   +0x04c ReadOnlySharedMemoryBase : Ptr32 Void</span><br><span class="line">   +0x050 HotpatchInformation : Ptr32 Void</span><br><span class="line">   +0x054 ReadOnlyStaticServerData : Ptr32 Ptr32 Void</span><br><span class="line">   +0x058 AnsiCodePageData : Ptr32 Void</span><br><span class="line">   +0x05c OemCodePageData  : Ptr32 Void</span><br><span class="line">   +0x060 UnicodeCaseTableData : Ptr32 Void</span><br><span class="line">   +0x064 NumberOfProcessors : Uint4B</span><br><span class="line">   +0x068 NtGlobalFlag     : Uint4B</span><br><span class="line">   +0x070 CriticalSectionTimeout : _LARGE_INTEGER</span><br><span class="line">   +0x078 HeapSegmentReserve : Uint4B</span><br><span class="line">   +0x07c HeapSegmentCommit : Uint4B</span><br><span class="line">   +0x080 HeapDeCommitTotalFreeThreshold : Uint4B</span><br><span class="line">   +0x084 HeapDeCommitFreeBlockThreshold : Uint4B</span><br><span class="line">   +0x088 NumberOfHeaps    : Uint4B</span><br><span class="line">   +0x08c MaximumNumberOfHeaps : Uint4B</span><br><span class="line">   +0x090 ProcessHeaps     : Ptr32 Ptr32 Void</span><br><span class="line">   +0x094 GdiSharedHandleTable : Ptr32 Void</span><br><span class="line">   +0x098 ProcessStarterHelper : Ptr32 Void</span><br><span class="line">   +0x09c GdiDCAttributeList : Uint4B</span><br><span class="line">   +0x0a0 LoaderLock       : Ptr32 _RTL_CRITICAL_SECTION</span><br><span class="line">   +0x0a4 OSMajorVersion   : Uint4B</span><br><span class="line">   +0x0a8 OSMinorVersion   : Uint4B</span><br><span class="line">   +0x0ac OSBuildNumber    : Uint2B</span><br><span class="line">   +0x0ae OSCSDVersion     : Uint2B</span><br><span class="line">   +0x0b0 OSPlatformId     : Uint4B</span><br><span class="line">   +0x0b4 ImageSubsystem   : Uint4B</span><br><span class="line">   +0x0b8 ImageSubsystemMajorVersion : Uint4B</span><br><span class="line">   +0x0bc ImageSubsystemMinorVersion : Uint4B</span><br><span class="line">   +0x0c0 ActiveProcessAffinityMask : Uint4B</span><br><span class="line">   +0x0c4 GdiHandleBuffer  : [34] Uint4B</span><br><span class="line">   +0x14c PostProcessInitRoutine : Ptr32     void </span><br><span class="line">   +0x150 TlsExpansionBitmap : Ptr32 Void</span><br><span class="line">   +0x154 TlsExpansionBitmapBits : [32] Uint4B</span><br><span class="line">   +0x1d4 SessionId        : Uint4B</span><br><span class="line">   +0x1d8 AppCompatFlags   : _ULARGE_INTEGER</span><br><span class="line">   +0x1e0 AppCompatFlagsUser : _ULARGE_INTEGER</span><br><span class="line">   +0x1e8 pShimData        : Ptr32 Void</span><br><span class="line">   +0x1ec AppCompatInfo    : Ptr32 Void</span><br><span class="line">   +0x1f0 CSDVersion       : _UNICODE_STRING</span><br><span class="line">   +0x1f8 ActivationContextData : Ptr32 _ACTIVATION_CONTEXT_DATA</span><br><span class="line">   +0x1fc ProcessAssemblyStorageMap : Ptr32 _ASSEMBLY_STORAGE_MAP</span><br><span class="line">   +0x200 SystemDefaultActivationContextData : Ptr32 _ACTIVATION_CONTEXT_DATA</span><br><span class="line">   +0x204 SystemAssemblyStorageMap : Ptr32 _ASSEMBLY_STORAGE_MAP</span><br><span class="line">   +0x208 MinimumStackCommit : Uint4B</span><br><span class="line">   +0x20c FlsCallback      : Ptr32 _FLS_CALLBACK_INFO</span><br><span class="line">   +0x210 FlsListHead      : _LIST_ENTRY</span><br><span class="line">   +0x218 FlsBitmap        : Ptr32 Void</span><br><span class="line">   +0x21c FlsBitmapBits    : [4] Uint4B</span><br><span class="line">   +0x22c FlsHighIndex     : Uint4B</span><br><span class="line">   +0x230 WerRegistrationData : Ptr32 Void</span><br><span class="line">   +0x234 WerShipAssertPtr : Ptr32 Void</span><br><span class="line">   +0x238 pContextData     : Ptr32 Void</span><br><span class="line">   +0x23c pImageHeaderHash : Ptr32 Void</span><br><span class="line">   +0x240 TracingFlags     : Uint4B</span><br><span class="line">   +0x240 HeapTracingEnabled : Pos 0, 1 Bit</span><br><span class="line">   +0x240 CritSecTracingEnabled : Pos 1, 1 Bit</span><br><span class="line">   +0x240 SpareTracingBits : Pos 2, 30 Bits</span><br></pre></td></tr></table></figure>

<h4 id="BeingDebugged"><a href="#BeingDebugged" class="headerlink" title="BeingDebugged"></a>BeingDebugged</h4><p>可以使用IsDebuggerPresent()也可以直接检查peb-&gt;BeingDebugged</p>
<h4 id="NtGlobalFlag"><a href="#NtGlobalFlag" class="headerlink" title="NtGlobalFlag"></a>NtGlobalFlag</h4><p>peb-&gt;NtGlobalFlag（x86为 <code>+0x068</code>, x64为 <code>+0x0BC</code>）</p>
<p>在启动时，NtGlobalFlag全局系统变量将使用系统注册表项中的值进行初始化：<code>[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\GlobalFlag]</code></p>
<p>FLG_HEAP_ENABLE_TAIL_CHECK(0x10)<br>FLG_HEAP_ENABLE_FREE_CHECK(0x20)<br>FLG_HEAP_VALIDATE_PARAMETERS(0x40)</p>
<p>当进程由调试器启动时，Windows 内存管理器会默认启用一些特殊的堆（Heap）调试选项，以便帮助开发者发现内存泄漏或越界。这些选项包括“堆尾检查”、“堆释放检查”等，通常被调试时，该值为 0x70，即 <code>FLG_HEAP_ENABLE_TAIL_CHECK | FLG_HEAP_ENABLE_FREE_CHECK | FLG_HEAP_VALIDATE_PARAMETERS</code>。</p>
<h4 id="Heap-Flags-ForceFlags"><a href="#Heap-Flags-ForceFlags" class="headerlink" title="Heap Flags &amp; ForceFlags"></a>Heap Flags &amp; ForceFlags</h4><p>通过 PEB 找到 <code>ProcessHeap</code> 指针，进而访问堆结构 。</p>
<ul>
<li>ProcessHeap-&gt;Flags：在正常进程中，堆应该包含 <code>HEAP_GROWABLE</code> (0x00000002) 标志。如果被调试，这个标志可能会丢失或被修改 。</li>
<li>ProcessHeap-&gt;ForceFlags：用于强制某些堆行为。正常情况下通常为 0，但如果被调试，它会包含非零值（依赖于操作系统版本，如 XP 下是特定值）。</li>
</ul>
<p>堆尾部填充 (Heap Tail)检查</p>
<ul>
<li>字段&#x2F;特征: 检查堆块分配后的尾部填充字节。</li>
<li>检测逻辑 : 调试堆通常会使用特定的填充模式：</li>
<li><code>0xABABABAB</code>: 表示启用了 <code>HEAP_TAIL_CHECKING_ENABLED</code>。</li>
<li><code>0xFEEEFEEE</code>: 表示启用了 <code>HEAP_FREE_CHECKING_ENABLED</code>（释放后填充）</li>
</ul>
<h4 id="CrossProcessFlags"><a href="#CrossProcessFlags" class="headerlink" title="CrossProcessFlags"></a>CrossProcessFlags</h4><p>第四位为ProcessUsingVEH，可用来检测是否使用了VEH</p>
<p><img src="/image/2025-12-31-leaning_windows_5/1767261238093.png" alt="1767261238093"></p>
<h3 id="内核中的进程信息检测"><a href="#内核中的进程信息检测" class="headerlink" title="内核中的进程信息检测"></a>内核中的进程信息检测</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line">2: kd&gt; dt _EPROCESS</span><br><span class="line">ntdll!_EPROCESS</span><br><span class="line">  +0x000 Pcb              : _KPROCESS		// 子结构体</span><br><span class="line">  +0x0b0 ProcessLock      : _EX_PUSH_LOCK</span><br><span class="line">  +0x0b4 UniqueProcessId  : Ptr32 Void		// 进程的编号（任务管理器中的PID）</span><br><span class="line">  +0x0b8 ActiveProcessLinks : _LIST_ENTRY			// 双向链表，所有的活动进程都链接在一起，构成了一个链表</span><br><span class="line">  +0x0c0 RundownProtect   : _EX_RUNDOWN_REF</span><br><span class="line">  +0x0c4 VdmObjects       : Ptr32 Void</span><br><span class="line">  +0x0c8 Flags2           : Uint4B</span><br><span class="line">  +0x0c8 JobNotReallyActive : Pos 0, 1 Bit</span><br><span class="line">  +0x0c8 AccountingFolded : Pos 1, 1 Bit</span><br><span class="line">  +0x0c8 NewProcessReported : Pos 2, 1 Bit</span><br><span class="line">  +0x0c8 ExitProcessReported : Pos 3, 1 Bit</span><br><span class="line">  +0x0c8 ReportCommitChanges : Pos 4, 1 Bit</span><br><span class="line">  +0x0c8 LastReportMemory : Pos 5, 1 Bit</span><br><span class="line">  +0x0c8 ForceWakeCharge  : Pos 6, 1 Bit</span><br><span class="line">  +0x0c8 CrossSessionCreate : Pos 7, 1 Bit</span><br><span class="line">  +0x0c8 NeedsHandleRundown : Pos 8, 1 Bit</span><br><span class="line">  +0x0c8 RefTraceEnabled  : Pos 9, 1 Bit</span><br><span class="line">  +0x0c8 PicoCreated      : Pos 10, 1 Bit</span><br><span class="line">  +0x0c8 EmptyJobEvaluated : Pos 11, 1 Bit</span><br><span class="line">  +0x0c8 DefaultPagePriority : Pos 12, 3 Bits</span><br><span class="line">  +0x0c8 PrimaryTokenFrozen : Pos 15, 1 Bit</span><br><span class="line">  +0x0c8 ProcessVerifierTarget : Pos 16, 1 Bit</span><br><span class="line">  +0x0c8 RestrictSetThreadContext : Pos 17, 1 Bit</span><br><span class="line">  +0x0c8 AffinityPermanent : Pos 18, 1 Bit</span><br><span class="line">  +0x0c8 AffinityUpdateEnable : Pos 19, 1 Bit</span><br><span class="line">  +0x0c8 PropagateNode    : Pos 20, 1 Bit</span><br><span class="line">  +0x0c8 ExplicitAffinity : Pos 21, 1 Bit</span><br><span class="line">  +0x0c8 ProcessExecutionState : Pos 22, 2 Bits</span><br><span class="line">  +0x0c8 EnableReadVmLogging : Pos 24, 1 Bit</span><br><span class="line">  +0x0c8 EnableWriteVmLogging : Pos 25, 1 Bit</span><br><span class="line">  +0x0c8 FatalAccessTerminationRequested : Pos 26, 1 Bit</span><br><span class="line">  +0x0c8 DisableSystemAllowedCpuSet : Pos 27, 1 Bit</span><br><span class="line">  +0x0c8 ProcessStateChangeRequest : Pos 28, 2 Bits</span><br><span class="line">  +0x0c8 ProcessStateChangeInProgress : Pos 30, 1 Bit</span><br><span class="line">  +0x0c8 InPrivate        : Pos 31, 1 Bit</span><br><span class="line">  +0x0cc Flags            : Uint4B</span><br><span class="line">  +0x0cc CreateReported   : Pos 0, 1 Bit</span><br><span class="line">  +0x0cc NoDebugInherit   : Pos 1, 1 Bit</span><br><span class="line">  +0x0cc ProcessExiting   : Pos 2, 1 Bit</span><br><span class="line">  +0x0cc ProcessDelete    : Pos 3, 1 Bit</span><br><span class="line">  +0x0cc ManageExecutableMemoryWrites : Pos 4, 1 Bit</span><br><span class="line">  +0x0cc VmDeleted        : Pos 5, 1 Bit</span><br><span class="line">  +0x0cc OutswapEnabled   : Pos 6, 1 Bit</span><br><span class="line">  +0x0cc Outswapped       : Pos 7, 1 Bit</span><br><span class="line">  +0x0cc FailFastOnCommitFail : Pos 8, 1 Bit</span><br><span class="line">  +0x0cc Wow64VaSpace4Gb  : Pos 9, 1 Bit</span><br><span class="line">  +0x0cc AddressSpaceInitialized : Pos 10, 2 Bits</span><br><span class="line">  +0x0cc SetTimerResolution : Pos 12, 1 Bit</span><br><span class="line">  +0x0cc BreakOnTermination : Pos 13, 1 Bit</span><br><span class="line">  +0x0cc DeprioritizeViews : Pos 14, 1 Bit</span><br><span class="line">  +0x0cc WriteWatch       : Pos 15, 1 Bit</span><br><span class="line">  +0x0cc ProcessInSession : Pos 16, 1 Bit</span><br><span class="line">  +0x0cc OverrideAddressSpace : Pos 17, 1 Bit</span><br><span class="line">  +0x0cc HasAddressSpace  : Pos 18, 1 Bit</span><br><span class="line">  +0x0cc LaunchPrefetched : Pos 19, 1 Bit</span><br><span class="line">  +0x0cc Background       : Pos 20, 1 Bit</span><br><span class="line">  +0x0cc VmTopDown        : Pos 21, 1 Bit</span><br><span class="line">  +0x0cc ImageNotifyDone  : Pos 22, 1 Bit</span><br><span class="line">  +0x0cc PdeUpdateNeeded  : Pos 23, 1 Bit</span><br><span class="line">  +0x0cc VdmAllowed       : Pos 24, 1 Bit</span><br><span class="line">  +0x0cc ProcessRundown   : Pos 25, 1 Bit</span><br><span class="line">  +0x0cc ProcessInserted  : Pos 26, 1 Bit</span><br><span class="line">  +0x0cc DefaultIoPriority : Pos 27, 3 Bits</span><br><span class="line">  +0x0cc ProcessSelfDelete : Pos 30, 1 Bit</span><br><span class="line">  +0x0cc SetTimerResolutionLink : Pos 31, 1 Bit</span><br><span class="line">  +0x0d0 CreateTime       : _LARGE_INTEGER		// 进程的创建时间</span><br><span class="line">  +0x0d8 ProcessQuotaUsage : [2] Uint4B				// 物理页相关的统计信息</span><br><span class="line">  +0x0e0 ProcessQuotaPeak : [2] Uint4B					// 物理页相关的统计信息</span><br><span class="line">  +0x0e8 PeakVirtualSize  : Uint4B							// 虚拟内存的相关统计信息</span><br><span class="line">  +0x0ec VirtualSize      : Uint4B								// 虚拟内存的相关统计信息</span><br><span class="line">  +0x0f0 SessionProcessLinks : _LIST_ENTRY</span><br><span class="line">  +0x0f8 ExceptionPortData : Ptr32 Void					// 调试相关</span><br><span class="line">  +0x0f8 ExceptionPortValue : Uint4B</span><br><span class="line">  +0x0f8 ExceptionPortState : Pos 0, 3 Bits</span><br><span class="line">  +0x0fc Token            : _EX_FAST_REF</span><br><span class="line">  +0x100 MmReserved       : Uint4B</span><br><span class="line">  +0x104 AddressCreationLock : _EX_PUSH_LOCK</span><br><span class="line">  +0x108 PageTableCommitmentLock : _EX_PUSH_LOCK</span><br><span class="line">  +0x10c RotateInProgress : Ptr32 _ETHREAD</span><br><span class="line">  +0x110 ForkInProgress   : Ptr32 _ETHREAD</span><br><span class="line">  +0x114 CommitChargeJob  : Ptr32 _EJOB</span><br><span class="line">  +0x118 CloneRoot        : _RTL_AVL_TREE</span><br><span class="line">  +0x11c NumberOfPrivatePages : Uint4B</span><br><span class="line">  +0x120 NumberOfLockedPages : Uint4B</span><br><span class="line">  +0x124 Win32Process     : Ptr32 Void</span><br><span class="line">  +0x128 Job              : Ptr32 _EJOB</span><br><span class="line">  +0x12c SectionObject    : Ptr32 Void</span><br><span class="line">  +0x130 SectionBaseAddress : Ptr32 Void</span><br><span class="line">  +0x134 Cookie           : Uint4B</span><br><span class="line">  +0x138 WorkingSetWatch  : Ptr32 _PAGEFAULT_HISTORY</span><br><span class="line">  +0x13c Win32WindowStation : Ptr32 Void</span><br><span class="line">  +0x140 InheritedFromUniqueProcessId : Ptr32 Void</span><br><span class="line">  +0x144 LdtInformation   : Ptr32 Void</span><br><span class="line">  +0x148 OwnerProcessId   : Uint4B</span><br><span class="line">  +0x14c Peb              : Ptr32 _PEB				// 进程环境块（进程在3环的一个结构体，里面包含了一些进程的相关信息）</span><br><span class="line">  +0x150 Session          : Ptr32 _MM_SESSION_SPACE</span><br><span class="line">  +0x154 Spare1           : Ptr32 Void</span><br><span class="line">  +0x158 QuotaBlock       : Ptr32 _EPROCESS_QUOTA_BLOCK</span><br><span class="line">  +0x15c ObjectTable      : Ptr32 _HANDLE_TABLE		// 句柄表</span><br><span class="line">  +0x160 DebugPort        : Ptr32 Void						// 调试相关</span><br><span class="line">  +0x164 PaeTop           : Ptr32 Void</span><br><span class="line">  +0x168 DeviceMap        : Ptr32 Void</span><br><span class="line">  +0x16c EtwDataSource    : Ptr32 Void</span><br><span class="line">  +0x170 PageDirectoryPte : Uint8B</span><br><span class="line">  +0x178 ImageFilePointer : Ptr32 _FILE_OBJECT</span><br><span class="line">  +0x17c ImageFileName    : [15] UChar			// 进程镜像文件名</span><br><span class="line">  +0x18b PriorityClass    : UChar</span><br><span class="line">  +0x18c SecurityPort     : Ptr32 Void</span><br><span class="line">  +0x190 SeAuditProcessCreationInfo : _SE_AUDIT_PROCESS_CREATION_INFO</span><br><span class="line">  +0x194 JobLinks         : _LIST_ENTRY</span><br><span class="line">  +0x19c HighestUserAddress : Ptr32 Void</span><br><span class="line">  +0x1a0 ThreadListHead   : _LIST_ENTRY</span><br><span class="line">  +0x1a8 ActiveThreads    : Uint4B				// 活动线程的数量</span><br><span class="line">  +0x1ac ImagePathHash    : Uint4B</span><br><span class="line">  +0x1b0 DefaultHardErrorProcessing : Uint4B</span><br><span class="line">  +0x1b4 LastThreadExitStatus : Int4B</span><br><span class="line">  +0x1b8 PrefetchTrace    : _EX_FAST_REF</span><br><span class="line">  +0x1bc LockedPagesList  : Ptr32 Void</span><br><span class="line">  +0x1c0 ReadOperationCount : _LARGE_INTEGER</span><br><span class="line">  +0x1c8 WriteOperationCount : _LARGE_INTEGER</span><br><span class="line">  +0x1d0 OtherOperationCount : _LARGE_INTEGER</span><br><span class="line">  +0x1d8 ReadTransferCount : _LARGE_INTEGER</span><br><span class="line">  +0x1e0 WriteTransferCount : _LARGE_INTEGER</span><br><span class="line">  +0x1e8 OtherTransferCount : _LARGE_INTEGER</span><br><span class="line">  +0x1f0 CommitChargeLimit : Uint4B</span><br><span class="line">  +0x1f4 CommitCharge     : Uint4B						// 虚拟内存的相关统计信息</span><br><span class="line">  +0x1f8 CommitChargePeak : Uint4B</span><br><span class="line">  +0x200 Vm               : _MMSUPPORT_FULL</span><br><span class="line">  +0x300 MmProcessLinks   : _LIST_ENTRY</span><br><span class="line">  +0x308 ModifiedPageCount : Uint4B</span><br><span class="line">  +0x30c ExitStatus       : Int4B</span><br><span class="line">  +0x310 VadRoot          : _RTL_AVL_TREE			// 标识哪些0-2地址没占用了</span><br><span class="line">  +0x314 VadHint          : Ptr32 Void</span><br><span class="line">  +0x318 VadCount         : Uint4B</span><br><span class="line">  +0x31c VadPhysicalPages : Uint4B</span><br><span class="line">  +0x320 VadPhysicalPagesLimit : Uint4B</span><br><span class="line">  +0x324 AlpcContext      : _ALPC_PROCESS_CONTEXT</span><br><span class="line">  +0x334 TimerResolutionLink : _LIST_ENTRY</span><br><span class="line">  +0x33c TimerResolutionStackRecord : Ptr32 _PO_DIAG_STACK_RECORD</span><br><span class="line">  +0x340 RequestedTimerResolution : Uint4B</span><br><span class="line">  +0x344 SmallestTimerResolution : Uint4B</span><br><span class="line">  +0x348 ExitTime         : _LARGE_INTEGER			// 进程的退出时间</span><br><span class="line">  +0x350 ActiveThreadsHighWatermark : Uint4B</span><br><span class="line">  +0x354 LargePrivateVadCount : Uint4B</span><br><span class="line">  +0x358 ThreadListLock   : _EX_PUSH_LOCK</span><br><span class="line">  +0x35c WnfContext       : Ptr32 Void</span><br><span class="line">  +0x360 ServerSilo       : Ptr32 _EJOB</span><br><span class="line">  +0x364 SignatureLevel   : UChar</span><br><span class="line">  +0x365 SectionSignatureLevel : UChar</span><br><span class="line">  +0x366 Protection       : _PS_PROTECTION</span><br><span class="line">  +0x367 HangCount        : Pos 0, 3 Bits</span><br><span class="line">  +0x367 GhostCount       : Pos 3, 3 Bits</span><br><span class="line">  +0x367 PrefilterException : Pos 6, 1 Bit</span><br><span class="line">  +0x368 Flags3           : Uint4B</span><br><span class="line">  +0x368 Minimal          : Pos 0, 1 Bit</span><br><span class="line">  +0x368 ReplacingPageRoot : Pos 1, 1 Bit</span><br><span class="line">  +0x368 Crashed          : Pos 2, 1 Bit</span><br><span class="line">  +0x368 JobVadsAreTracked : Pos 3, 1 Bit</span><br><span class="line">  +0x368 VadTrackingDisabled : Pos 4, 1 Bit</span><br><span class="line">  +0x368 AuxiliaryProcess : Pos 5, 1 Bit</span><br><span class="line">  +0x368 SubsystemProcess : Pos 6, 1 Bit</span><br><span class="line">  +0x368 IndirectCpuSets  : Pos 7, 1 Bit</span><br><span class="line">  +0x368 RelinquishedCommit : Pos 8, 1 Bit</span><br><span class="line">  +0x368 HighGraphicsPriority : Pos 9, 1 Bit</span><br><span class="line">  +0x368 CommitFailLogged : Pos 10, 1 Bit</span><br><span class="line">  +0x368 ReserveFailLogged : Pos 11, 1 Bit</span><br><span class="line">  +0x368 SystemProcess    : Pos 12, 1 Bit</span><br><span class="line">  +0x368 HideImageBaseAddresses : Pos 13, 1 Bit</span><br><span class="line">  +0x368 AddressPolicyFrozen : Pos 14, 1 Bit</span><br><span class="line">  +0x368 ProcessFirstResume : Pos 15, 1 Bit</span><br><span class="line">  +0x368 ForegroundExternal : Pos 16, 1 Bit</span><br><span class="line">  +0x368 ForegroundSystem : Pos 17, 1 Bit</span><br><span class="line">  +0x368 HighMemoryPriority : Pos 18, 1 Bit</span><br><span class="line">  +0x368 EnableProcessSuspendResumeLogging : Pos 19, 1 Bit</span><br><span class="line">  +0x368 EnableThreadSuspendResumeLogging : Pos 20, 1 Bit</span><br><span class="line">  +0x368 SecurityDomainChanged : Pos 21, 1 Bit</span><br><span class="line">  +0x368 SecurityFreezeComplete : Pos 22, 1 Bit</span><br><span class="line">  +0x368 VmProcessorHost  : Pos 23, 1 Bit</span><br><span class="line">  +0x36c DeviceAsid       : Int4B</span><br><span class="line">  +0x370 SvmData          : Ptr32 Void</span><br><span class="line">  +0x374 SvmProcessLock   : _EX_PUSH_LOCK</span><br><span class="line">  +0x378 SvmLock          : Uint4B</span><br><span class="line">  +0x37c SvmProcessDeviceListHead : _LIST_ENTRY</span><br><span class="line">  +0x388 LastFreezeInterruptTime : Uint8B</span><br><span class="line">  +0x390 DiskCounters     : Ptr32 _PROCESS_DISK_COUNTERS</span><br><span class="line">  +0x394 PicoContext      : Ptr32 Void</span><br><span class="line">  +0x398 HighPriorityFaultsAllowed : Uint4B</span><br><span class="line">  +0x39c InstrumentationCallback : Ptr32 Void</span><br><span class="line">  +0x3a0 EnergyContext    : Ptr32 _PO_PROCESS_ENERGY_CONTEXT</span><br><span class="line">  +0x3a4 VmContext        : Ptr32 Void</span><br><span class="line">  +0x3a8 SequenceNumber   : Uint8B</span><br><span class="line">  +0x3b0 CreateInterruptTime : Uint8B</span><br><span class="line">  +0x3b8 CreateUnbiasedInterruptTime : Uint8B</span><br><span class="line">  +0x3c0 TotalUnbiasedFrozenTime : Uint8B</span><br><span class="line">  +0x3c8 LastAppStateUpdateTime : Uint8B</span><br><span class="line">  +0x3d0 LastAppStateUptime : Pos 0, 61 Bits</span><br><span class="line">  +0x3d0 LastAppState     : Pos 61, 3 Bits</span><br><span class="line">  +0x3d8 SharedCommitCharge : Uint4B</span><br><span class="line">  +0x3dc SharedCommitLock : _EX_PUSH_LOCK</span><br><span class="line">  +0x3e0 SharedCommitLinks : _LIST_ENTRY</span><br><span class="line">  +0x3e8 AllowedCpuSets   : Uint4B</span><br><span class="line">  +0x3ec DefaultCpuSets   : Uint4B</span><br><span class="line">  +0x3e8 AllowedCpuSetsIndirect : Ptr32 Uint4B</span><br><span class="line">  +0x3ec DefaultCpuSetsIndirect : Ptr32 Uint4B</span><br><span class="line">  +0x3f0 DiskIoAttribution : Ptr32 Void</span><br><span class="line">  +0x3f4 DxgProcess       : Ptr32 Void</span><br><span class="line">  +0x3f8 Win32KFilterSet  : Uint4B</span><br><span class="line">  +0x400 ProcessTimerDelay : _PS_INTERLOCKED_TIMER_DELAY_VALUES</span><br><span class="line">  +0x408 KTimerSets       : Uint4B</span><br><span class="line">  +0x40c KTimer2Sets      : Uint4B</span><br><span class="line">  +0x410 ThreadTimerSets  : Uint4B</span><br><span class="line">  +0x414 VirtualTimerListLock : Uint4B</span><br><span class="line">  +0x418 VirtualTimerListHead : _LIST_ENTRY</span><br><span class="line">  +0x420 WakeChannel      : _WNF_STATE_NAME</span><br><span class="line">  +0x420 WakeInfo         : _PS_PROCESS_WAKE_INFORMATION</span><br><span class="line">  +0x450 MitigationFlags  : Uint4B</span><br><span class="line">  +0x450 MitigationFlagsValues : &lt;anonymous-tag&gt;</span><br><span class="line">  +0x454 MitigationFlags2 : Uint4B</span><br><span class="line">  +0x454 MitigationFlags2Values : &lt;anonymous-tag&gt;</span><br><span class="line">  +0x458 PartitionObject  : Ptr32 Void</span><br><span class="line">  +0x460 SecurityDomain   : Uint8B</span><br><span class="line">  +0x468 ParentSecurityDomain : Uint8B</span><br><span class="line">  +0x470 CoverageSamplerContext : Ptr32 Void</span><br><span class="line">  +0x474 MmHotPatchContext : Ptr32 Void</span><br><span class="line">  </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="CheckRemoteDebuggerPresent"><a href="#CheckRemoteDebuggerPresent" class="headerlink" title="CheckRemoteDebuggerPresent"></a>CheckRemoteDebuggerPresent</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BOOL CheckRemoteDebuggerPresent(</span><br><span class="line">  [in]      HANDLE hProcess,</span><br><span class="line">  [in, out] PBOOL  pbDebuggerPresent</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>底层为调用NtQueryInformationProcess(ProcessDebugPort)</p>
<h4 id="NtQueryInformationProcess"><a href="#NtQueryInformationProcess" class="headerlink" title="NtQueryInformationProcess"></a>NtQueryInformationProcess</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__kernel_entry NTSTATUS NtQueryInformationProcess(</span><br><span class="line">  [in]            HANDLE           ProcessHandle,</span><br><span class="line">  [in]            PROCESSINFOCLASS ProcessInformationClass,</span><br><span class="line">  [out]           PVOID            ProcessInformation,</span><br><span class="line">  [in]            ULONG            ProcessInformationLength,</span><br><span class="line">  [out, optional] PULONG           ReturnLength</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h5 id="ProcessDebugPort-0x07"><a href="#ProcessDebugPort-0x07" class="headerlink" title="ProcessDebugPort (0x07)"></a>ProcessDebugPort (0x07)</h5><p>EPROCESS-&gt;DebugPort:当调试器附加到进程时，系统会将调试器的端口对象地址填入被调试进程 <code>EPROCESS</code> 结构体的 <code>DebugPort</code> 字段中，如果返回的 <code>ProcessInformation</code>（即端口号）不为 0，程序就判定自己被调试了 。</p>
<h5 id="ProcessDebugObjectHandle-0x1E"><a href="#ProcessDebugObjectHandle-0x1E" class="headerlink" title="ProcessDebugObjectHandle (0x1E)"></a>ProcessDebugObjectHandle (0x1E)</h5><p>同样是检查 <code>EPROCESS-&gt;DebugPort</code>，调试器会为被调试的进程创建一个调试对象，该参数能获取调试对象的句柄,不为0则为调试。</p>
<h5 id="ProcessDebugFlags-0x1F"><a href="#ProcessDebugFlags-0x1F" class="headerlink" title="ProcessDebugFlags (0x1F)"></a>ProcessDebugFlags (0x1F)</h5><p>EPROCESS-&gt;FLAGS（NoDebugInherit比特位）<code>NoDebugInherit</code> 标志位用于指示子进程是否应该继承父进程的调试状态。</p>
<p>NtQueryInformationProcess函数的返回值为0，则正在调试进程。</p>
<h4 id="NtQuerySystemInformation"><a href="#NtQuerySystemInformation" class="headerlink" title="NtQuerySystemInformation"></a>NtQuerySystemInformation</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__kernel_entry NTSTATUS NtQuerySystemInformation(</span><br><span class="line">  [in]            SYSTEM_INFORMATION_CLASS SystemInformationClass,</span><br><span class="line">  [in, out]       PVOID                    SystemInformation,</span><br><span class="line">  [in]            ULONG                    SystemInformationLength,</span><br><span class="line">  [out, optional] PULONG                   ReturnLength</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>读取内核变量 <code>KdDebuggerEnabled</code> 和 <code>KdPitchDebugger</code>，调试状态下 <code>SYSTEM_KERNEL_DEBUGGER_INFORMATION.DebuggerEnabled</code>值和 <code>KernelDebuggerNotPresent</code>值为1。这些内核变量的值会被映射到用户层可读的共享页面 KUSER_SHARED_DATA中，因此也可以读取该结构体</p>
<h5 id="内核KUSER-SHARED-DATA-结构体"><a href="#内核KUSER-SHARED-DATA-结构体" class="headerlink" title="内核KUSER_SHARED_DATA 结构体"></a>内核KUSER_SHARED_DATA 结构体</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">dt _KUSER_SHARED_DATA     // win11前</span><br><span class="line">nt!_KUSER_SHARED_DATA</span><br><span class="line">   +0x000 TickCountLowDeprecated : Uint4B</span><br><span class="line">   +0x004 TickCountMultiplier : Uint4B</span><br><span class="line">   +0x008 InterruptTime    : _KSYSTEM_TIME</span><br><span class="line">   +0x014 SystemTime       : _KSYSTEM_TIME</span><br><span class="line">   +0x020 TimeZoneBias     : _KSYSTEM_TIME</span><br><span class="line">   +0x02c ImageNumberLow   : Uint2B</span><br><span class="line">   +0x02e ImageNumberHigh  : Uint2B</span><br><span class="line">   +0x030 NtSystemRoot     : [260] Wchar</span><br><span class="line">   +0x238 MaxStackTraceDepth : Uint4B</span><br><span class="line">   +0x23c CryptoExponent   : Uint4B</span><br><span class="line">   +0x240 TimeZoneId       : Uint4B</span><br><span class="line">   +0x244 LargePageMinimum : Uint4B</span><br><span class="line">   +0x248 AitSamplingValue : Uint4B</span><br><span class="line">   +0x24c AppCompatFlag    : Uint4B</span><br><span class="line">   +0x250 RNGSeedVersion   : Uint8B</span><br><span class="line">   +0x258 GlobalValidationRunlevel : Uint4B</span><br><span class="line">   +0x25c TimeZoneBiasStamp : Int4B</span><br><span class="line">   +0x260 NtBuildNumber    : Uint4B</span><br><span class="line">   +0x264 NtProductType    : _NT_PRODUCT_TYPE</span><br><span class="line">   +0x268 ProductTypeIsValid : UChar</span><br><span class="line">   +0x269 Reserved0        : [1] UChar</span><br><span class="line">   +0x26a NativeProcessorArchitecture : Uint2B</span><br><span class="line">   +0x26c NtMajorVersion   : Uint4B</span><br><span class="line">   +0x270 NtMinorVersion   : Uint4B</span><br><span class="line">   +0x274 ProcessorFeatures : [64] UChar</span><br><span class="line">   +0x2b4 Reserved1        : Uint4B</span><br><span class="line">   +0x2b8 Reserved3        : Uint4B</span><br><span class="line">   +0x2bc TimeSlip         : Uint4B</span><br><span class="line">   +0x2c0 AlternativeArchitecture : _ALTERNATIVE_ARCHITECTURE_TYPE</span><br><span class="line">   +0x2c4 BootId           : Uint4B</span><br><span class="line">   +0x2c8 SystemExpirationDate : _LARGE_INTEGER</span><br><span class="line">   +0x2d0 SuiteMask        : Uint4B</span><br><span class="line">   +0x2d4 KdDebuggerEnabled : UChar                            // &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;  划重点 </span><br><span class="line">   +0x2d5 MitigationPolicies : UChar</span><br><span class="line">   +0x2d5 NXSupportPolicy  : Pos 0, 2 Bits</span><br><span class="line">   +0x2d5 SEHValidationPolicy : Pos 2, 2 Bits</span><br><span class="line">   +0x2d5 CurDirDevicesSkippedForDlls : Pos 4, 2 Bits</span><br><span class="line">   +0x2d5 Reserved         : Pos 6, 2 Bits</span><br><span class="line">   +0x2d6 Reserved6        : [2] UChar</span><br><span class="line">   +0x2d8 ActiveConsoleId  : Uint4B</span><br><span class="line">   +0x2dc DismountCount    : Uint4B</span><br><span class="line">   +0x2e0 ComPlusPackage   : Uint4B</span><br><span class="line">   +0x2e4 LastSystemRITEventTickCount : Uint4B</span><br><span class="line">   +0x2e8 NumberOfPhysicalPages : Uint4B</span><br><span class="line">   +0x2ec SafeBootMode     : UChar</span><br><span class="line">   +0x2ed VirtualizationFlags : UChar</span><br><span class="line">   +0x2ee Reserved12       : [2] UChar</span><br><span class="line">   +0x2f0 SharedDataFlags  : Uint4B</span><br><span class="line">   +0x2f0 DbgErrorPortPresent : Pos 0, 1 Bit</span><br><span class="line">   +0x2f0 DbgElevationEnabled : Pos 1, 1 Bit</span><br><span class="line">   +0x2f0 DbgVirtEnabled   : Pos 2, 1 Bit</span><br><span class="line">   +0x2f0 DbgInstallerDetectEnabled : Pos 3, 1 Bit</span><br><span class="line">   +0x2f0 DbgLkgEnabled    : Pos 4, 1 Bit</span><br><span class="line">   +0x2f0 DbgDynProcessorEnabled : Pos 5, 1 Bit</span><br><span class="line">   +0x2f0 DbgConsoleBrokerEnabled : Pos 6, 1 Bit</span><br><span class="line">   +0x2f0 DbgSecureBootEnabled : Pos 7, 1 Bit</span><br><span class="line">   +0x2f0 DbgMultiSessionSku : Pos 8, 1 Bit</span><br><span class="line">   +0x2f0 DbgMultiUsersInSessionSku : Pos 9, 1 Bit</span><br><span class="line">   +0x2f0 DbgStateSeparationEnabled : Pos 10, 1 Bit</span><br><span class="line">   +0x2f0 SpareBits        : Pos 11, 21 Bits</span><br><span class="line">   +0x2f4 DataFlagsPad     : [1] Uint4B</span><br><span class="line">   +0x2f8 TestRetInstruction : Uint8B</span><br><span class="line">   +0x300 QpcFrequency     : Int8B</span><br><span class="line">   +0x308 SystemCall       : Uint4B</span><br><span class="line">   +0x30c SystemCallPad0   : Uint4B</span><br><span class="line">   +0x310 SystemCallPad    : [2] Uint8B</span><br><span class="line">   +0x320 TickCount        : _KSYSTEM_TIME</span><br><span class="line">   +0x320 TickCountQuad    : Uint8B</span><br><span class="line">   +0x320 ReservedTickCountOverlay : [3] Uint4B</span><br><span class="line">   +0x32c TickCountPad     : [1] Uint4B</span><br><span class="line">   +0x330 Cookie           : Uint4B</span><br><span class="line">   +0x334 CookiePad        : [1] Uint4B</span><br><span class="line">   +0x338 ConsoleSessionForegroundProcessId : Int8B</span><br><span class="line">   +0x340 TimeUpdateLock   : Uint8B</span><br><span class="line">   +0x348 BaselineSystemTimeQpc : Uint8B</span><br><span class="line">   +0x350 BaselineInterruptTimeQpc : Uint8B</span><br><span class="line">   +0x358 QpcSystemTimeIncrement : Uint8B</span><br><span class="line">   +0x360 QpcInterruptTimeIncrement : Uint8B</span><br><span class="line">   +0x368 QpcSystemTimeIncrementShift : UChar</span><br><span class="line">   +0x369 QpcInterruptTimeIncrementShift : UChar</span><br><span class="line">   +0x36a UnparkedProcessorCount : Uint2B</span><br><span class="line">   +0x36c EnclaveFeatureMask : [4] Uint4B</span><br><span class="line">   +0x37c TelemetryCoverageRound : Uint4B</span><br><span class="line">   +0x380 UserModeGlobalLogger : [16] Uint2B</span><br><span class="line">   +0x3a0 ImageFileExecutionOptions : Uint4B</span><br><span class="line">   +0x3a4 LangGenerationCount : Uint4B</span><br><span class="line">   +0x3a8 Reserved4        : Uint8B</span><br><span class="line">   +0x3b0 InterruptTimeBias : Uint8B</span><br><span class="line">   +0x3b8 QpcBias          : Uint8B</span><br><span class="line">   +0x3c0 ActiveProcessorCount : Uint4B</span><br><span class="line">   +0x3c4 ActiveGroupCount : UChar</span><br><span class="line">   +0x3c5 Reserved9        : UChar</span><br><span class="line">   +0x3c6 QpcData          : Uint2B</span><br><span class="line">   +0x3c6 QpcBypassEnabled : UChar</span><br><span class="line">   +0x3c7 QpcShift         : UChar</span><br><span class="line">   +0x3c8 TimeZoneBiasEffectiveStart : _LARGE_INTEGER</span><br><span class="line">   +0x3d0 TimeZoneBiasEffectiveEnd : _LARGE_INTEGER</span><br><span class="line">   +0x3d8 XState           : _XSTATE_CONFIGURATION</span><br></pre></td></tr></table></figure>

<p>KUSER_SHARED_DATA-&gt;KdDebuggerEnabled</p>
<p>检查第 0 位（0x1）：如果为 1，表示内核调试器已启用；检查第1位(0x2)：如果为 0，表示调试器存在。</p>
<h4 id="NtQueryObject"><a href="#NtQueryObject" class="headerlink" title="NtQueryObject"></a>NtQueryObject</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__kernel_entry NTSYSCALLAPI NTSTATUS NtQueryObject(</span><br><span class="line">  [in, optional]  HANDLE                   Handle,</span><br><span class="line">  [in]            OBJECT_INFORMATION_CLASS ObjectInformationClass,</span><br><span class="line">  [out, optional] PVOID                    ObjectInformation,</span><br><span class="line">  [in]            ULONG                    ObjectInformationLength,</span><br><span class="line">  [out, optional] PULONG                   ReturnLength</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h5 id="ObjectAllTypesInformation"><a href="#ObjectAllTypesInformation" class="headerlink" title="ObjectAllTypesInformation"></a>ObjectAllTypesInformation</h5><p>Windows 内核中每种对象（如文件、互斥体、调试对象）都有一个 <code>OBJECT_TYPE</code> 结构来描述。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">OBJECT_TYPE_INFORMATION</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    UNICODE_STRING TypeName;</span><br><span class="line">    ULONG TotalNumberOfObjects;</span><br><span class="line">    ULONG TotalNumberOfHandles;</span><br><span class="line">    ULONG TotalPagedPoolUsage;</span><br><span class="line">    ULONG TotalNonPagedPoolUsage;</span><br><span class="line">    ULONG TotalNamePoolUsage;</span><br><span class="line">    ULONG TotalHandleTableUsage;</span><br><span class="line">    ULONG HighWaterNumberOfObjects;</span><br><span class="line">    ULONG HighWaterNumberOfHandles;</span><br><span class="line">    ULONG HighWaterPagedPoolUsage;</span><br><span class="line">    ULONG HighWaterNonPagedPoolUsage;</span><br><span class="line">    ULONG HighWaterNamePoolUsage;</span><br><span class="line">    ULONG HighWaterHandleTableUsage;</span><br><span class="line">    ULONG InvalidAttributes;</span><br><span class="line">    GENERIC_MAPPING GenericMapping;</span><br><span class="line">    ULONG ValidAccessMask;</span><br><span class="line">    BOOLEAN SecurityRequired;</span><br><span class="line">    BOOLEAN MaintainHandleCount;</span><br><span class="line">    UCHAR TypeIndex; <span class="comment">// since WINBLUE</span></span><br><span class="line">    CHAR ReservedByte;</span><br><span class="line">    ULONG PoolType;</span><br><span class="line">    ULONG DefaultPagedPoolCharge;</span><br><span class="line">    ULONG DefaultNonPagedPoolCharge;</span><br><span class="line">&#125; OBJECT_TYPE_INFORMATION, *POBJECT_TYPE_INFORMATION;</span><br></pre></td></tr></table></figure>

<ul>
<li>API 逻辑 : 遍历所有对象类型，找到名称为 “DebugObject” 的类型结构。</li>
<li>判断依据 : 读取该类型结构下的 <code>TotalNumberOfObjects</code> 字段。</li>
<li>核心逻辑 : 只要有调试器在工作，它就必须创建一个DebugObject类型的内核对象。如果检测到该对象的数量 &gt; 0（或者大于你程序自己创建的数量），就说明系统中存在调试器。</li>
</ul>
<h5 id="ObjectTypeInformation"><a href="#ObjectTypeInformation" class="headerlink" title="ObjectTypeInformation"></a>ObjectTypeInformation</h5><p>NtCreateDebugObject创建一个调试对象句柄，然后再查询该调试对象类型的对象总数，&gt;1则说明有调试</p>
<h3 id="线程上下文检测"><a href="#线程上下文检测" class="headerlink" title="线程上下文检测"></a>线程上下文检测</h3><h4 id="NtQueryInformationThread或者GetThreadContext"><a href="#NtQueryInformationThread或者GetThreadContext" class="headerlink" title="NtQueryInformationThread或者GetThreadContext"></a>NtQueryInformationThread或者GetThreadContext</h4><p>检查 ETHREAD -&gt;KTHREAD -&gt; TrapFrame的Dr0~Dr7寄存器来判断硬件断点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__kernel_entry NTSTATUS NtQueryInformationThread(</span><br><span class="line">  [in]            HANDLE          ThreadHandle,</span><br><span class="line">  [in]            THREADINFOCLASS ThreadInformationClass,</span><br><span class="line">  [in, out]       PVOID           ThreadInformation,</span><br><span class="line">  [in]            ULONG           ThreadInformationLength,</span><br><span class="line">  [out, optional] PULONG          ReturnLength</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h4 id="NtSetInformationThread"><a href="#NtSetInformationThread" class="headerlink" title="NtSetInformationThread"></a>NtSetInformationThread</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NTSYSAPI NTSTATUS ZwSetInformationThread(</span><br><span class="line">  [in] HANDLE          ThreadHandle,</span><br><span class="line">  [in] THREADINFOCLASS ThreadInformationClass,</span><br><span class="line">  [in] PVOID           ThreadInformation,</span><br><span class="line">  [in] ULONG           ThreadInformationLength</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>当调用 <code>NtSetInformationThread</code> 并传入 <code>ThreadHideFromDebugger</code> 时，内核将当前线程 <code>ETHREAD</code> 结构中的 <code>HideFromDebugger</code> (位于 <code>ETHREAD-&gt;ThreadFlags</code> 或 <code>CrossThreadFlags</code> 位域中)标志位置为 1。一旦置位，当该线程触发异常（如断点）时，内核会忽略调试器，直接将异常派发给进程自身处理。如果进程处理不了，程序就会崩溃（从而达到反调试目的）。</p>
<h3 id="异常捕获"><a href="#异常捕获" class="headerlink" title="异常捕获"></a>异常捕获</h3><p>利用“调试器会优先接管异常”的机制。如果程序自己制造一个异常，且成功捕获了它，说明没有调试器（或者调试器把异常透传了）；如果程序没捕获到或者行为异常，说明有调试器干扰。</p>
<h4 id="CloseHandle等"><a href="#CloseHandle等" class="headerlink" title="CloseHandle等"></a>CloseHandle等</h4><p>传入一个无效的句柄</p>
<ul>
<li><strong>有调试器</strong> : 会触发 <code>0xC0000008</code> (Invalid Handle) 异常，调试器通常会暂停。</li>
<li><strong>无调试器</strong> : 函数返回 <code>FALSE</code>，或者通过 <code>__except</code> 捕获异常继续运行。</li>
</ul>
<p>其他函数诸如NtGetContextThread、NtQueryInformationProcess、CloseWindow等</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __try &#123;</span><br><span class="line">        CloseHandle((HANDLE)<span class="number">672368</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    __except(EXCEPTION_EXECUTE_HANDLER)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;debugger&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    getchar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用 <code>SetHandleInformation</code>将互斥体句柄标记为“禁止关闭” (<code>HANDLE_FLAG_PROTECT_FROM_CLOSE</code>)，然后强行关闭它。</p>
<table>
<thead>
<tr>
<th>值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>HANDLE_FLAG_PROTECT_FROM_CLOSE（0x2）</td>
<td>如果设置了此标志，则调用<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/desktop/api/handleapi/nf-handleapi-closehandle">CloseHandle</a> 函数不会关闭对象句柄。</td>
</tr>
</tbody></table>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="type">bool</span> <span class="title function_">CheckCloseHandle2</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">auto</span> hMutex = CreateMutexA(<span class="literal">NULL</span>, FALSE, <span class="string">&quot;ntdil.dli&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (IS_VALID_HANDLE(hMutex))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (SetHandleInformation(hMutex, HANDLE_FLAG_PROTECT_FROM_CLOSE, HANDLE_FLAG_PROTECT_FROM_CLOSE))</span><br><span class="line">		&#123;</span><br><span class="line">			__try </span><br><span class="line">			&#123;</span><br><span class="line">				CloseHandle(hMutex);</span><br><span class="line">			&#125;</span><br><span class="line">			__except (HANDLE_FLAG_PROTECT_FROM_CLOSE)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="时间差检测"><a href="#时间差检测" class="headerlink" title="时间差检测"></a>时间差检测</h3><p>调试器的处理（中断、单步执行、异常处理）会消耗大量 CPU 周期。可以使用GetTickCount或者QueryPerformanceCounter、rdtsc指令</p>
<h4 id="rdtsc"><a href="#rdtsc" class="headerlink" title="rdtsc"></a>rdtsc</h4><p><code>rdtsc</code> 指令会将 CPU 上电以来的时钟周期数读取到寄存器（<code>EDX:EAX</code>）中。程序在执行一段指令前后分别调用两次 <code>rdtsc</code>，计算两次结果的差值</p>
<h4 id="NtSetSystemInformation-Time-Slip"><a href="#NtSetSystemInformation-Time-Slip" class="headerlink" title="NtSetSystemInformation (Time Slip)"></a>NtSetSystemInformation (Time Slip)</h4><p>创建一个事件对象，如果系统中存在内核调试器且处于中断状态，系统时钟会“滑移”（停止走动）。该函数可以检测这种滑移并触发事件。如果 <code>WaitForSingleObject</code> 等到了信号，说明发生了时钟滑移，即存在调试行为。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">CheckSystemTime</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">auto</span> bRet = <span class="literal">false</span>;</span><br><span class="line">	BOOLEAN bAdjustPrivRet;</span><br><span class="line">	<span class="keyword">auto</span> ntStatus =RtlAdjustPrivilege(SE_SYSTEMTIME_PRIVILEGE, TRUE, FALSE, &amp;bAdjustPrivRet);</span><br><span class="line">	<span class="keyword">if</span> (NT_SUCCESS(ntStatus))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">auto</span> hEvent = CreateEventA(<span class="literal">NULL</span>, FALSE, FALSE, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="keyword">if</span> (IS_VALID_HANDLE(hEvent))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (NT_SUCCESS(NtSetSystemInformation(SystemTimeSlipNotification, &amp;hEvent, <span class="keyword">sizeof</span>(hEvent))))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (WaitForSingleObject(hEvent, <span class="number">1</span>) == WAIT_OBJECT_0) <span class="comment">//如果为有信号,说明进程处于中断状态</span></span><br><span class="line">					bRet = <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			CloseHandle(hEvent);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="环境与启动特征-Environment-Boot"><a href="#环境与启动特征-Environment-Boot" class="headerlink" title="环境与启动特征 (Environment &amp; Boot)"></a>环境与启动特征 (Environment &amp; Boot)</h3><h4 id="系统启动选项-SystemStartOptions"><a href="#系统启动选项-SystemStartOptions" class="headerlink" title="系统启动选项 (SystemStartOptions)"></a>系统启动选项 (SystemStartOptions)</h4><p>读取注册表 <code>HKLM\System\CurrentControlSet\Control\SystemStartOptions</code>。</p>
<p>检查字符串中是否包含 “DEBUG”。这通常意味着系统是以调试模式（如 <code>/DEBUG</code> 开关）启动的。</p>
<h4 id="窗口与进程扫描"><a href="#窗口与进程扫描" class="headerlink" title="窗口与进程扫描"></a>窗口与进程扫描</h4><p>使用 <code>FindWindow</code> 查找类名或标题为 “OllyDbg”, “x64dbg” 的窗口。</p>
<p>扫描进程列表（<code>CreateToolhelp32Snapshot</code>）查找 <code>VMWareService.exe</code> 等虚拟机进程（虚拟机常用于逆向分析）</p>
<h4 id="驱动-设备对象扫描"><a href="#驱动-设备对象扫描" class="headerlink" title="驱动&#x2F;设备对象扫描"></a>驱动&#x2F;设备对象扫描</h4><p>尝试打开特定的驱动设备名，如 <code>\\.\Syser</code> (Syser Debugger), <code>\\.\SICE</code> (SoftICE), <code>\\.\NtICE</code> 等。如果能成功打开句柄，说明由于反调试驱动存在。</p>
<h2 id="反沙箱"><a href="#反沙箱" class="headerlink" title="反沙箱"></a>反沙箱</h2>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/categories/">Category</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/friends/">friends</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#windows"><span class="toc-number">1.</span> <span class="toc-text">windows</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E8%B0%83%E8%AF%95"><span class="toc-number">1.1.</span> <span class="toc-text">反调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PEB%E6%A0%87%E5%BF%97%E4%BD%8D%E6%A3%80%E6%B5%8B"><span class="toc-number">1.1.1.</span> <span class="toc-text">PEB标志位检测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BeingDebugged"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">BeingDebugged</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NtGlobalFlag"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">NtGlobalFlag</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Heap-Flags-ForceFlags"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">Heap Flags &amp; ForceFlags</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CrossProcessFlags"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">CrossProcessFlags</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E4%B8%AD%E7%9A%84%E8%BF%9B%E7%A8%8B%E4%BF%A1%E6%81%AF%E6%A3%80%E6%B5%8B"><span class="toc-number">1.1.2.</span> <span class="toc-text">内核中的进程信息检测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CheckRemoteDebuggerPresent"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">CheckRemoteDebuggerPresent</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NtQueryInformationProcess"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">NtQueryInformationProcess</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ProcessDebugPort-0x07"><span class="toc-number">1.1.2.2.1.</span> <span class="toc-text">ProcessDebugPort (0x07)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ProcessDebugObjectHandle-0x1E"><span class="toc-number">1.1.2.2.2.</span> <span class="toc-text">ProcessDebugObjectHandle (0x1E)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ProcessDebugFlags-0x1F"><span class="toc-number">1.1.2.2.3.</span> <span class="toc-text">ProcessDebugFlags (0x1F)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NtQuerySystemInformation"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">NtQuerySystemInformation</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E6%A0%B8KUSER-SHARED-DATA-%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.1.2.3.1.</span> <span class="toc-text">内核KUSER_SHARED_DATA 结构体</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NtQueryObject"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">NtQueryObject</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ObjectAllTypesInformation"><span class="toc-number">1.1.2.4.1.</span> <span class="toc-text">ObjectAllTypesInformation</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ObjectTypeInformation"><span class="toc-number">1.1.2.4.2.</span> <span class="toc-text">ObjectTypeInformation</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E6%A3%80%E6%B5%8B"><span class="toc-number">1.1.3.</span> <span class="toc-text">线程上下文检测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#NtQueryInformationThread%E6%88%96%E8%80%85GetThreadContext"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">NtQueryInformationThread或者GetThreadContext</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NtSetInformationThread"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">NtSetInformationThread</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%8D%95%E8%8E%B7"><span class="toc-number">1.1.4.</span> <span class="toc-text">异常捕获</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CloseHandle%E7%AD%89"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">CloseHandle等</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E5%B7%AE%E6%A3%80%E6%B5%8B"><span class="toc-number">1.1.5.</span> <span class="toc-text">时间差检测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rdtsc"><span class="toc-number">1.1.5.1.</span> <span class="toc-text">rdtsc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NtSetSystemInformation-Time-Slip"><span class="toc-number">1.1.5.2.</span> <span class="toc-text">NtSetSystemInformation (Time Slip)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E4%B8%8E%E5%90%AF%E5%8A%A8%E7%89%B9%E5%BE%81-Environment-Boot"><span class="toc-number">1.1.6.</span> <span class="toc-text">环境与启动特征 (Environment &amp; Boot)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E9%80%89%E9%A1%B9-SystemStartOptions"><span class="toc-number">1.1.6.1.</span> <span class="toc-text">系统启动选项 (SystemStartOptions)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AA%97%E5%8F%A3%E4%B8%8E%E8%BF%9B%E7%A8%8B%E6%89%AB%E6%8F%8F"><span class="toc-number">1.1.6.2.</span> <span class="toc-text">窗口与进程扫描</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8-%E8%AE%BE%E5%A4%87%E5%AF%B9%E8%B1%A1%E6%89%AB%E6%8F%8F"><span class="toc-number">1.1.6.3.</span> <span class="toc-text">驱动&#x2F;设备对象扫描</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E6%B2%99%E7%AE%B1"><span class="toc-number">1.2.</span> <span class="toc-text">反沙箱</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/&text=windows 学习（五）-- 反调试和反沙箱"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/&title=windows 学习（五）-- 反调试和反沙箱"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/&is_video=false&description=windows 学习（五）-- 反调试和反沙箱"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=windows 学习（五）-- 反调试和反沙箱&body=Check out this article: https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/&title=windows 学习（五）-- 反调试和反沙箱"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/&title=windows 学习（五）-- 反调试和反沙箱"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/&title=windows 学习（五）-- 反调试和反沙箱"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/&title=windows 学习（五）-- 反调试和反沙箱"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/&name=windows 学习（五）-- 反调试和反沙箱&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://exploo0osion.github.io/2025/12/30/2025-12-31-leaning_windows_5/&t=windows 学习（五）-- 反调试和反沙箱"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2025-2026
    Exploooosion
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Category</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/friends/">friends</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
